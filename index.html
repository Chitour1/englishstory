<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قصتي اللغوية - تعلم الإنجليزية بالذكاء الاصطناعي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .font-english {
            font-family: 'Inter', sans-serif;
        }
        .lesson-content b {
            background-color: #fef08a; padding: 2px 4px; border-radius: 4px;
            font-weight: 700; color: #713f12; cursor: pointer;
        }
        .lesson-content .word-span { cursor: pointer; }
        .lesson-content .word-span:hover { background-color: #e0f2fe; }
        .dialogue-line { margin-bottom: 0.5rem; }
        .dialogue-speaker-1 { color: #1d4ed8; font-weight: bold; }
        .dialogue-speaker-2 { color: #be185d; font-weight: bold; }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #selection-popup button {
            background: none; border: none; cursor: pointer; font-size: 14px; font-family: 'Cairo', sans-serif;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 8px;
            max-width: 90%; width: 450px; text-align: center;
        }
        .table-style { width: 100%; border-collapse: collapse; }
        .table-style th, .table-style td {
            border: 1px solid #e2e8f0; padding: 12px; text-align: right;
        }
        .table-style th { background-color: #f1f5f9; }
        .table-style td:first-child {
            font-weight: bold; font-family: 'Inter', sans-serif; direction: ltr;
        }
        /* Flashcard styles */
        .flashcard-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .flashcard {
            background-color: white; border: 1px solid #e2e8f0; border-radius: 8px;
            height: 100px; perspective: 1000px; cursor: pointer;
        }
        .flashcard-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s; transform-style: preserve-3d;
        }
        .flashcard.is-flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back {
            position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden;
            backface-visibility: hidden; display: flex; align-items: center; justify-content: center;
            padding: 1rem; font-size: 1.1rem;
        }
        .flashcard-back { transform: rotateY(180deg); background-color: #f0f9ff; }
        /* Matching exercise styles */
        .matching-container { display: flex; justify-content: space-around; gap: 1rem; }
        .matching-column { display: flex; flex-direction: column; gap: 0.5rem; flex: 1; }
        .match-item {
            padding: 0.75rem; border: 2px solid #cbd5e1; border-radius: 6px;
            cursor: pointer; transition: all 0.2s;
        }
        .match-item.selected { border-color: #3b82f6; background-color: #dbeafe; }
        .match-item.correct { border-color: #22c55e; background-color: #dcfce7; pointer-events: none; }
        .match-item.incorrect { border-color: #ef4444; background-color: #fee2e2; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-sky-600 mb-2">قصتي اللغوية</h1>
            <p class="text-lg text-slate-600">تعلم مفردات الإنجليزية من خلال قصص يصنعها الذكاء الاصطناعي</p>
        </header>

        <div id="api-key-section" class="mb-6 p-4 bg-white rounded-lg shadow-md">
            <div class="flex items-center gap-3 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500"><path d="M14 9a2 2 0 0 1-2 2H6l-4 4V4c0-1.1.9-2 2-2h8a2 2 0 0 1 2 2v5Z"/><path d="M18 9h2a2 2 0 0 1 2 2v10l-4-4H8a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h2"/><path d="M22 12h-2"/><path d="M18 12h-2"/></svg>
                <h2 class="text-xl font-bold">مفتاح Gemini API</h2>
            </div>
            <p class="text-slate-600 mb-3 text-sm">لاستخدام التطبيق، يرجى إدخال مفتاح Gemini API الخاص بك. يمكنك الحصول عليه من <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-sky-600 hover:underline">Google AI Studio</a>.</p>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="password" id="api-key-input" class="flex-grow p-2 border rounded-md font-english" placeholder="أدخل مفتاحك هنا...">
                <button id="save-api-key-btn" class="bg-sky-600 text-white px-6 py-2 rounded-md hover:bg-sky-700 transition">حفظ وبدء</button>
            </div>
        </div>

        <main id="main-content" class="hidden">
            
            <div class="mb-6 flex justify-center border-b flex-wrap">
                <button id="nav-home" class="px-4 py-3 text-lg font-bold border-b-4 border-sky-600 text-sky-600">الرئيسية</button>
                <button id="nav-history" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">سجل الدروس</button>
                <button id="nav-learned" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">الكلمات المتعلمة</button>
                <button id="nav-basket" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">سلة التعلم</button>
            </div>
            
            <div id="stats-section" class="mb-6 p-4 bg-white rounded-lg shadow-md flex flex-wrap justify-around text-center">
                <div><p class="text-slate-500">إجمالي الكلمات</p><p id="total-words" class="text-2xl font-bold text-sky-600 font-english">0</p></div>
                <div><p class="text-slate-500">كلمات تعلمتها</p><p id="learned-words" class="text-2xl font-bold text-green-600 font-english">0</p></div>
                <div><p class="text-slate-500">الكلمات المتبقية</p><p id="remaining-words" class="text-2xl font-bold text-amber-600 font-english">0</p></div>
            </div>

            <div id="home-screen" class="text-center p-8 bg-white rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4">هل أنت مستعد لدرس جديد؟</h2>
                <p class="text-slate-600 mb-6">اضغط على الزر أدناه ليقوم الذكاء الاصطناعي بإنشاء قصة جديدة لك من 15-20 كلمة لم تتعلمها بعد.</p>
                <button id="new-lesson-btn" class="bg-green-600 text-white px-8 py-3 rounded-lg text-lg font-bold hover:bg-green-700 transition transform hover:scale-105">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        أنشئ قصة جديدة
                    </span>
                </button>
                <button id="reset-progress-btn" class="mt-4 bg-red-500 text-white px-4 py-2 rounded-md text-sm hover:bg-red-600 transition">إعادة تعيين التقدم</button>
            </div>

            <div id="history-screen" class="hidden p-4 bg-white rounded-lg shadow-md space-y-3">
                <h2 class="text-2xl font-bold mb-4 text-center">الدروس السابقة</h2>
                <div id="history-list" class="space-y-2"></div>
            </div>

            <div id="learned-words-screen" class="hidden p-4 bg-white rounded-lg shadow-md"></div>
            
            <div id="basket-screen" class="hidden space-y-6"></div>

            <div id="loading-screen" class="hidden text-center p-8 bg-white rounded-lg shadow-md">
                <div class="flex justify-center mb-4"><div class="loader"></div></div>
                <p class="text-slate-600 text-lg">الذكاء الاصطناعي يكتب قصتك... يرجى الانتظار.</p>
            </div>

            <div id="lesson-screen" class="hidden space-y-6"></div>
        </main>

        <div id="selection-popup" class="hidden absolute bg-white border rounded-lg shadow-xl p-1 flex gap-1 z-50">
            <button id="popup-translate" title="ترجمة" class="p-2 hover:bg-slate-100 rounded-md">🇹🇷</button>
            <button id="popup-speak" title="نطق" class="p-2 hover:bg-slate-100 rounded-md">🔊</button>
            <button id="popup-phonetics" title="كتابة صوتية" class="p-2 hover:bg-slate-100 rounded-md">🗣️</button>
            <button id="popup-save" title="حفظ للسلة" class="p-2 hover:bg-slate-100 rounded-md">💾</button>
        </div>
    </div>

    <script>
        const a1Words = ['a', 'an', 'about', 'above', 'across', 'action', 'activity', 'actor', 'actress', 'add', 'address', 'adult', 'advice', 'afraid', 'after', 'afternoon', 'again', 'age', 'ago', 'agree', 'air', 'airport', 'all', 'also', 'always', 'amazing', 'and', 'angry', 'animal', 'another', 'answer', 'any', 'anyone', 'anything', 'apartment', 'apple', 'April', 'area', 'arm', 'around', 'arrive', 'art', 'article', 'artist', 'as', 'ask', 'at', 'August', 'aunt', 'autumn', 'away', 'baby', 'back', 'bad', 'bag', 'ball', 'banana', 'band', 'bank', 'bath', 'bathroom', 'be', 'beach', 'beautiful', 'because', 'become', 'bed', 'bedroom', 'beer', 'before', 'begin', 'beginning', 'behind', 'believe', 'below', 'best', 'better', 'between', 'bicycle', 'big', 'bike', 'bill', 'bird', 'birthday', 'black', 'blog', 'blonde', 'blue', 'boat', 'body', 'book', 'boot', 'bored', 'boring', 'born', 'both', 'bottle', 'box', 'boy', 'boyfriend', 'bread', 'break', 'breakfast', 'bring', 'brother', 'brown', 'build', 'building', 'bus', 'business', 'busy', 'but', 'butter', 'buy', 'by', 'bye', 'cafe', 'cake', 'call', 'camera', 'can', 'cannot', 'capital', 'car', 'card', 'career', 'carrot', 'carry', 'cat', 'CD', 'cent', 'centre', 'century', 'chair', 'change', 'chart', 'cheap', 'check', 'cheese', 'chicken', 'child', 'chocolate', 'choose', 'cinema', 'city', 'class', 'classroom', 'clean', 'climb', 'clock', 'close', 'clothes', 'club', 'coat', 'coffee', 'cold', 'college', 'colour', 'come', 'common', 'company', 'compare', 'complete', 'computer', 'concert', 'conversation', 'cook', 'cooking', 'cool', 'correct', 'cost', 'could', 'country', 'course', 'cousin', 'cow', 'cream', 'create', 'culture', 'cup', 'customer', 'cut', 'dad', 'dance', 'dancer', 'dancing', 'dangerous', 'dark', 'date', 'daughter', 'day', 'dear', 'December', 'decide', 'delicious', 'describe', 'description', 'design', 'desk', 'detail', 'dialogue', 'dictionary', 'die', 'diet', 'difference', 'different', 'difficult', 'dinner', 'dirty', 'discuss', 'dish', 'do', 'doctor', 'dog', 'dollar', 'door', 'down', 'downstairs', 'draw', 'dress', 'drink', 'drive', 'driver', 'during', 'DVD', 'each', 'ear', 'early', 'east', 'easy', 'eat', 'egg', 'eight', 'eighteen', 'eighty', 'elephant', 'eleven', 'else', 'email', 'end', 'enjoy', 'enough', 'euro', 'even', 'evening', 'event', 'ever', 'every', 'everybody', 'everyone', 'everything', 'exam', 'example', 'excited', 'exciting', 'exercise', 'expensive', 'explain', 'extra', 'eye', 'face', 'fact', 'fall', 'false', 'family', 'famous', 'fantastic', 'far', 'farm', 'farmer', 'fast', 'fat', 'father', 'favourite', 'February', 'feel', 'feeling', 'festival', 'few', 'fifteen', 'fifth', 'fifty', 'fill', 'film', 'final', 'find', 'fine', 'finish', 'fire', 'first', 'fish', 'five', 'flat', 'flight', 'floor', 'flower', 'fly', 'follow', 'food', 'foot', 'football', 'for', 'forget', 'form', 'forty', 'four', 'fourteen', 'fourth', 'free', 'Friday', 'friend', 'friendly', 'from', 'front', 'fruit', 'full', 'fun', 'funny', 'future', 'game', 'garden', 'geography', 'get', 'girl', 'girlfriend', 'give', 'glass', 'go', 'good', 'goodbye', 'grandfather', 'grandmother', 'grandparent', 'great', 'green', 'grey', 'group', 'grow', 'guess', 'guitar', 'gym', 'hair', 'half', 'hand', 'happen', 'happy', 'hard', 'hat', 'hate', 'have', 'have to', 'he', 'head', 'health', 'healthy', 'hear', 'hello', 'help', 'her', 'here', 'hey', 'hi', 'high', 'him', 'his', 'history', 'hobby', 'holiday', 'home', 'homework', 'hope', 'horse', 'hospital', 'hot', 'hotel', 'hour', 'house', 'how', 'however', 'hundred', 'hungry', 'husband', 'I', 'ice', 'ice cream', 'idea', 'if', 'imagine', 'important', 'improve', 'in', 'include', 'information', 'interest', 'interested', 'interesting', 'internet', 'interview', 'into', 'introduce', 'island', 'it', 'its', 'January', 'jeans', 'job', 'join', 'journey', 'juice', 'July', 'June', 'just', 'keep', 'key', 'kilometre', 'kind', 'kitchen', 'know', 'land', 'language', 'large', 'last', 'late', 'later', 'laugh', 'learn', 'leave', 'left', 'leg', 'lesson', 'let', 'letter', 'library', 'lie', 'life', 'light', 'like', 'line', 'lion', 'list', 'listen', 'little', 'live', 'local', 'long', 'look', 'lose', 'lot', 'love', 'lunch', 'machine', 'magazine', 'main', 'make', 'man', 'many', 'map', 'March', 'market', 'married', 'match', 'May', 'maybe', 'me', 'meal', 'mean', 'meaning', 'meat', 'meet', 'meeting', 'member', 'menu', 'message', 'metre', 'midnight', 'mile', 'milk', 'million', 'minute', 'miss', 'mistake', 'model', 'modern', 'moment', 'Monday', 'money', 'month', 'more', 'morning', 'most', 'mother', 'mountain', 'mouse', 'mouth', 'move', 'movie', 'much', 'mum', 'museum', 'music', 'must', 'my', 'name', 'natural', 'near', 'need', 'negative', 'neighbour', 'never', 'new', 'news', 'newspaper', 'next', 'next to', 'nice', 'night', 'nine', 'nineteen', 'ninety', 'no', 'no one', 'nobody', 'north', 'nose', 'not', 'note', 'nothing', 'November', 'now', 'number', 'nurse', 'object', "o'clock", 'October', 'of', 'off', 'office', 'often', 'oh', 'OK', 'old', 'on', 'once', 'one', 'onion', 'online', 'only', 'open', 'opinion', 'opposite', 'or', 'orange', 'order', 'other', 'our', 'out', 'outside', 'over', 'own', 'page', 'paint', 'painting', 'pair', 'paper', 'paragraph', 'parent', 'park', 'part', 'partner', 'party', 'passport', 'past', 'pay', 'pen', 'pencil', 'people', 'pepper', 'perfect', 'period', 'person', 'personal', 'phone', 'photo', 'photograph', 'phrase', 'piano', 'picture', 'piece', 'pig', 'pink', 'place', 'plan', 'plane', 'plant', 'play', 'player', 'please', 'point', 'police', 'policeman', 'pool', 'poor', 'popular', 'positive', 'possible', 'post', 'potato', 'pound', 'practice', 'practise', 'prefer', 'prepare', 'present', 'pretty', 'price', 'probably', 'problem', 'product', 'programme', 'project', 'purple', 'put', 'quarter', 'question', 'quick', 'quickly', 'quiet', 'quite', 'radio', 'rain', 'read', 'reader', 'reading', 'ready', 'real', 'really', 'reason', 'red', 'relax', 'remember', 'repeat', 'report', 'restaurant', 'result', 'return', 'rice', 'rich', 'ride', 'right', 'river', 'road', 'room', 'routine', 'rule', 'run', 'sad', 'salad', 'salt', 'same', 'sandwich', 'Saturday', 'say', 'school', 'science', 'scientist', 'sea', 'second', 'section', 'see', 'sell', 'send', 'sentence', 'September', 'seven', 'seventeen', 'seventy', 'share', 'she', 'sheep', 'shirt', 'shoe', 'shop', 'shopping', 'short', 'should', 'show', 'shower', 'sick', 'similar', 'sing', 'singer', 'sister', 'sit', 'situation', 'six', 'sixteen', 'sixty', 'skill', 'skirt', 'sleep', 'slow', 'small', 'snake', 'snow', 'so', 'some', 'somebody', 'someone', 'something', 'sometimes', 'son', 'song', 'soon', 'sorry', 'sound', 'soup', 'south', 'space', 'speak', 'special', 'spell', 'spelling', 'spend', 'sport', 'spring', 'stand', 'star', 'start', 'statement', 'station', 'stay', 'still', 'stop', 'story', 'street', 'strong', 'student', 'study', 'style', 'subject', 'success', 'sugar', 'summer', 'sun', 'Sunday', 'supermarket', 'sure', 'sweater', 'swim', 'swimming', 'table', 'take', 'talk', 'tall', 'taxi', 'tea', 'teach', 'teacher', 'team', 'teenager', 'telephone', 'television', 'tell', 'ten', 'tennis', 'terrible', 'test', 'text', 'than', 'thank', 'thanks', 'that', 'the', 'theatre', 'their', 'them', 'then', 'there', 'they', 'thing', 'think', 'third', 'thirsty', 'thirteen', 'thirty', 'this', 'thousand', 'three', 'through', 'Thursday', 'ticket', 'time', 'tired', 'title', 'to', 'today', 'together', 'toilet', 'tomato', 'tomorrow', 'tonight', 'too', 'tooth', 'topic', 'tourist', 'town', 'traffic', 'train', 'travel', 'tree', 'trip', 'trousers', 'true', 'try', 'T-shirt', 'Tuesday', 'turn', 'TV', 'twelve', 'twenty', 'twice', 'two', 'type', 'umbrella', 'uncle', 'under', 'understand', 'university', 'until', 'up', 'upstairs', 'us', 'use', 'useful', 'usually', 'vacation', 'vegetable', 'very', 'video', 'village', 'visit', 'visitor', 'wait', 'waiter', 'wake', 'walk', 'wall', 'want', 'warm', 'wash', 'watch', 'water', 'way', 'we', 'wear', 'weather', 'website', 'Wednesday', 'week', 'weekend', 'welcome', 'well', 'west', 'what', 'when', 'where', 'which', 'white', 'who', 'why', 'wife', 'will', 'win', 'window', 'wine', 'winter', 'with', 'without', 'woman', 'wonderful', 'word', 'work', 'worker', 'world', 'worry', 'would', 'write', 'writer', 'writing', 'wrong', 'year', 'yellow', 'yes', 'yesterday', 'you', 'young', 'your', 'yourself'];
        const ttsVoices = ['Zephyr', 'Puck', 'Charon', 'Kore', 'Fenrir', 'Leda', 'Orus', 'Aoede', 'Callirrhoe', 'Autonoe', 'Enceladus', 'Iapetus', 'Umbriel', 'Algieba', 'Despina', 'Erinome', 'Algenib', 'Rasalgethi', 'Laomedeia', 'Achernar', 'Alnilam', 'Schedar', 'Gacrux', 'Pulcherrima', 'Achird', 'Zubenelgenubi', 'Vindemiatrix', 'Sadachbia', 'Sadaltager', 'Sulafat'];

        const allDOMElements = {
            apiKeySection: document.getElementById('api-key-section'),
            apiKeyInput: document.getElementById('api-key-input'),
            saveApiKeyBtn: document.getElementById('save-api-key-btn'),
            mainContent: document.getElementById('main-content'),
            navHome: document.getElementById('nav-home'),
            navHistory: document.getElementById('nav-history'),
            navLearned: document.getElementById('nav-learned'),
            navBasket: document.getElementById('nav-basket'),
            homeScreen: document.getElementById('home-screen'),
            historyScreen: document.getElementById('history-screen'),
            learnedWordsScreen: document.getElementById('learned-words-screen'),
            basketScreen: document.getElementById('basket-screen'),
            historyList: document.getElementById('history-list'),
            statsSection: document.getElementById('stats-section'),
            totalWordsEl: document.getElementById('total-words'),
            learnedWordsEl: document.getElementById('learned-words'),
            remainingWordsEl: document.getElementById('remaining-words'),
            newLessonBtn: document.getElementById('new-lesson-btn'),
            resetProgressBtn: document.getElementById('reset-progress-btn'),
            loadingScreen: document.getElementById('loading-screen'),
            lessonScreen: document.getElementById('lesson-screen'),
            selectionPopup: document.getElementById('selection-popup'),
        };

        let apiKey = '';
        let learnedWords = [];
        let learningBasket = [];
        let lessonHistory = [];
        let remainingWords = [...a1Words];
        let audioContext;
        let isLessonActive = false;
        
        function initialize() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error("Web Audio API is not supported in this browser");
                showModal("متصفحك لا يدعم تشغيل الصوتيات، قد لا تعمل بعض الميزات.");
            }

            loadState();
            updateProgress();
            setupEventListeners();
        }

        function setupEventListeners() {
            allDOMElements.saveApiKeyBtn.addEventListener('click', handleSaveApiKey);
            allDOMElements.apiKeyInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSaveApiKey(); });
            allDOMElements.newLessonBtn.addEventListener('click', handleNewLesson);
            allDOMElements.resetProgressBtn.addEventListener('click', handleResetProgress);
            allDOMElements.navHome.addEventListener('click', () => showTab('home'));
            allDOMElements.navHistory.addEventListener('click', () => showTab('history'));
            allDOMElements.navLearned.addEventListener('click', () => showTab('learned'));
            allDOMElements.navBasket.addEventListener('click', () => showTab('basket'));

            document.body.addEventListener('mouseup', handleTextSelection);
            document.body.addEventListener('mousedown', (e) => {
                if (!allDOMElements.selectionPopup.contains(e.target)) {
                    allDOMElements.selectionPopup.classList.add('hidden');
                }
            });
            allDOMElements.lessonScreen.addEventListener('click', handleWordClick);
        }

        function loadState() {
            apiKey = localStorage.getItem('geminiApiKey') || '';
            learnedWords = JSON.parse(localStorage.getItem('learnedWords')) || [];
            learningBasket = JSON.parse(localStorage.getItem('learningBasket')) || [];
            lessonHistory = JSON.parse(localStorage.getItem('lessonHistory')) || [];

            if (apiKey) {
                allDOMElements.apiKeyInput.value = apiKey;
                allDOMElements.apiKeySection.classList.add('hidden');
                allDOMElements.mainContent.classList.remove('hidden');
            }
        }

        function saveState() {
            localStorage.setItem('learnedWords', JSON.stringify(learnedWords));
            localStorage.setItem('learningBasket', JSON.stringify(learningBasket));
            localStorage.setItem('lessonHistory', JSON.stringify(lessonHistory));
        }

        function updateProgress() {
            remainingWords = a1Words.filter(word => !learnedWords.includes(word));
            allDOMElements.totalWordsEl.textContent = a1Words.length;
            allDOMElements.learnedWordsEl.textContent = learnedWords.length;
            allDOMElements.remainingWordsEl.textContent = remainingWords.length;
        }

        function showScreen(screen) {
            allDOMElements.homeScreen.classList.add('hidden');
            allDOMElements.historyScreen.classList.add('hidden');
            allDOMElements.learnedWordsScreen.classList.add('hidden');
            allDOMElements.basketScreen.classList.add('hidden');
            allDOMElements.loadingScreen.classList.add('hidden');
            allDOMElements.lessonScreen.classList.add('hidden');
            if (screen) screen.classList.remove('hidden');
        }

        function showTab(tabName) {
            showScreen(null);
            const navs = [allDOMElements.navHome, allDOMElements.navHistory, allDOMElements.navLearned, allDOMElements.navBasket];
            navs.forEach(nav => nav.classList.remove('border-sky-600', 'text-sky-600'));

            if (tabName === 'home') {
                if (isLessonActive) {
                    allDOMElements.lessonScreen.classList.remove('hidden');
                } else {
                    allDOMElements.homeScreen.classList.remove('hidden');
                }
                allDOMElements.navHome.classList.add('border-sky-600', 'text-sky-600');
            } else if (tabName === 'history') {
                renderHistory();
                allDOMElements.historyScreen.classList.remove('hidden');
                allDOMElements.navHistory.classList.add('border-sky-600', 'text-sky-600');
            } else if (tabName === 'learned') {
                renderLearnedWords();
                allDOMElements.learnedWordsScreen.classList.remove('hidden');
                allDOMElements.navLearned.classList.add('border-sky-600', 'text-sky-600');
            } else if (tabName === 'basket') {
                renderBasket();
                allDOMElements.basketScreen.classList.remove('hidden');
                allDOMElements.navBasket.classList.add('border-sky-600', 'text-sky-600');
            }
        }

        function showModal(content, title = 'تنبيه', actions = []) {
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) existingModal.remove();
            
            const actionsHtml = actions.map(action => 
                `<button class="${action.class} px-4 py-2 rounded-md transition">${action.text}</button>`
            ).join('');

            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    <div>${content}</div>
                    <div class="mt-6 flex gap-3 justify-center">
                        ${actionsHtml}
                        <button class="modal-close bg-sky-600 text-white px-6 py-2 rounded-md hover:bg-sky-700">موافق</button>
                    </div>
                </div>`;
            document.body.appendChild(modalOverlay);
            
            modalOverlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-close') || e.target === modalOverlay) {
                    modalOverlay.remove();
                }
                actions.forEach((action, index) => {
                    if (e.target.classList.contains(action.class.split(' ')[0])) {
                        action.callback();
                        modalOverlay.remove();
                    }
                });
            });
        }
        
        function selectNewWords() {
            const count = Math.floor(Math.random() * 6) + 15; // 15 to 20 words
            const shuffled = remainingWords.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        async function generateLesson(words, rewrite = false, isRevision = false) {
            if (!apiKey) {
                showModal('الرجاء حفظ مفتاح Gemini API أولاً.');
                return;
            }
            isLessonActive = false;
            showScreen(allDOMElements.loadingScreen);

            const lessonType = isRevision ? 'مراجعة' : 'جديد';
            const prompt = `
            You are an expert English teacher for absolute beginners (A1 level) who speak Arabic. Your task is to create a lesson using these words: ${words.join(', ')}.

            **EXTREMELY IMPORTANT RULES:**
            1.  **A1 Level ONLY:** You MUST use ONLY words from the A1 vocabulary list. The grammar and sentence structure must also be strictly A1 level.
            2.  **SIMPLE SENTENCES:** Use very simple sentences like "Subject + Verb + Object". For example: "I have a cat." or "She likes apples."
            3.  **DO NOT USE:**
                * Complex sentences with clauses (like 'if', 'when', 'because').
                * Modal verbs for suggestion or possibility (like 'could', 'should', 'might'). Only use 'can' for ability.
                * Advanced tenses. Stick to the Present Simple.
            4.  **EXAMPLE:**
                * **GOOD A1 SENTENCE:** "John has a red car. He drives to work."
                * **BAD SENTENCE (Too complex):** "If John had a car, he could drive to work."
            5.  **DIVERSIFY CONTENT:** Randomly choose one style:
                * **Story:** Third-person narrative.
                * **Dialogue:** Conversation between two people (use English names like "John", "Sarah"). Format as: "John: Hello.\\nSarah: Hi."
                * **Narrative:** First-person narrative ("I am...").
            6.  **JSON FORMAT:** The entire response must be a single, valid JSON object with no extra text.
            7.  **EXERCISES:** The "question" text must be plain text without any markdown like **.

            ${rewrite ? 'أعد كتابة القصة والتمارين فقط بنفس الكلمات والقواعد السابقة، مع تغيير الأسلوب (قصة، حوار، سرد).' : 'قم بإنشاء درس جديد بالكامل.'}

            **هيكل JSON المطلوب:**
            {
              "story_type": "نوع القصة (story, dialogue, or narrative)",
              "story_mood": "صفة واحدة تصف الحالة المزاجية للقصة (e.g., happy, calm, exciting, neutral)",
              "story": "النص الأساسي (قصة أو حوار أو سرد) من 4-5 أسطر. قم بتمييز الكلمات المستهدفة بوسوم <b></b>.",
              "new_words": [{"word": "الكلمة", "translation": "ترجمتها"}],
              "grammar_focus": {
                "title": "عنوان القاعدة النحوية",
                "explanation": "شرح مطول ومفصل للقاعدة مع سياقها وكيف ظهرت في النص.",
                "examples": [
                  {"example": "Example sentence 1", "translation": "ترجمة المثال 1"},
                  {"example": "Example sentence 2", "translation": "ترجمة المثال 2"}
                ]
              },
              "useful_structures": [
                {"structure": "التركيب من القصة", "explanation": "شرح استخدامه ومعناه"}
              ],
              "pronunciation_tips": {
                  "title": "نصائح للنطق",
                  "tips": [
                      {"context": "الكلمة أو الحرف", "tip": "نصيحة النطق باللغة العربية"}
                  ]
              },
              "exercises": [
                {"type": "fill_in_the_blank", "question": "سؤال املأ الفراغ بالإنجليزية مع ___.", "answer": "الكلمة الصحيحة"},
                {"type": "multiple_choice", "question": "سؤال اختيار من متعدد.", "options": ["أ", "ب", "ج"], "answer": "الإجابة الصحيحة"},
                {"type": "true_false", "question": "جملة للحكم عليها.", "answer": "false"}
              ]
            }
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                const jsonString = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const lessonData = JSON.parse(jsonString);
                
                if (!rewrite && !isRevision) {
                    learnedWords.push(...words);
                    lessonData.learnedWords = words;
                    lessonData.date = new Date().toLocaleString('ar-EG');
                    lessonHistory.unshift(lessonData);
                    if (lessonHistory.length > 20) lessonHistory.pop();
                    saveState();
                    updateProgress();
                }
                
                renderLesson(lessonData, isRevision);
                isLessonActive = true;
                showScreen(allDOMElements.lessonScreen);

            } catch (error) {
                console.error('Error generating lesson:', error);
                showModal('حدث خطأ أثناء إنشاء الدرس. تأكد من صحة مفتاح API أو جرب مرة أخرى.');
                showScreen(allDOMElements.homeScreen);
            }
        }
        
        function createSection(title, content) {
            return `
                <div class="p-5 bg-white rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4 text-sky-700">${title}</h3>
                    ${content}
                </div>
            `;
        }

        function renderLesson(data, isRevision = false) {
            const lessonTitle = isRevision ? 'مراجعة النص' : '1. النص';
            const wordsTitle = isRevision ? 'كلمات للمراجعة' : '2. الكلمات الجديدة';

            allDOMElements.lessonScreen.innerHTML = `
                ${createSection(lessonTitle, `<div id="story-container" class="text-lg/relaxed font-english lesson-content" dir="ltr" data-mood="${data.story_mood || 'neutral'}">${formatStory(data.story, data.story_type)}</div>`)}
                ${createSection(wordsTitle, createTable(data.new_words, ['الكلمة', 'المعنى'], 'word', 'translation'))}
                ${createSection('3. قواعد نستفيدها', renderGrammarSection(data.grammar_focus))}
                ${createSection('4. تراكيب مفيدة', createTable(data.useful_structures, ['التركيب', 'الاستخدام'], 'structure', 'explanation'))}
                ${createSection(data.pronunciation_tips.title || '5. نصائح للنطق', renderPronunciationTips(data.pronunciation_tips))}
                ${createSection('6. تمارين', renderExercises(data.exercises))}
                <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
                    <button id="rewrite-btn" class="bg-amber-500 text-white px-6 py-2 rounded-md hover:bg-amber-600 transition">أعد كتابة القصة بنفس الكلمات</button>
                    <button id="next-lesson-btn" class="bg-sky-600 text-white px-6 py-2 rounded-md hover:bg-sky-700 transition">درس جديد بكلمات جديدة</button>
                </div>
            `;
            document.getElementById('rewrite-btn').addEventListener('click', () => generateLesson(data.learnedWords || data.new_words.map(w => w.word), true, isRevision));
            document.getElementById('next-lesson-btn').addEventListener('click', handleNewLesson);
            document.getElementById('check-answers-btn').addEventListener('click', checkAnswers);
        }
        
        function wrapWordsInSpans(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            const walker = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const textNodes = [];
            while(node = walker.nextNode()) {
                if (node.parentNode.tagName !== 'B' && node.parentNode.tagName !== 'SPAN') {
                     textNodes.push(node);
                }
            }

            textNodes.forEach(node => {
                const parent = node.parentNode;
                const words = node.nodeValue.split(/(\s+)/);
                const fragment = document.createDocumentFragment();
                words.forEach(word => {
                    if (word.trim().length > 0) {
                        const span = document.createElement('span');
                        span.className = 'word-span';
                        span.textContent = word;
                        fragment.appendChild(span);
                    } else {
                        fragment.appendChild(document.createTextNode(word));
                    }
                });
                parent.replaceChild(fragment, node);
            });

            return tempDiv.innerHTML;
        }

        function renderGrammarSection(grammar) {
            if (!grammar) return '<p>لا توجد ملاحظات نحوية لهذا الدرس.</p>';
            let html = `
                <h4 class="font-bold text-lg mb-2">${grammar.title}</h4>
                <p class="text-slate-600/90 mb-4">${grammar.explanation}</p>
            `;
            if (grammar.examples && grammar.examples.length > 0) {
                html += createTable(grammar.examples, ['المثال', 'الترجمة'], 'example', 'translation');
            }
            return html;
        }

        function renderPronunciationTips(pronunciation) {
            if (!pronunciation || !pronunciation.tips || pronunciation.tips.length === 0) return '<p>لا توجد نصائح نطق لهذا الدرس.</p>';
            return createTable(pronunciation.tips, ['الكلمة/الحرف', 'النصيحة'], 'context', 'tip');
        }

        function formatStory(story, type) {
            const wrappedStory = wrapWordsInSpans(story);
            if (type !== 'dialogue') return wrappedStory;
            
            const speakers = [];
            const lines = wrappedStory.split(/\n|<br>|<br\/>/g);
            return lines.map(line => {
                if (!line.trim()) return '';
                const match = line.match(/^(.*?):/);
                if (match) {
                    let speaker = match[1].replace(/<[^>]*>?/gm, '').trim();
                    let speakerClass = 'dialogue-speaker-1';
                    if (!speakers.includes(speaker)) speakers.push(speaker);
                    if (speakers.indexOf(speaker) % 2 !== 0) speakerClass = 'dialogue-speaker-2';
                    
                    const restOfLine = line.substring(match[0].length);
                    return `<div class="dialogue-line"><span class="${speakerClass}">${speaker}:</span>${restOfLine}</div>`;
                }
                return `<div class="dialogue-line">${line}</div>`;
            }).join('');
        }

        function createTable(data, headers, key1, key2) {
            let tableHTML = '<div class="overflow-x-auto"><table class="table-style">';
            tableHTML += `<thead><tr><th>${headers[0]}</th><th>${headers[1]}</th></tr></thead>`;
            tableHTML += '<tbody>';
            data.forEach(item => {
                tableHTML += `<tr><td>${item[key1]}</td><td>${item[key2]}</td></tr>`;
            });
            tableHTML += '</tbody></table></div>';
            return tableHTML;
        }

        function renderExercises(exercises) {
            let html = '<div class="space-y-4">';
            exercises.forEach((ex, index) => {
                const cleanQuestion = ex.question.replace(/\*\*/g, '');
                html += `<div class="exercise p-3 border-r-4 border-slate-200" data-answer="${ex.answer}">`;
                if (ex.type === 'fill_in_the_blank') {
                    html += `<p class="font-english" dir="ltr">${index + 1}. ${cleanQuestion.replace('___', '<input type="text" class="exercise-input border-b-2 bg-transparent text-center w-24 mx-1">')}</p>`;
                } else if (ex.type === 'multiple_choice') {
                    html += `<p class="font-english" dir="ltr">${index + 1}. ${cleanQuestion}</p>
                             <div class="flex flex-wrap gap-2 mt-2" dir="ltr">
                                ${ex.options.map(opt => `<label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer"><input type="radio" name="ex${index}" value="${opt}" class="exercise-input">${opt}</label>`).join('')}
                             </div>`;
                } else if (ex.type === 'true_false') {
                     html += `<p class="font-english" dir="ltr">${index + 1}. ${cleanQuestion}</p>
                              <div class="flex gap-4 mt-2" dir="ltr">
                                 <label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer"><input type="radio" name="ex${index}" value="true" class="exercise-input">True</label>
                                 <label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer"><input type="radio" name="ex${index}" value="false" class="exercise-input">False</label>
                              </div>`;
                }
                html += '</div>';
            });
            html += '</div><button id="check-answers-btn" class="mt-6 bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">تحقق من الإجابات</button>';
            html += '<div id="results-container" class="mt-4"></div>';
            return html;
        }

        function checkAnswers() {
            const exercises = document.querySelectorAll('.exercise');
            let correctCount = 0;
            exercises.forEach(ex => {
                const correctAnswer = ex.dataset.answer.toLowerCase();
                const inputs = ex.querySelectorAll('.exercise-input');
                let userAnswer = '';
                ex.classList.remove('border-green-400', 'border-red-400');

                if (inputs.length > 0 && inputs[0].type === 'text') {
                    userAnswer = inputs[0].value.trim().toLowerCase();
                    if (userAnswer === correctAnswer) {
                        ex.classList.add('border-green-400'); correctCount++;
                    } else { ex.classList.add('border-red-400'); }
                } else {
                    let answered = false;
                    inputs.forEach(input => {
                        if (input.checked) {
                            answered = true;
                            userAnswer = input.value.toLowerCase();
                            if (userAnswer === correctAnswer) {
                                ex.classList.add('border-green-400'); correctCount++;
                            } else { ex.classList.add('border-red-400'); }
                        }
                    });
                    if (!answered) ex.classList.add('border-red-400');
                }
            });
            document.getElementById('results-container').innerHTML = `<p class="font-bold">نتيجتك: ${correctCount} من ${exercises.length} إجابات صحيحة.</p>`;
        }

        function handleNewLesson() {
            const newWords = selectNewWords();
            if (newWords.length > 0) {
                generateLesson(newWords, false, false);
            } else {
                isLessonActive = false;
                showScreen(allDOMElements.homeScreen);
            }
        }

        function handleRevisionLesson() {
            const wordsForRevision = [...learnedWords].sort(() => 0.5 - Math.random()).slice(0, 15);
            if (wordsForRevision.length > 0) {
                generateLesson(wordsForRevision, false, true);
            }
        }

        function renderHistory() {
            if (lessonHistory.length === 0) {
                allDOMElements.historyList.innerHTML = '<p class="text-center text-slate-500">لا توجد دروس محفوظة بعد.</p>';
                return;
            }
            allDOMElements.historyList.innerHTML = lessonHistory.map((lesson, index) => `
                <div class="p-3 border rounded-md hover:bg-slate-100 cursor-pointer" onclick="viewHistoryItem(${index})">
                    <p class="font-bold">درس بتاريخ: ${lesson.date}</p>
                    <p class="text-sm text-slate-600 font-english" dir="ltr">${lesson.learnedWords.slice(0, 5).join(', ')}...</p>
                </div>
            `).join('');
        }

        function viewHistoryItem(index) {
            const lessonData = lessonHistory[index];
            renderLesson(lessonData, false);
            isLessonActive = true;
            showScreen(allDOMElements.lessonScreen);
        }

        function handleWordClick(event) {
            const target = event.target;
            if (target.classList.contains('word-span') || target.tagName === 'B') {
                const word = target.textContent.trim().replace(/[.,!?;:]/g, '');
                if (word) {
                    getTranslation(word);
                }
            }
        }

        function handleTextSelection(event) {
            const selection = window.getSelection();
            let selectedText = selection.toString().trim();
            
            if (!selectedText) {
                allDOMElements.selectionPopup.classList.add('hidden');
                return;
            }
            
            if (selectedText.length > 0 && allDOMElements.lessonScreen.contains(selection.anchorNode)) {
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                allDOMElements.selectionPopup.style.left = `${rect.left + window.scrollX + (rect.width / 2) - (allDOMElements.selectionPopup.offsetWidth / 2)}px`;
                allDOMElements.selectionPopup.style.top = `${rect.top + window.scrollY - allDOMElements.selectionPopup.offsetHeight - 10}px`;
                allDOMElements.selectionPopup.classList.remove('hidden');

                const storyContainer = document.getElementById('story-container');
                const mood = storyContainer ? storyContainer.dataset.mood : 'neutral';

                document.getElementById('popup-translate').onclick = () => { getTranslation(selectedText); allDOMElements.selectionPopup.classList.add('hidden'); };
                document.getElementById('popup-speak').onclick = () => { speakText(selectedText, mood); allDOMElements.selectionPopup.classList.add('hidden'); };
                document.getElementById('popup-phonetics').onclick = () => { getPhonetics(selectedText); allDOMElements.selectionPopup.classList.add('hidden'); };
                document.getElementById('popup-save').onclick = () => { saveToBasket(selectedText); allDOMElements.selectionPopup.classList.add('hidden'); };
            }
        }
        
        async function getTranslation(text) {
            const prompt = `Translate the English text "${text}" into a simple, direct Arabic equivalent. Provide only the translation, nothing else.`;
            const translation = await callGeminiForSimpleText(prompt);
            if (translation) {
                const actions = [{
                    text: '💾 حفظ في السلة',
                    class: 'save-to-basket-btn bg-green-500 text-white hover:bg-green-600',
                    callback: () => saveToBasket(text, translation)
                }];
                showModal(`<p class="text-xl font-bold text-sky-600">${translation}</p>`, `ترجمة: <span class="font-english">${text}</span>`, actions);
            }
        }

        async function getPhonetics(text) {
            const prompt = `اكتب النطق التقريبي لهذه الكلمة أو الجملة الإنجليزية باستخدام حروف عربية مبسطة. فقط أعط النطق ولا شيء آخر. النص هو: "${text}"`;
            const phonetics = await callGeminiForSimpleText(prompt);
            if (phonetics) {
                showModal(`<p class="text-xl font-bold text-sky-600">${phonetics}</p>`, `النطق التقريبي لـ: <span class="font-english">${text}</span>`);
            }
        }
        
        async function callGeminiForSimpleText(prompt) {
            if (!apiKey) { showModal('الرجاء حفظ مفتاح Gemini API أولاً.'); return null; }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error('API Error');
                const result = await response.json();
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                console.error('Error with simple text generation:', error);
                showModal('حدث خطأ أثناء التواصل مع الذكاء الاصطناعي.');
                return null;
            }
        }

        function saveToBasket(englishText, arabicText) {
            const isAlreadySaved = learningBasket.some(item => item.en.toLowerCase() === englishText.toLowerCase());
            if (isAlreadySaved) {
                showModal(`"${englishText}" <br><br> موجودة بالفعل في سلة التعلم.`);
                return;
            }
            
            learningBasket.unshift({ id: Date.now(), en: englishText, ar: arabicText });
            saveState();
            showModal(`"${englishText}" <br><br> تم حفظها بنجاح في سلة التعلم!`);
        }

        function renderLearnedWords() {
            const container = allDOMElements.learnedWordsScreen;
            const buttonHtml = learnedWords.length >= 15
                ? `<div class="text-center mb-6"><button id="review-lesson-btn" class="bg-sky-600 text-white px-6 py-2 rounded-md hover:bg-sky-700 transition">مراجعة بقصة جديدة</button></div>`
                : `<p class="text-center text-slate-500 mb-6">تحتاج لتعلم ${15 - learnedWords.length} كلمات أخرى على الأقل لبدء المراجعة بقصة.</p>`;

            const wordsHtml = learnedWords.length === 0 
                ? '<p class="text-center text-slate-500">لم تتعلم أي كلمات بعد. ابدأ درساً جديداً!</p>'
                : `<div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    ${[...learnedWords].sort().map(word => `
                        <div class="font-english p-3 border rounded-md text-center cursor-pointer hover:bg-sky-100" onclick="handleLearnedWordClick('${word}')">
                            ${word}
                        </div>
                    `).join('')}
                   </div>`;
            
            container.innerHTML = createSection('الكلمات التي تعلمتها', buttonHtml + wordsHtml);

            if (learnedWords.length >= 15) {
                document.getElementById('review-lesson-btn').addEventListener('click', handleRevisionLesson);
            }
        }
        
        async function handleLearnedWordClick(word) {
            const prompt = `Translate the English word "${word}" into a simple, direct Arabic equivalent. Provide only the translation.`;
            const translation = await callGeminiForSimpleText(prompt);
            if(translation) {
                saveToBasket(word, translation);
            }
        }

        function renderBasket() {
            const basketContainer = allDOMElements.basketScreen;
            if (learningBasket.length === 0) {
                basketContainer.innerHTML = createSection('سلة التعلم', '<p class="text-center text-slate-500">سلّتك فارغة. ابدأ بحفظ الكلمات والجمل لمراجعتها هنا.</p>');
                return;
            }

            const flashcardsHtml = `
                <div class="flashcard-container">
                    ${learningBasket.map(item => `
                        <div class="flashcard" onclick="this.classList.toggle('is-flipped')">
                            <div class="flashcard-inner">
                                <div class="flashcard-front font-english">${item.en}</div>
                                <div class="flashcard-back">${item.ar}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            const matchingHtml = renderMatchingExercise();

            basketContainer.innerHTML = `
                ${createSection('1. بطاقات تعليمية (Flashcards)', '<p class="mb-4 text-sm text-slate-500">اضغط على البطاقة لقلبها ورؤية الترجمة.</p>' + flashcardsHtml)}
                ${createSection('2. تمرين التوصيل', '<p class="mb-4 text-sm text-slate-500">صل الكلمة الإنجليزية بترجمتها الصحيحة.</p>' + matchingHtml)}
            `;
            
            setupMatchingExerciseListeners();
        }
        
        function renderMatchingExercise() {
            const shuffledEn = [...learningBasket].sort(() => 0.5 - Math.random());
            const shuffledAr = [...learningBasket].sort(() => 0.5 - Math.random());

            const enHtml = shuffledEn.map(item => 
                `<div class="match-item font-english" data-id="${item.id}">${item.en}</div>`
            ).join('');
            const arHtml = shuffledAr.map(item => 
                `<div class="match-item" data-id="${item.id}">${item.ar}</div>`
            ).join('');

            return `
                <div class="matching-container">
                    <div class="matching-column">${enHtml}</div>
                    <div class="matching-column">${arHtml}</div>
                </div>
                <p id="match-result" class="text-center font-bold mt-4"></p>
            `;
        }

        function setupMatchingExerciseListeners() {
            let selectedEn = null;
            let selectedAr = null;
            const items = document.querySelectorAll('.match-item');

            items.forEach(item => {
                item.addEventListener('click', () => {
                    const isEnglish = item.classList.contains('font-english');
                    
                    if (isEnglish) {
                        if (selectedEn) selectedEn.classList.remove('selected');
                        selectedEn = item;
                        item.classList.add('selected');
                    } else {
                        if (selectedAr) selectedAr.classList.remove('selected');
                        selectedAr = item;
                        item.classList.add('selected');
                    }

                    if (selectedEn && selectedAr) {
                        if (selectedEn.dataset.id === selectedAr.dataset.id) {
                            selectedEn.classList.add('correct');
                            selectedAr.classList.add('correct');
                            document.getElementById('match-result').textContent = 'صحيح!';
                            document.getElementById('match-result').style.color = 'green';
                        } else {
                            selectedEn.classList.add('incorrect');
                            selectedAr.classList.add('incorrect');
                            document.getElementById('match-result').textContent = 'حاول مرة أخرى!';
                             document.getElementById('match-result').style.color = 'red';
                            setTimeout(() => {
                                selectedEn.classList.remove('incorrect');
                                selectedAr.classList.remove('incorrect');
                            }, 1000);
                        }
                        if (selectedEn) selectedEn.classList.remove('selected');
                        if (selectedAr) selectedAr.classList.remove('selected');
                        selectedEn = null;
                        selectedAr = null;
                    }
                });
            });
        }

        async function speakText(text, mood = 'neutral') {
            if (!apiKey || !audioContext) {
                showModal('ميزة الصوت غير متاحة. يرجى التحقق من مفتاح API أو دعم المتصفح.');
                return;
            }
            const cleanText = text.replace(/<[^>]*>?/gm, '');
            const randomVoice = ttsVoices[Math.floor(Math.random() * ttsVoices.length)];
            const promptText = mood === 'neutral' ? cleanText : `Say in a ${mood} tone: ${cleanText}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "gemini-2.5-flash-preview-tts",
                        contents: [{ parts: [{ text: promptText }] }],
                        generationConfig: { 
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: randomVoice }
                                }
                            }
                        },
                    })
                });
                if (!response.ok) throw new Error(`TTS API Error: ${response.status}`);
                const result = await response.json();
                const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (audioData) {
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, 24000);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    new Audio(audioUrl).play();
                }
            } catch (error) {
                console.error('Error with TTS:', error);
                showModal('حدث خطأ أثناء تشغيل الصوت.');
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const view = new DataView(new ArrayBuffer(44 + pcmData.length * 2));
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + pcmData.length * 2, true);
            writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true);
            view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true);
            view.setUint16(34, 16, true); writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length * 2, true);
            for (let i = 0; i < pcmData.length; i++) { view.setInt16(44 + i * 2, pcmData[i], true); }
            return new Blob([view], { type: 'audio/wav' });
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function handleSaveApiKey() {
            const key = allDOMElements.apiKeyInput.value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('geminiApiKey', key);
                allDOMElements.apiKeySection.classList.add('hidden');
                allDOMElements.mainContent.classList.remove('hidden');
            } else {
                showModal('الرجاء إدخال مفتاح API صحيح.');
            }
        }
        
        function handleResetProgress() {
            if (window.confirm('هل أنت متأكد أنك تريد إعادة تعيين كل تقدمك؟ سيتم حذف جميع الكلمات والدروس المحفوظة.')) {
                learnedWords = [];
                learningBasket = [];
                lessonHistory = [];
                isLessonActive = false;
                saveState();
                updateProgress();
                showTab('home');
            }
        }

        initialize();
    </script>
</body>
</html>
