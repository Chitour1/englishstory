<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù‚ØµØªÙŠ Ø§Ù„Ù„ØºÙˆÙŠØ© - ØªØ¹Ù„Ù… Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Google Identity Services Scripts -->
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .font-english {
            font-family: 'Inter', sans-serif;
        }
        .lesson-content b { /* New Words */
            background-color: #fef08a; padding: 2px 4px; border-radius: 4px;
            font-weight: 700; color: #713f12; cursor: pointer;
        }
        .lesson-content i { /* Repetition Words */
            background-color: #dbeafe; padding: 2px 4px; border-radius: 4px;
            font-weight: 700; color: #1e3a8a; cursor: pointer; font-style: normal;
        }
        .lesson-content .word-span { cursor: pointer; }
        .lesson-content .word-span:hover { background-color: #e0f2fe; }
        .dialogue-line { margin-bottom: 0.5rem; }
        .dialogue-speaker-1 { color: #1d4ed8; font-weight: bold; }
        .dialogue-speaker-2 { color: #be185d; font-weight: bold; }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #selection-popup button {
            background: none; border: none; cursor: pointer; font-size: 14px; font-family: 'Cairo', sans-serif;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 8px;
            max-width: 90%; width: 450px; text-align: center;
            max-height:80vh; overflow:auto;
        }
        #selection-popup{position:fixed;max-width:90vw}
        .table-style { width: 100%; border-collapse: collapse; }
        .table-style th, .table-style td {
            border: 1px solid #e2e8f0; padding: 12px; text-align: right;
        }
        .table-style th { background-color: #f1f5f9; }
        .table-style td:first-child {
            font-weight: bold; font-family: 'Inter', sans-serif; direction: ltr;
        }
        /* Flashcard styles */
        .flashcard-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .flashcard {
            background-color: white; border: 1px solid #e2e8f0; border-radius: 8px;
            height: 100px; perspective: 1000px; cursor: pointer;
        }
        .flashcard-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s; transform-style: preserve-3d;
        }
        .flashcard.is-flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back {
            position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden;
            backface-visibility: hidden; display: flex; align-items: center; justify-content: center;
            padding: 1rem; font-size: 1.1rem;
        }
        .flashcard-back { transform: rotateY(180deg); background-color: #f0f9ff; }
        /* Matching exercise styles */
        .matching-container { display: flex; justify-content: space-around; gap: 1rem; }
        .matching-column { display: flex; flex-direction: column; gap: 0.5rem; flex: 1; }
        .match-item {
            padding: 0.75rem; border: 2px solid #cbd5e1; border-radius: 6px;
            cursor: pointer; transition: all 0.2s;
        }
        .match-item.selected { border-color: #3b82f6; background-color: #dbeafe; }
        .match-item.correct { border-color: #22c55e; background-color: #dcfce7; pointer-events: none; }
        .match-item.incorrect { border-color: #ef4444; background-color: #fee2e2; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-sky-600 mb-2">Ù‚ØµØªÙŠ Ø§Ù„Ù„ØºÙˆÙŠØ©</h1>
            <p class="text-lg text-slate-600">ØªØ¹Ù„Ù… Ù…ÙØ±Ø¯Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù…Ù† Ø®Ù„Ø§Ù„ Ù‚ØµØµ ÙŠØµÙ†Ø¹Ù‡Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
             <div id="auth-container" class="mt-4">
                <button id="signin-btn" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¹ Google Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù…</button>
                <button id="signout-btn" class="hidden bg-red-500 text-white px-6 py-2 rounded-md hover:bg-red-600 transition">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
             <div id="user-chip" class="hidden mt-3 flex items-center justify-center gap-3">
                <img id="user-photo" class="w-8 h-8 rounded-full border" alt="">
                <span id="user-name" class="text-slate-700 font-semibold"></span>
            </div>
        </header>

        <div id="api-key-section" class="hidden mb-6 p-4 bg-white rounded-lg shadow-md">
            <div class="flex items-center gap-3 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500"><path d="M14 9a2 2 0 0 1-2 2H6l-4 4V4c0-1.1.9-2 2-2h8a2 2 0 0 1 2 2v5Z"/><path d="M18 9h2a2 2 0 0 1 2 2v10l-4-4H8a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h2"/><path d="M22 12h-2"/><path d="M18 12h-2"/></svg>
                <h2 class="text-xl font-bold">Ù…ÙØªØ§Ø­ Gemini API</h2>
            </div>
            <p class="text-slate-600 mb-3 text-sm">Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Gemini API Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡ Ù…Ù† <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-sky-600 hover:underline">Google AI Studio</a>.</p>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="password" id="api-key-input" class="flex-grow p-2 border rounded-md font-english" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­Ùƒ Ù‡Ù†Ø§...">
                <button id="save-api-key-btn" class="bg-sky-600 text-white px-6 py-2 rounded-md hover:bg-sky-700 transition">Ø­ÙØ¸ ÙˆØ§Ù„Ø¨Ø¯Ø¡</button>
            </div>
        </div>

        <main id="main-content" class="hidden">
            
            <div class="mb-6 flex justify-center border-b flex-wrap">
                <button id="nav-home" class="px-4 py-3 text-lg font-bold border-b-4 border-sky-600 text-sky-600">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                <button id="nav-history" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±ÙˆØ³</button>
                <button id="nav-in-progress" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">ÙƒÙ„Ù…Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹Ù„Ù…</button>
                <button id="nav-mastered" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">Ø§Ù„Ù…ØªÙ‚Ù†Ø©</button>
                <button id="nav-basket" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">Ø³Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
            </div>
            
            <div id="stats-section" class="mb-6 p-4 bg-white rounded-lg shadow-md flex flex-wrap justify-around text-center">
                <div><p class="text-slate-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</p><p id="total-words" class="text-2xl font-bold text-sky-600 font-english">0</p></div>
                <div><p class="text-slate-500">ÙƒÙ„Ù…Ø§Øª ØªØ¹Ù„Ù…ØªÙ‡Ø§</p><p id="learned-words" class="text-2xl font-bold text-green-600 font-english">0</p></div>
                <div><p class="text-slate-500">Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</p><p id="remaining-words" class="text-2xl font-bold text-amber-600 font-english">0</p></div>
            </div>

            <div id="home-screen" class="text-center p-8 bg-white rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4">Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯ Ù„Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯ØŸ</h2>
                <p class="text-slate-600 mb-6">Ø­Ø¯Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ£Ø¶Ù ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ù‚ØµØ© Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª.</p>
                
                <div class="max-w-md mx-auto space-y-4 mb-6 text-right">
                    <div>
                        <label for="word-count-home" class="block text-sm font-medium text-slate-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù‚ØµØ© (ØªÙ‚Ø±ÙŠØ¨ÙŠÙ‹Ø§ 50-500)</label>
                        <input type="number" id="word-count-home" value="100" min="50" max="500" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                    </div>
                    <div>
                        <label for="custom-prompt-home" class="block text-sm font-medium text-slate-700">Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ù„Ù‚ØµØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <textarea id="custom-prompt-home" rows="2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500" placeholder="Ù…Ø«Ø§Ù„: Ù‚ØµØ© Ø¹Ù† Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙÙŠ Ø­Ø¯ÙŠÙ‚Ø©ØŒ Ù„Ù„Ø£Ø·ÙØ§Ù„..."></textarea>
                    </div>
                </div>

                <button id="new-lesson-btn" class="bg-green-600 text-white px-8 py-3 rounded-lg text-lg font-bold hover:bg-green-700 transition transform hover:scale-105">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        Ø£Ù†Ø´Ø¦ Ù‚ØµØ© Ø¬Ø¯ÙŠØ¯Ø©
                    </span>
                </button>
                <div class="mt-4 flex justify-center gap-2">
                    <button id="reset-progress-btn" class="bg-red-500 text-white px-4 py-2 rounded-md text-sm hover:bg-red-600 transition">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªÙ‚Ø¯Ù…</button>
                    <button id="export-btn" class="bg-slate-600 text-white px-4 py-2 rounded-md text-sm hover:bg-slate-700">ØªØµØ¯ÙŠØ±</button>
                    <label class="inline-flex items-center gap-2 cursor-pointer">
                      <span class="bg-slate-500 text-white px-3 py-2 rounded-md text-sm">Ø§Ø³ØªÙŠØ±Ø§Ø¯</span>
                      <input id="import-input" type="file" accept="application/json" class="hidden">
                    </label>
                </div>
            </div>

            <div id="history-screen" class="hidden p-4 bg-white rounded-lg shadow-md space-y-3">
                <h2 class="text-2xl font-bold mb-4 text-center">Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2>
                <div id="history-list" class="space-y-2"></div>
            </div>

            <div id="in-progress-screen" class="hidden p-4 bg-white rounded-lg shadow-md"></div>
            <div id="mastered-screen" class="hidden p-4 bg-white rounded-lg shadow-md"></div>
            <div id="basket-screen" class="hidden space-y-6"></div>

            <div id="loading-screen" class="hidden text-center p-8 bg-white rounded-lg shadow-md">
                <div class="flex justify-center mb-4"><div class="loader"></div></div>
                <p class="text-slate-600 text-lg">Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠÙƒØªØ¨ Ù‚ØµØªÙƒ... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.</p>
            </div>

            <div id="lesson-screen" class="hidden space-y-6"></div>
        </main>

        <div id="selection-popup" class="hidden absolute bg-white border rounded-lg shadow-xl p-1 flex gap-1 z-50">
            <button id="popup-translate" title="ØªØ±Ø¬Ù…Ø©" class="p-2 hover:bg-slate-100 rounded-md">ğŸ‡¹ğŸ‡·</button>
            <button id="popup-speak" title="Ù†Ø·Ù‚" class="p-2 hover:bg-slate-100 rounded-md">ğŸ”Š</button>
            <button id="popup-phonetics" title="ÙƒØªØ§Ø¨Ø© ØµÙˆØªÙŠØ©" class="p-2 hover:bg-slate-100 rounded-md">ğŸ—£ï¸</button>
            <button id="popup-save" title="Ø­ÙØ¸ Ù„Ù„Ø³Ù„Ø©" class="p-2 hover:bg-slate-100 rounded-md">ğŸ’¾</button>
        </div>
    </div>
    <div id="overlay" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-[2000]">
      <div class="bg-white rounded-xl p-6 shadow-xl flex flex-col items-center gap-3">
        <div class="loader"></div>
        <p id="overlay-text" class="text-slate-700">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</p>
      </div>
    </div>

    <script>
        /* --- AUTH + STATE --- */
        const CLIENT_ID = '484856738377-c2ng08gfa9sstobj8ilji7vduk47qa3p.apps.googleusercontent.com';
        const SCOPES = 'openid email profile https://www.googleapis.com/auth/drive.appdata';
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let driveFileId = localStorage.getItem('languageStoryFileId') || null;
        let isGoogleLoggedIn = false;
        let currentMode = localStorage.getItem('ls_currentMode') || 'home'; // 'home' | 'revision'
        let uiState = JSON.parse(localStorage.getItem('ls_uiState') || '{"activeTab":"home","isLessonActive":false}');
        function saveUiState(){
          localStorage.setItem('ls_currentMode', currentMode);
          localStorage.setItem('ls_uiState', JSON.stringify(uiState));
        }
        
        function gapiLoaded(){ gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient(){
          await gapi.client.init({});
          gapiInited = true;
          checkAuthInit();
          const hadConsent = localStorage.getItem('ls_had_consent') === '1';
          if(hadConsent){ trySilentRefresh(); }
        }
        function gisLoaded(){
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID.trim(),
            scope: SCOPES,
            callback: gapiTokenCallback,
          });
          gisInited = true;
          checkAuthInit();
        }
        function checkAuthInit(){
          if(gapiInited && gisInited){
            document.getElementById('signin-btn').disabled = false;
            showTab(uiState.activeTab || 'home');
            if(uiState.isLessonActive){ allDOMElements.lessonScreen.classList.remove('hidden'); }
          }
        }
        async function trySilentRefresh(){
          tokenClient.requestAccessToken({prompt: ''});
        }
        async function fetchUserInfoAndDisplay(){
          try{
            const tk = gapi.client.getToken();
            if(!tk?.access_token) return;
            const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
              headers: { Authorization: `Bearer ${tk.access_token}` }
            });
            const info = await res.json();
            const chip = document.getElementById('user-chip');
            const nm = document.getElementById('user-name');
            const ph = document.getElementById('user-photo');
            nm.textContent = info.name || info.email || 'User';
            ph.src = info.picture || '';
            chip.classList.remove('hidden');
          }catch(e){ console.warn('userinfo failed', e); }
        }
        async function gapiTokenCallback(resp){
          if(resp.error){ console.error(resp); showModal('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.'); return; }
          gapi.client.setToken({ access_token: resp.access_token });
          isGoogleLoggedIn = true;
          localStorage.setItem('ls_had_consent','1');
          updateUiForLoginStatus();
          await fetchUserInfoAndDisplay();
          showOverlay('Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ù† Google Driveâ€¦');
          await loadStateFromDrive();
          hideOverlay();
        }
        function handleAuthClick(){
          if(gapiInited && gisInited){ tokenClient.requestAccessToken({prompt:'consent'}); }
          else { showModal('Ø®Ø¯Ù…Ø§Øª Google Ù„Ù… ØªÙØ­Ù…ÙÙ‘Ù„ Ø¨Ø¹Ø¯.'); }
        }
        function handleSignoutClick(){
          const token = gapi.client.getToken();
          if(token){
            google.accounts.oauth2.revoke(token.access_token, () => {
              gapi.client.setToken('');
              isGoogleLoggedIn = false;
              localStorage.removeItem('ls_had_consent');
              driveFileId = null;
              localStorage.removeItem('languageStoryFileId');
              updateUiForLoginStatus();
              loadState({ wordsInProgress: [], masteredWords: [], learningBasket: [], lessonHistory: [] });
              document.getElementById('user-chip').classList.add('hidden');
              showModal('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.');
            });
          }
        }

        const a1Words = ['a', 'an', 'about', 'above', 'across', 'action', 'activity', 'actor', 'actress', 'add', 'address', 'adult', 'advice', 'afraid', 'after', 'afternoon', 'again', 'age', 'ago', 'agree', 'air', 'airport', 'all', 'also', 'always', 'amazing', 'and', 'angry', 'animal', 'another', 'answer', 'any', 'anyone', 'anything', 'apartment', 'apple', 'April', 'area', 'arm', 'around', 'arrive', 'art', 'article', 'artist', 'as', 'ask', 'at', 'August', 'aunt', 'autumn', 'away', 'baby', 'back', 'bad', 'bag', 'ball', 'banana', 'band', 'bank', 'bath', 'bathroom', 'be', 'beach', 'beautiful', 'because', 'become', 'bed', 'bedroom', 'beer', 'before', 'begin', 'beginning', 'behind', 'believe', 'below', 'best', 'better', 'between', 'bicycle', 'big', 'bike', 'bill', 'bird', 'birthday', 'black', 'blog', 'blonde', 'blue', 'boat', 'body', 'book', 'boot', 'bored', 'boring', 'born', 'both', 'bottle', 'box', 'boy', 'boyfriend', 'bread', 'break', 'breakfast', 'bring', 'brother', 'brown', 'build', 'building', 'bus', 'business', 'busy', 'but', 'butter', 'buy', 'by', 'bye', 'cafe', 'cake', 'call', 'camera', 'can', 'cannot', 'capital', 'car', 'card', 'career', 'carrot', 'carry', 'cat', 'CD', 'cent', 'centre', 'century', 'chair', 'change', 'chart', 'cheap', 'check', 'cheese', 'chicken', 'child', 'chocolate', 'choose', 'cinema', 'city', 'class', 'classroom', 'clean', 'climb', 'clock', 'close', 'clothes', 'club', 'coat', 'coffee', 'cold', 'college', 'colour', 'come', 'common', 'company', 'compare', 'complete', 'computer', 'concert', 'conversation', 'cook', 'cooking', 'cool', 'correct', 'cost', 'could', 'country', 'course', 'cousin', 'cow', 'cream', 'create', 'culture', 'cup', 'customer', 'cut', 'dad', 'dance', 'dancer', 'dancing', 'dangerous', 'dark', 'date', 'daughter', 'day', 'dear', 'December', 'decide', 'delicious', 'describe', 'description', 'design', 'desk', 'detail', 'dialogue', 'dictionary', 'die', 'diet', 'difference', 'different', 'difficult', 'dinner', 'dirty', 'discuss', 'dish', 'do', 'doctor', 'dog', 'dollar', 'door', 'down', 'downstairs', 'draw', 'dress', 'drink', 'drive', 'driver', 'during', 'DVD', 'each', 'ear', 'early', 'east', 'easy', 'eat', 'egg', 'eight', 'eighteen', 'eighty', 'elephant', 'eleven', 'else', 'email', 'end', 'enjoy', 'enough', 'euro', 'even', 'evening', 'event', 'ever', 'every', 'everybody', 'everyone', 'everything', 'exam', 'example', 'excited', 'exciting', 'exercise', 'expensive', 'explain', 'extra', 'eye', 'face', 'fact', 'fall', 'false', 'family', 'famous', 'fantastic', 'far', 'farm', 'farmer', 'fast', 'fat', 'father', 'favourite', 'February', 'feel', 'feeling', 'festival', 'few', 'fifteen', 'fifth', 'fifty', 'fill', 'film', 'final', 'find', 'fine', 'finish', 'fire', 'first', 'fish', 'five', 'flat', 'flight', 'floor', 'flower', 'fly', 'follow', 'food', 'foot', 'football', 'for', 'forget', 'form', 'forty', 'four', 'fourteen', 'fourth', 'free', 'Friday', 'friend', 'friendly', 'from', 'front', 'fruit', 'full', 'fun', 'funny', 'future', 'game', 'garden', 'geography', 'get', 'girl', 'girlfriend', 'give', 'glass', 'go', 'good', 'goodbye', 'grandfather', 'grandmother', 'grandparent', 'great', 'green', 'grey', 'group', 'grow', 'guess', 'guitar', 'gym', 'hair', 'half', 'hand', 'happen', 'happy', 'hard', 'hat', 'hate', 'have', 'have to', 'he', 'head', 'health', 'healthy', 'hear', 'hello', 'help', 'her', 'here', 'hey', 'hi', 'high', 'him', 'his', 'history', 'hobby', 'holiday', 'home', 'homework', 'hope', 'horse', 'hospital', 'hot', 'hotel', 'hour', 'house', 'how', 'however', 'hundred', 'hungry', 'husband', 'I', 'ice', 'ice cream', 'idea', 'if', 'imagine', 'important', 'improve', 'in', 'include', 'information', 'interest', 'interested', 'interesting', 'internet', 'interview', 'into', 'introduce', 'island', 'it', 'its', 'January', 'jeans', 'job', 'join', 'journey', 'juice', 'July', 'June', 'just', 'keep', 'key', 'kilometre', 'kind', 'kitchen', 'know', 'land', 'language', 'large', 'last', 'late', 'later', 'laugh', 'learn', 'leave', 'left', 'leg', 'lesson', 'let', 'letter', 'library', 'lie', 'life', 'light', 'like', 'line', 'lion', 'list', 'listen', 'little', 'live', 'local', 'long', 'look', 'lose', 'lot', 'love', 'lunch', 'machine', 'magazine', 'main', 'make', 'man', 'many', 'map', 'March', 'market', 'married', 'match', 'May', 'maybe', 'me', 'meal', 'mean', 'meaning', 'meat', 'meet', 'meeting', 'member', 'menu', 'message', 'metre', 'midnight', 'mile', 'milk', 'million', 'minute', 'miss', 'mistake', 'model', 'modern', 'moment', 'Monday', 'money', 'month', 'more', 'morning', 'most', 'mother', 'mountain', 'mouse', 'mouth', 'move', 'movie', 'much', 'mum', 'museum', 'music', 'must', 'my', 'name', 'natural', 'near', 'need', 'negative', 'neighbour', 'never', 'new', 'news', 'newspaper', 'next', 'next to', 'nice', 'night', 'nine', 'nineteen', 'ninety', 'no', 'no one', 'nobody', 'north', 'nose', 'not', 'note', 'nothing', 'November', 'now', 'number', 'nurse', 'object', "o'clock", 'October', 'of', 'off', 'office', 'often', 'oh', 'OK', 'old', 'on', 'once', 'one', 'onion', 'online', 'only', 'open', 'opinion', 'opposite', 'or', 'orange', 'order', 'other', 'our', 'out', 'outside', 'over', 'own', 'page', 'paint', 'painting', 'pair', 'paper', 'paragraph', 'parent', 'park', 'part', 'partner', 'party', 'passport', 'past', 'pay', 'pen', 'pencil', 'people', 'pepper', 'perfect', 'period', 'person', 'personal', 'phone', 'photo', 'photograph', 'phrase', 'piano', 'picture', 'piece', 'pig', 'pink', 'place', 'plan', 'plane', 'plant', 'play', 'player', 'please', 'point', 'police', 'policeman', 'pool', 'poor', 'popular', 'positive', 'possible', 'post', 'potato', 'pound', 'practice', 'practise', 'prefer', 'prepare', 'present', 'pretty', 'price', 'probably', 'problem', 'product', 'programme', 'project', 'purple', 'put', 'quarter', 'question', 'quick', 'quickly', 'quiet', 'quite', 'radio', 'rain', 'read', 'reader', 'reading', 'ready', 'real', 'really', 'reason', 'red', 'relax', 'remember', 'repeat', 'report', 'restaurant', 'result', 'return', 'rice', 'rich', 'ride', 'right', 'river', 'road', 'room', 'routine', 'rule', 'run', 'sad', 'salad', 'salt', 'same', 'sandwich', 'Saturday', 'say', 'school', 'science', 'scientist', 'sea', 'second', 'section', 'see', 'sell', 'send', 'sentence', 'September', 'seven', 'seventeen', 'seventy', 'share', 'she', 'sheep', 'shirt', 'shoe', 'shop', 'shopping', 'short', 'should', 'show', 'shower', 'sick', 'similar', 'sing', 'singer', 'sister', 'sit', 'situation', 'six', 'sixteen', 'sixty', 'skill', 'skirt', 'sleep', 'slow', 'small', 'snake', 'snow', 'so', 'some', 'somebody', 'someone', 'something', 'sometimes', 'son', 'song', 'soon', 'sorry', 'sound', 'soup', 'south', 'space', 'speak', 'special', 'spell', 'spelling', 'spend', 'sport', 'spring', 'stand', 'star', 'start', 'statement', 'station', 'stay', 'still', 'stop', 'story', 'street', 'strong', 'student', 'study', 'style', 'subject', 'success', 'sugar', 'summer', 'sun', 'Sunday', 'supermarket', 'sure', 'sweater', 'swim', 'swimming', 'table', 'take', 'talk', 'tall', 'taxi', 'tea', 'teach', 'teacher', 'team', 'teenager', 'telephone', 'television', 'tell', 'ten', 'tennis', 'terrible', 'test', 'text', 'than', 'thank', 'thanks', 'that', 'the', 'theatre', 'their', 'them', 'then', 'there', 'they', 'thing', 'think', 'third', 'thirsty', 'thirteen', 'thirty', 'this', 'thousand', 'three', 'through', 'Thursday', 'ticket', 'time', 'tired', 'title', 'to', 'today', 'together', 'toilet', 'tomato', 'tomorrow', 'tonight', 'too', 'tooth', 'topic', 'tourist', 'town', 'traffic', 'train', 'travel', 'tree', 'trip', 'trousers', 'true', 'try', 'T-shirt', 'Tuesday', 'turn', 'TV', 'twelve', 'twenty', 'twice', 'two', 'type', 'umbrella', 'uncle', 'under', 'understand', 'university', 'until', 'up', 'upstairs', 'us', 'use', 'useful', 'usually', 'vacation', 'vegetable', 'very', 'video', 'village', 'visit', 'visitor', 'wait', 'waiter', 'wake', 'walk', 'wall', 'want', 'warm', 'wash', 'watch', 'water', 'way', 'we', 'wear', 'weather', 'website', 'Wednesday', 'week', 'weekend', 'welcome', 'well', 'west', 'what', 'when', 'where', 'which', 'white', 'who', 'why', 'wife', 'will', 'win', 'window', 'wine', 'winter', 'with', 'without', 'woman', 'wonderful', 'word', 'work', 'worker', 'world', 'worry', 'would', 'write', 'writer', 'writing', 'wrong', 'year', 'yellow', 'yes', 'yesterday', 'you', 'young', 'your', 'yourself'];
        const ttsVoices = ['Zephyr', 'Puck', 'Charon', 'Kore', 'Fenrir', 'Leda', 'Orus', 'Aoede', 'Callirrhoe', 'Autonoe', 'Enceladus', 'Iapetus', 'Umbriel', 'Algieba', 'Despina', 'Erinome', 'Algenib', 'Rasalgethi', 'Laomedeia', 'Achernar', 'Alnilam', 'Schedar', 'Gacrux', 'Pulcherrima', 'Achird', 'Zubenelgenubi', 'Vindemiatrix', 'Sadachbia', 'Sadaltager', 'Sulafat'];
        const repetitionIntervals = { 1: 5, 2: 15, 3: 20 };

        const allDOMElements = {
            authContainer: document.getElementById('auth-container'),
            signinBtn: document.getElementById('signin-btn'),
            signoutBtn: document.getElementById('signout-btn'),
            apiKeySection: document.getElementById('api-key-section'),
            apiKeyInput: document.getElementById('api-key-input'),
            saveApiKeyBtn: document.getElementById('save-api-key-btn'),
            mainContent: document.getElementById('main-content'),
            navHome: document.getElementById('nav-home'),
            navHistory: document.getElementById('nav-history'),
            navLearned: document.getElementById('nav-in-progress'),
            navMastered: document.getElementById('nav-mastered'),
            navBasket: document.getElementById('nav-basket'),
            homeScreen: document.getElementById('home-screen'),
            historyScreen: document.getElementById('history-screen'),
            inProgressScreen: document.getElementById('in-progress-screen'),
            masteredScreen: document.getElementById('mastered-screen'),
            basketScreen: document.getElementById('basket-screen'),
            historyList: document.getElementById('history-list'),
            statsSection: document.getElementById('stats-section'),
            totalWordsEl: document.getElementById('total-words'),
            learnedWordsEl: document.getElementById('learned-words'),
            remainingWordsEl: document.getElementById('remaining-words'),
            newLessonBtn: document.getElementById('new-lesson-btn'),
            resetProgressBtn: document.getElementById('reset-progress-btn'),
            loadingScreen: document.getElementById('loading-screen'),
            lessonScreen: document.getElementById('lesson-screen'),
            selectionPopup: document.getElementById('selection-popup'),
            exportBtn: document.getElementById('export-btn'),
            importInput: document.getElementById('import-input'),
        };

        let apiKey = '';
        let wordsInProgress = [];
        let masteredWords = [];
        let learningBasket = [];
        let lessonHistory = [];
        let audioContext;
        let isLessonActive = false;
        let isDragging = false;
        let basketPage = 1; 
        const BASKET_PAGE_SIZE = 12;
        
        function initialize() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error("Web Audio API is not supported in this browser");
                showModal("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠØ§ØªØŒ Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙŠØ²Ø§Øª.");
            }
            
            allDOMElements.signinBtn.disabled = true;
            setupEventListeners();
            updateUiForLoginStatus();

            if(uiState.activeTab){ showTab(uiState.activeTab); }
            if(localStorage.getItem('geminiApiKey')){ allDOMElements.mainContent.classList.remove('hidden'); }
        }

        function setupEventListeners() {
            allDOMElements.signinBtn.addEventListener('click', handleAuthClick);
            allDOMElements.signoutBtn.addEventListener('click', handleSignoutClick);
            allDOMElements.saveApiKeyBtn.addEventListener('click', handleSaveApiKey);
            allDOMElements.apiKeyInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSaveApiKey(); });
            allDOMElements.newLessonBtn.addEventListener('click', handleNewLesson);
            allDOMElements.resetProgressBtn.addEventListener('click', handleResetProgress);
            allDOMElements.navHome.addEventListener('click', () => showTab('home'));
            allDOMElements.navHistory.addEventListener('click', () => showTab('history'));
            allDOMElements.navLearned.addEventListener('click', () => showTab('in-progress'));
            allDOMElements.navMastered.addEventListener('click', () => showTab('mastered'));
            allDOMElements.navBasket.addEventListener('click', () => showTab('basket'));
            allDOMElements.exportBtn?.addEventListener('click', ()=>{
              const data = {wordsInProgress, masteredWords, learningBasket, lessonHistory};
              const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
              const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'language_story_backup.json'; a.click();
            });
            allDOMElements.importInput?.addEventListener('change', async (e)=>{
              const f = e.target.files[0]; if(!f) return;
              const txt = await f.text(); const d = JSON.parse(txt);
              loadState(d); saveState(); showModal('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.');
            });

            const lessonArea = allDOMElements.lessonScreen;
            lessonArea.addEventListener('mousedown', () => { isDragging = false; });
            lessonArea.addEventListener('mousemove', () => { isDragging = true; });
            lessonArea.addEventListener('mouseup', handleInteractionEnd);
            lessonArea.addEventListener('touchstart', () => { isDragging = false; }, { passive: true });
            lessonArea.addEventListener('touchmove', () => { isDragging = true; }, { passive: true });
            lessonArea.addEventListener('touchend', handleInteractionEnd);
        }

        function updateUiForLoginStatus() {
            if (isGoogleLoggedIn) {
                allDOMElements.signinBtn.classList.add('hidden');
                allDOMElements.signoutBtn.classList.remove('hidden');
                allDOMElements.apiKeySection.classList.remove('hidden');
                if (apiKey) {
                    allDOMElements.mainContent.classList.remove('hidden');
                }
            } else {
                allDOMElements.signinBtn.classList.remove('hidden');
                allDOMElements.signoutBtn.classList.add('hidden');
                allDOMElements.apiKeySection.classList.add('hidden');
                allDOMElements.mainContent.classList.add('hidden');
            }
        }
        
        function loadState(data) {
            apiKey = localStorage.getItem('geminiApiKey') || '';
            wordsInProgress = data.wordsInProgress || [];
            masteredWords = data.masteredWords || [];
            learningBasket = data.learningBasket || [];
            lessonHistory = data.lessonHistory || [];
            
            if (apiKey) {
                 allDOMElements.apiKeyInput.value = apiKey;
            }
            
            updateProgress();
            updateUiForLoginStatus();
        }

        function saveState() {
             return saveStateToDrive();
        }
        
        async function loadStateFromDrive() {
            if (!gapiInited) await initializeGapiClient();
            await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');

            try {
                if (driveFileId) {
                    const file = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });
                    const raw = file.result ?? file.body ?? '{}';
                    const data = typeof raw === 'string' ? JSON.parse(raw) : raw;
                    loadState(data);
                    showModal('ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø¯Ù…Ùƒ Ù…Ù† Google Drive Ø¨Ù†Ø¬Ø§Ø­.');
                    return;
                }

                const list = await gapi.client.drive.files.list({
                    spaces: 'appDataFolder',
                    q: "name='language_story_data.json' and trashed=false",
                    fields: 'files(id,name)'
                });

                if (list.result.files?.length) {
                    driveFileId = list.result.files[0].id;
                    localStorage.setItem('languageStoryFileId', driveFileId);
                    const file = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });
                    const raw = file.result ?? file.body ?? '{}';
                    const data = typeof raw === 'string' ? JSON.parse(raw) : raw;
                    loadState(data);
                    showModal('ØªÙ… ØªØ­Ù…ÙŠÙ„ ØªÙ‚Ø¯Ù…Ùƒ Ù…Ù† Google Drive Ø¨Ù†Ø¬Ø§Ø­.');
                } else {
                    loadState({ wordsInProgress: [], masteredWords: [], learningBasket: [], lessonHistory: [] });
                }
            } catch (e) {
                console.error('Drive load error', e);
                if (e.status === 401) tokenClient.requestAccessToken({ prompt: '' });
                showModal('ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Drive Ø§Ù„Ø¢Ù†.');
            }
        }

        async function saveStateToDrive() {
            const tokenObj = gapi.client.getToken();
            if (!isGoogleLoggedIn || !tokenObj?.access_token) {
                showModal('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Google Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }

            const appState = { wordsInProgress, masteredWords, learningBasket, lessonHistory };

            const boundary = '-------314159265358979323846';
            const delimiter = `\r\n--${boundary}\r\n`;
            const closeDelim = `\r\n--${boundary}--`;

            const headers = {
                'Authorization': `Bearer ${tokenObj.access_token}`,
                'Content-Type': `multipart/related; boundary=${boundary}`
            };

            const metadataCreate = {
                name: 'language_story_data.json',
                mimeType: 'application/json',
                parents: ['appDataFolder']
            };

            const metaForCreate = JSON.stringify(metadataCreate);
            const metaForUpdate = JSON.stringify({});
            const dataPart = JSON.stringify(appState);

            const bodyCreate =
                delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                metaForCreate +
                delimiter + 'Content-Type: application/json\r\n\r\n' +
                dataPart + closeDelim;

            const bodyUpdate =
                delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                metaForUpdate +
                delimiter + 'Content-Type: application/json\r\n\r\n' +
                dataPart + closeDelim;

            try {
                let res;
                if (driveFileId) {
                    res = await fetch(
                        `https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`,
                        { method: 'PATCH', headers, body: bodyUpdate }
                    );
                    if (!res.ok) throw new Error(await res.text());
                } else {
                    res = await fetch(
                        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
                        { method: 'POST', headers, body: bodyCreate }
                    );
                    if (!res.ok) throw new Error(await res.text());
                    const created = await res.json();
                    driveFileId = created.id;
                    localStorage.setItem('languageStoryFileId', driveFileId);
                }
                console.log('Saved to Drive.');
            } catch (e) {
                console.error('Drive save error', e);
                showModal('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸ ÙÙŠ Drive Ø§Ù„Ø¢Ù†.');
            }
        }


        function updateProgress() {
            const learnedAndMastered = [...wordsInProgress.map(w => w.word), ...masteredWords];
            const remainingWords = a1Words.filter(word => !learnedAndMastered.includes(word));
            
            allDOMElements.totalWordsEl.textContent = a1Words.length;
            allDOMElements.learnedWordsEl.textContent = learnedAndMastered.length;
            allDOMElements.remainingWordsEl.textContent = remainingWords.length;
        }

        function showScreen(screen) {
            const screens = [
                allDOMElements.homeScreen, allDOMElements.historyScreen, allDOMElements.inProgressScreen,
                allDOMElements.masteredScreen, allDOMElements.basketScreen, allDOMElements.loadingScreen,
                allDOMElements.lessonScreen
            ];
            screens.forEach(s => s.classList.add('hidden'));
            if (screen) screen.classList.remove('hidden');
        }

        function showTab(tabName) {
            uiState.activeTab = tabName; 
            saveUiState();
            showScreen(null);
            const navs = [allDOMElements.navHome, allDOMElements.navHistory, allDOMElements.navLearned, allDOMElements.navMastered, allDOMElements.navBasket];
            navs.forEach(n => n.classList.remove('border-sky-600', 'text-sky-600'));
            
            if (tabName === 'home') {
                (uiState.isLessonActive ? allDOMElements.lessonScreen : allDOMElements.homeScreen).classList.remove('hidden');
                allDOMElements.navHome.classList.add('border-sky-600', 'text-sky-600');
            } else if (tabName === 'history') {
                renderHistory();
                allDOMElements.historyScreen.classList.remove('hidden');
                allDOMElements.navHistory.classList.add('border-sky-600', 'text-sky-600');
            } else if (tabName === 'in-progress') {
                renderInProgressWords();
                allDOMElements.inProgressScreen.classList.remove('hidden');
                allDOMElements.navLearned.classList.add('border-sky-600', 'text-sky-600');
            } else if (tabName === 'mastered') {
                renderMastered();
                allDOMElements.masteredScreen.classList.remove('hidden');
                allDOMElements.navMastered.classList.add('border-sky-600', 'text-sky-600');
            } else if (tabName === 'basket') {
                renderBasket();
                allDOMElements.basketScreen.classList.remove('hidden');
                allDOMElements.navBasket.classList.add('border-sky-600', 'text-sky-600');
            }
        }


        function showModal(content, title = 'ØªÙ†Ø¨ÙŠÙ‡', actions = []) {
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) existingModal.remove();
            
            const actionsHtml = actions.map(action => 
                `<button class="${action.class} px-4 py-2 rounded-md transition">${action.text}</button>`
            ).join('');

            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    <div>${content}</div>
                    <div class="mt-6 flex gap-3 justify-center flex-wrap">
                        ${actionsHtml}
                        <button class="modal-close bg-slate-500 text-white px-6 py-2 rounded-md hover:bg-slate-600">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                </div>`;
            document.body.appendChild(modalOverlay);
            
            modalOverlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-close') || e.target === modalOverlay) {
                    modalOverlay.remove();
                }
                actions.forEach((action) => {
                    if (e.target.classList.contains(action.class.split(' ')[0])) {
                        action.callback();
                        if (!action.keepOpen) {
                           modalOverlay.remove();
                        }
                    }
                });
            });
        }
        
        function selectWordsForLesson() {
            const targetWordCount = 20; 
            
            wordsInProgress.forEach(word => word.lessonCounter++);

            const dueForRepetition = wordsInProgress.filter(item => item.level < 4 && item.lessonCounter >= repetitionIntervals[item.level]);
            
            const repetitionWords = dueForRepetition.slice(0, Math.floor(targetWordCount / 2));
            const newWordsCount = targetWordCount - repetitionWords.length;
            
            const learnedAndMastered = [...wordsInProgress.map(w => w.word), ...masteredWords];
            const remainingWords = a1Words.filter(word => !learnedAndMastered.includes(word));
            const newWords = remainingWords.sort(() => 0.5 - Math.random()).slice(0, newWordsCount);

            return { newWords, repetitionWords };
        }

        async function generateLesson(newWords, repetitionWords, rewrite = false, isRevision = false, storyWordCount = 100, customInstructions = '') {
            if (!apiKey) {
                showModal('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø­ÙØ¸ Ù…ÙØªØ§Ø­ Gemini API Ø£ÙˆÙ„Ø§Ù‹.');
                return;
            }
            uiState.isLessonActive = false; saveUiState();
            showOverlay('Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙŠÙƒØªØ¨ Ù‚ØµØªÙƒâ€¦');

            const lessonWords = [...newWords, ...repetitionWords.map(w => w.word)];
            const repetitionWordsList = repetitionWords.map(w => w.word);
            
            const prompt = `
            SYSTEM: You are a *strict* A1 English teacher for native Arabic speakers.

            PRIORITY:
            (1) Always stay at A1 level in vocabulary and grammar.
            (2) Obey the user's custom instructions exactly (topic, genre, tone, audience). If any part conflicts with A1, adapt it to A1 but keep the user's intent.
            (3) Use only the provided target words; you may add minimal A1 glue words.

            HIGHLIGHTING:
            - NEW words: wrap with <b>...</b>
            - REPETITION words: wrap with <i>...</i>

            STORY SETTINGS:
            - Style: pick ONE of [story, dialogue, narrative], unless user requested a specific one in Arabic instructions: "${customInstructions}".
            - Length: about ${storyWordCount} words.

            OUTPUT: Return ONE valid JSON object, no markdown fences, following exactly this schema:
            {
              "story_type": "story|dialogue|narrative",
              "story_mood": "happy|calm|exciting|neutral",
              "story": "English text with <b>...</b> and <i>...</i> tags only for the target words.",
              "new_words": [{"word":"word","translation":"ØªØ±Ø¬Ù…Ø© Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ø¶Ø­Ø©"}],
              "grammar_focus": {
                "title":"A1 Point (in EN)",
                "explanation":"Ø´Ø±Ø­ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ù…Ø¨Ø³Ø·Ø© + Ø¬Ù…Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",
                "examples":[{"example":"EN example (A1)","translation":"ØªØ±Ø¬Ù…Ø© Ø¹Ø±Ø¨ÙŠØ©"}]
              },
              "useful_structures":[{"structure":"A1 pattern in EN","explanation":"Ø´Ø±Ø­ Ù…Ø®ØªØµØ± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"}],
              "pronunciation_tips":{"title":"A1 Sounds","tips":[{"context":"word/letter","tip":"Ù†ØµÙŠØ­Ø© Ø¹Ø±Ø¨ÙŠØ© Ù…Ø®ØªØµØ±Ø©"}]},
              "exercises":[
                {"type":"fill_in_the_blank","question":"The ___ is big.","answer":"dog"},
                {"type":"multiple_choice","question":"What does the boy have?","options":["a cat","a dog","a car"],"answer":"a dog"},
                {"type":"true_false","question":"The dog is small.","answer":"false"}
              ],
              "applied_instructions":"Explain in Arabic (1-2 lines) how you followed the user's instructions."
            }

            TARGET WORDS (${lessonWords.length}): ${lessonWords.join(', ')}
            NEW words: ${newWords.join(', ') || 'none'}
            REPETITION words: ${repetitionWordsList.join(', ') || 'none'}
            USER INSTRUCTIONS (Arabic): "${customInstructions || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø®Ø§ØµØ©'}"
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                const jsonString = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const lessonData = JSON.parse(jsonString);
                
                if (!rewrite){
                  if (isRevision){
                    repetitionWords.forEach(rep => {
                      const idx = wordsInProgress.findIndex(x=>x.word===rep.word);
                      if(idx>-1){
                        const w = wordsInProgress[idx];
                        w.reviews = (w.reviews||0)+1;
                        w.lessonCounter = 0;
                        if(w.level < 4){ w.level++; }
                        if(w.level>3){
                          masteredWords.push(w.word);
                          wordsInProgress.splice(idx,1);
                        }else{
                          w.lastReviewed = Date.now();
                        }
                      }
                    });
                  }else{
                    newWords.forEach(word=>{
                      if(!wordsInProgress.some(w=>w.word===word)){
                        wordsInProgress.push({ word, level:1, lessonCounter:0, reviews:0, lastReviewed:Date.now() });
                      }
                    });
                    repetitionWords.forEach(repWord=>{
                      const idx = wordsInProgress.findIndex(item=>item.word===repWord.word);
                      if(idx>-1){
                        const w=wordsInProgress[idx];
                        w.level++; w.lessonCounter=0; w.reviews=(w.reviews||0)+1; w.lastReviewed=Date.now();
                        if(w.level>3){ masteredWords.push(w.word); wordsInProgress.splice(idx,1); }
                      }
                    });
                  }

                  lessonData.learnedWords = lessonWords;
                  lessonData.date = new Date().toLocaleString('ar-EG');
                  lessonData.mode = isRevision ? 'revision' : 'new';
                  lessonHistory.unshift(lessonData); if(lessonHistory.length>20) lessonHistory.pop();
                  saveState(); updateProgress();
                }
                
                renderLesson(lessonData, isRevision);
                uiState.isLessonActive = true; saveUiState();
                showScreen(allDOMElements.lessonScreen);

            } catch (error) {
                console.error('Error generating lesson:', error);
                showModal('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯Ø±Ø³. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ù…ÙØªØ§Ø­ API Ø£Ùˆ Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                showScreen(allDOMElements.homeScreen);
            } finally {
                hideOverlay();
            }
        }
        
        function createSection(title, content) {
            return `
                <div class="p-5 bg-white rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4 text-sky-700">${title}</h3>
                    ${content}
                </div>
            `;
        }

        function renderLesson(data, isRevision = false) {
            const lessonTitle = isRevision ? 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Øµ' : '1. Ø§Ù„Ù†Øµ';
            const wordsTitle = isRevision ? 'ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' : '2. Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©';
            const storyText = data.story.replace(/<[^>]*>?/gm, '').replace(/\n/g, ' ');

            const optionsHtml = `
                <div class="max-w-md mx-auto space-y-4 my-6 text-right p-4 border rounded-md bg-slate-50">
                    <h3 class="text-lg font-bold text-center">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ù‚Ø§Ø¯Ù…</h3>
                    <div>
                        <label for="word-count-lesson" class="block text-sm font-medium text-slate-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù‚ØµØ© (ØªÙ‚Ø±ÙŠØ¨ÙŠÙ‹Ø§ 50-500)</label>
                        <input type="number" id="word-count-lesson" value="100" min="50" max="500" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="custom-prompt-lesson" class="block text-sm font-medium text-slate-700">Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ù„Ù‚ØµØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <textarea id="custom-prompt-lesson" rows="2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm" placeholder="Ù…Ø«Ø§Ù„: Ù‚ØµØ© Ø¹Ù† Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙÙŠ Ø­Ø¯ÙŠÙ‚Ø©..."></textarea>
                    </div>
                </div>
            `;

            allDOMElements.lessonScreen.innerHTML = `
                ${createSection(lessonTitle, 
                    `<div id="story-container" class="text-lg/relaxed font-english lesson-content" dir="ltr" data-mood="${data.story_mood || 'neutral'}">${formatStory(data.story, data.story_type)}</div>
                     <div id="story-audio-player" class="mt-4 border-t pt-4"></div>`
                )}
                ${createSection(wordsTitle, createTable(data.new_words, ['Ø§Ù„ÙƒÙ„Ù…Ø©', 'Ø§Ù„Ù…Ø¹Ù†Ù‰'], 'word', 'translation'))}
                ${createSection('3. Ù‚ÙˆØ§Ø¹Ø¯ Ù†Ø³ØªÙÙŠØ¯Ù‡Ø§', renderGrammarSection(data.grammar_focus))}
                ${createSection('4. ØªØ±Ø§ÙƒÙŠØ¨ Ù…ÙÙŠØ¯Ø©', createTable(data.useful_structures, ['Ø§Ù„ØªØ±ÙƒÙŠØ¨', 'Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…'], 'structure', 'explanation'))}
                ${createSection(data.pronunciation_tips.title || '5. Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ù†Ø·Ù‚', renderPronunciationTips(data.pronunciation_tips))}
                ${createSection('6. ØªÙ…Ø§Ø±ÙŠÙ†', renderExercises(data.exercises))}
                <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
                    <button id="rewrite-btn" class="bg-amber-500 text-white px-6 py-2 rounded-md hover:bg-amber-600 transition">Ø£Ø¹Ø¯ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù‚ØµØ© Ø¨Ù†ÙØ³ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
                    <button id="next-lesson-btn" class="bg-sky-600 text-white px-6 py-2 rounded-md hover:bg-sky-700 transition">Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯ Ø¨ÙƒÙ„Ù…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</button>
                </div>
                ${optionsHtml}
            `;
            
            renderStoryAudioPlayer(storyText, data.story_mood || 'neutral');

            document.getElementById('rewrite-btn').addEventListener('click', () => {
                const wordCount = document.getElementById('word-count-lesson').value;
                const customInstructions = document.getElementById('custom-prompt-lesson').value;
                const newW = data.new_words.filter(w => !w.word.includes(' ')).map(w => w.word);
                const repW = []; // Simplified for rewrite
                generateLesson(newW, repW, true, isRevision, wordCount, customInstructions);
            });
            document.getElementById('next-lesson-btn').addEventListener('click', () => {
                const wordCount = document.getElementById('word-count-lesson').value;
                const customInstructions = document.getElementById('custom-prompt-lesson').value;

                if(currentMode === 'revision'){
                    const wordsForRevision = [...wordsInProgress.map(w=>w.word)].sort(()=>0.5-Math.random()).slice(0,20);
                    if(wordsForRevision.length>0){
                    generateLesson([], wordsForRevision.map(w=>({word:w})), false, true, wordCount, customInstructions);
                    }
                }else{
                    const { newWords, repetitionWords } = selectWordsForLesson();
                    if (newWords.length > 0 || repetitionWords.length > 0) {
                    generateLesson(newWords, repetitionWords, false, false, wordCount, customInstructions);
                    }
                }
            });
            if(document.getElementById('check-answers-btn')) {
                document.getElementById('check-answers-btn').addEventListener('click', checkAnswers);
            }
        }

        function renderStoryAudioPlayer(storyText, mood) {
            const playerContainer = document.getElementById('story-audio-player');
            if (!playerContainer) return;

            playerContainer.innerHTML = `
                <div class="flex items-center gap-3">
                    <button id="play-story-btn" class="flex-shrink-0 p-3 bg-sky-600 text-white rounded-full hover:bg-sky-700 transition disabled:bg-slate-400">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        <div id="play-loader" class="hidden w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </button>
                    <button id="refresh-story-audio-btn" class="flex-shrink-0 p-3 bg-slate-500 text-white rounded-full hover:bg-slate-600 transition disabled:bg-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                    </button>
                    <audio id="full-story-audio" class="w-full" controls></audio>
                </div>
                 <div class="mt-2">
                    <input type="text" id="audio-custom-prompt" class="w-full p-2 border rounded-md text-sm" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ù„Ù‚Ø§Ø±Ø¦ (Ù…Ø«Ø§Ù„: Ø§Ù‚Ø±Ø£ Ø¨ØµÙˆØª Ù‡Ø§Ø¯Ø¦)...">
                </div>
            `;
            
            const audioEl = document.getElementById('full-story-audio');
            const playBtn = document.getElementById('play-story-btn');
            const refreshBtn = document.getElementById('refresh-story-audio-btn');
            const playIcon = document.getElementById('play-icon');
            const playLoader = document.getElementById('play-loader');
            
            audioEl.style.display = 'none';

            const generateAndPlayAudio = async () => {
                playIcon.classList.add('hidden');
                playLoader.classList.remove('hidden');
                playBtn.disabled = true;
                refreshBtn.disabled = true;

                const customPrompt = document.getElementById('audio-custom-prompt').value;
                const audioUrl = await speakText(storyText, mood, true, customPrompt);
                
                playIcon.classList.remove('hidden');
                playLoader.classList.add('hidden');
                playBtn.disabled = false;
                refreshBtn.disabled = false;
                
                if (audioUrl) {
                    audioEl.src = audioUrl;
                    audioEl.style.display = 'block';
                    audioEl.play();
                    playBtn.style.display = 'none';
                    refreshBtn.style.display = 'flex';
                }
            };

            playBtn.addEventListener('click', async () => {
                if (audioEl.src) {
                    audioEl.play();
                } else {
                    await generateAndPlayAudio();
                }
            });

            refreshBtn.addEventListener('click', async () => {
                await generateAndPlayAudio();
            });

            audioEl.addEventListener('play', () => {
                playBtn.style.display = 'none';
                refreshBtn.style.display = 'flex';
            });
             audioEl.addEventListener('pause', () => {
                playBtn.style.display = 'flex';
                refreshBtn.style.display = 'flex';
            });
        }
        
        function wrapWordsInSpans(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            const walker = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const textNodes = [];
            while(node = walker.nextNode()) {
                if (node.parentNode.tagName !== 'B' && node.parentNode.tagName !== 'I' && node.parentNode.tagName !== 'SPAN') {
                     textNodes.push(node);
                }
            }

            textNodes.forEach(node => {
                const parent = node.parentNode;
                const words = node.nodeValue.split(/(\s+)/);
                const fragment = document.createDocumentFragment();
                words.forEach(word => {
                    if (word.trim().length > 0) {
                        const span = document.createElement('span');
                        span.className = 'word-span';
                        span.textContent = word;
                        fragment.appendChild(span);
                    } else {
                        fragment.appendChild(document.createTextNode(word));
                    }
                });
                parent.replaceChild(fragment, node);
            });

            return tempDiv.innerHTML;
        }

        function renderGrammarSection(grammar){
          if(!grammar || !grammar.title){ return '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù†Ø­ÙˆÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³.</p>'; }
          let html = `<h4 class="font-bold text-lg mb-2">${grammar.title}</h4>`;
          if(grammar.explanation) html += `<p class="text-slate-700 mb-4">${grammar.explanation}</p>`;
          const ex = Array.isArray(grammar.examples)? grammar.examples : [];
          if(ex.length){ html += createTable(ex, ['Ø§Ù„Ù…Ø«Ø§Ù„ (EN)','Ø§Ù„ØªØ±Ø¬Ù…Ø©'], 'example','translation'); }
          return html;
        }

        function renderPronunciationTips(pronunciation){
          const tips = (pronunciation && Array.isArray(pronunciation.tips))? pronunciation.tips : [];
          return tips.length? createTable(tips, ['Ø§Ù„ÙƒÙ„Ù…Ø©/Ø§Ù„Ø­Ø±Ù','Ø§Ù„Ù†ØµÙŠØ­Ø©'], 'context','tip') : '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØµØ§Ø¦Ø­ Ù†Ø·Ù‚.</p>';
        }

        function formatStory(story, type) {
            const wrappedStory = wrapWordsInSpans(story);
            if (type !== 'dialogue') return wrappedStory;
            
            const speakers = [];
            const lines = wrappedStory.split(/\n|<br>|<br\/>/g);
            return lines.map(line => {
                if (!line.trim()) return '';
                const match = line.match(/^(.*?):/);
                if (match) {
                    let speaker = match[1].replace(/<[^>]*>?/gm, '').trim();
                    let speakerClass = 'dialogue-speaker-1';
                    if (!speakers.includes(speaker)) speakers.push(speaker);
                    if (speakers.indexOf(speaker) % 2 !== 0) speakerClass = 'dialogue-speaker-2';
                    
                    const restOfLine = line.substring(match[0].length);
                    return `<div class="dialogue-line"><span class="${speakerClass}">${speaker}:</span>${restOfLine}</div>`;
                }
                return `<div class="dialogue-line">${line}</div>`;
            }).join('');
        }

        function createTable(data, headers, key1, key2) {
            let tableHTML = '<div class="overflow-x-auto"><table class="table-style">';
            tableHTML += `<thead><tr><th>${headers[0]}</th><th>${headers[1]}</th></tr></thead>`;
            tableHTML += '<tbody>';
            data.forEach(item => {
                tableHTML += `<tr><td>${item[key1]}</td><td>${item[key2]}</td></tr>`;
            });
            tableHTML += '</tbody></table></div>';
            return tableHTML;
        }

        function renderExercises(exercises) {
            if (!exercises || !Array.isArray(exercises)) {
                return '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ…Ø§Ø±ÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³.</p>';
            }
            let html = '<div class="space-y-4">';
            exercises.forEach((ex, index) => {
                const cleanQuestion = ex.question ? ex.question.replace(/\*\*/g, '') : 'Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…ØªÙˆÙØ±';
                html += `<div class="exercise p-3 border-r-4 border-slate-200" data-answer="${ex.answer}">`;
                if (ex.type === 'fill_in_the_blank') {
                    html += `<p class="font-english" dir="ltr">${index + 1}. ${cleanQuestion.replace('___', '<input type="text" class="exercise-input border-b-2 bg-transparent text-center w-24 mx-1">')}</p>`;
                } else if (ex.type === 'multiple_choice') {
                    html += `<p class="font-english" dir="ltr">${index + 1}. ${cleanQuestion}</p>
                             <div class="flex flex-wrap gap-2 mt-2" dir="ltr">
                                ${(ex.options && Array.isArray(ex.options)) ? ex.options.map(opt => `<label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer"><input type="radio" name="ex${index}" value="${opt}" class="exercise-input"> ${opt}</label>`).join('') : '<p class="text-red-500">Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªÙˆÙÙŠØ± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„.</p>'}
                             </div>`;
                } else if (ex.type === 'true_false') {
                     html += `<p class="font-english" dir="ltr">${index + 1}. ${cleanQuestion}</p>
                              <div class="flex gap-4 mt-2" dir="ltr">
                                 <label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer"><input type="radio" name="ex${index}" value="true" class="exercise-input">True</label>
                                 <label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer"><input type="radio" name="ex${index}" value="false" class="exercise-input">False</label>
                              </div>`;
                }
                html += '</div>';
            });
            html += '</div><button id="check-answers-btn" class="mt-6 bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>';
            html += '<div id="results-container" class="mt-4"></div>';
            return html;
        }

        function checkAnswers() {
            const exercises = document.querySelectorAll('.exercise');
            let correctCount = 0;
            exercises.forEach(ex => {
                const correctAnswer = ex.dataset.answer ? ex.dataset.answer.toLowerCase() : '';
                const inputs = ex.querySelectorAll('.exercise-input');
                let userAnswer = '';
                ex.classList.remove('border-green-400', 'border-red-400');

                if (inputs.length > 0 && inputs[0].type === 'text') {
                    userAnswer = inputs[0].value.trim().toLowerCase();
                    if (userAnswer === correctAnswer) {
                        ex.classList.add('border-green-400'); correctCount++;
                    } else { ex.classList.add('border-red-400'); }
                } else {
                    let answered = false;
                    inputs.forEach(input => {
                        if (input.checked) {
                            answered = true;
                            userAnswer = input.value.toLowerCase();
                            if (userAnswer === correctAnswer) {
                                ex.classList.add('border-green-400'); correctCount++;
                            } else { ex.classList.add('border-red-400'); }
                        }
                    });
                    if (!answered) ex.classList.add('border-red-400');
                }
            });
            document.getElementById('results-container').innerHTML = `<p class="font-bold">Ù†ØªÙŠØ¬ØªÙƒ: ${correctCount} Ù…Ù† ${exercises.length} Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©.</p>`;
        }

        function handleNewLesson() {
            currentMode = 'home'; saveUiState();
            const wordCount = document.getElementById('word-count-home').value;
            const customInstructions = document.getElementById('custom-prompt-home').value;
            const { newWords, repetitionWords } = selectWordsForLesson();

            if (newWords.length > 0 || repetitionWords.length > 0) {
                generateLesson(newWords, repetitionWords, false, false, wordCount, customInstructions);
            } else {
                uiState.isLessonActive = false; saveUiState();
                showScreen(allDOMElements.homeScreen);
            }
        }

        function handleRevisionLesson(){
          currentMode = 'revision'; saveUiState();
          const wordCount = document.getElementById('word-count-review').value;
          const customInstructions = document.getElementById('custom-prompt-review').value;
          const wordsForRevision = [...wordsInProgress.map(w=>w.word)].sort(()=>0.5-Math.random()).slice(0,20);
          if(wordsForRevision.length>0){
            generateLesson([], wordsForRevision.map(w=>({word:w})), false, true, wordCount, customInstructions);
          }
        }

        function renderHistory() {
            if (lessonHistory.length === 0) {
                allDOMElements.historyList.innerHTML = '<p class="text-center text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯.</p>';
                return;
            }
            allDOMElements.historyList.innerHTML = lessonHistory.map((lesson, index) => `
                <div class="p-3 border rounded-md hover:bg-slate-100 cursor-pointer" onclick="viewHistoryItem(${index})">
                    <p class="font-bold">Ø¯Ø±Ø³ Ø¨ØªØ§Ø±ÙŠØ®: ${lesson.date}</p>
                    <p class="text-sm text-slate-600 font-english" dir="ltr">${lesson.learnedWords.slice(0, 5).join(', ')}...</p>
                </div>
            `).join('');
        }

        function viewHistoryItem(index) {
            const lessonData = lessonHistory[index];
            renderLesson(lessonData, lessonData.mode === 'revision');
            uiState.isLessonActive = true; saveUiState();
            showScreen(allDOMElements.lessonScreen);
        }

        function handleInteractionEnd(event) {
            setTimeout(() => {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();

                if (isDragging && selectedText.length > 0) {
                    if (event.type === 'touchend') event.preventDefault();
                    showSelectionPopup(selection);
                }
                else if (!isDragging && event.target.closest('.word-span, b, i')) {
                    const target = event.target.closest('.word-span, b, i');
                    const text = target.textContent.trim().replace(/[.,!?;:]/g, '');
                    if (text) {
                        showWordTranslationModal(text);
                    }
                }
                isDragging = false;
            }, 10);
        }

        function showSelectionPopup(selection){
          const selectedText = selection.toString().trim();
          if(!selectedText) return;
          const range = selection.getRangeAt(0);
          const rect = range.getBoundingClientRect();
          const popup = allDOMElements.selectionPopup;
          popup.classList.remove('hidden');
          const pw = popup.offsetWidth, ph = popup.offsetHeight;
          let left = rect.left + window.scrollX + (rect.width/2) - (pw/2);
          let top  = rect.top  + window.scrollY - ph - 10;
          left = Math.max(8, Math.min(left, window.scrollX + window.innerWidth - pw - 8));
          top  = Math.max(8, Math.min(top , window.scrollY + window.innerHeight - ph - 8));
          popup.style.left = `${left}px`; popup.style.top = `${top}px`;

          const mood = document.getElementById('story-container')?.dataset.mood || 'neutral';
          popup.querySelector('#popup-translate').onclick = () => { getTranslation(selectedText); popup.classList.add('hidden'); };
          popup.querySelector('#popup-speak').onclick     = () => { speakText(selectedText, mood); };
          popup.querySelector('#popup-phonetics').onclick = () => { getPhonetics(selectedText).then(res=>res&&showModal(`<p class="text-xl font-bold text-sky-600">${res}</p>`, `Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù€: <span class="font-english text-xl">${selectedText}</span>`)); popup.classList.add('hidden'); };
          popup.querySelector('#popup-save').onclick      = () => { saveToBasket(selectedText); popup.classList.add('hidden'); };
        }

        async function showWordTranslationModal(text) {
            const mood = document.getElementById('story-container')?.dataset.mood || 'neutral';
            const modalTitle = `<span class="font-english text-3xl">${text}</span>`;
            
            showModal('<div class="flex justify-center"><div class="loader"></div></div>', modalTitle, []);

            const translation = await getTranslation(text, false);

            if (!translation) {
                showModal('<p>Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ±Ø¬Ù…Ø©.</p>', modalTitle);
                return;
            }

            const modalContent = `<p class="text-2xl font-bold text-sky-600">${translation}</p>`;
            
            const actions = [
                {
                    text: 'ğŸ”Š Ù†Ø·Ù‚',
                    class: 'action-speak-btn bg-green-500 text-white',
                    callback: () => speakText(text, mood),
                    keepOpen: true
                },
                {
                    text: 'ğŸ—£ï¸ ÙƒØªØ§Ø¨Ø© ØµÙˆØªÙŠØ©',
                    class: 'action-phonetics-btn bg-purple-500 text-white',
                    callback: async () => {
                        const phonetics = await getPhonetics(text);
                        if (phonetics) {
                            showModal(`<p class="text-xl font-bold text-sky-600">${phonetics}</p>`, `Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù€: <span class="font-english text-xl">${text}</span>`);
                        }
                    }
                },
                {
                    text: 'ğŸ’¾ Ø­ÙØ¸ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                    class: 'action-save-btn bg-amber-500 text-white',
                    callback: () => saveToBasket(text, translation)
                }
            ];
            showModal(modalContent, modalTitle, actions);
        }
        
        async function getTranslation(text, showModalWithSaveButton = true) {
            const prompt = `Translate the English text "${text}" into a simple, direct Arabic equivalent. Provide only the translation, nothing else.`;
            const translation = await callGeminiForSimpleText(prompt);
            if (translation && showModalWithSaveButton) {
                const actions = [{
                    text: 'ğŸ’¾ Ø­ÙØ¸ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                    class: 'save-to-basket-btn bg-green-500 text-white hover:bg-green-600',
                    callback: () => saveToBasket(text, translation)
                }];
                showModal(`<p class="text-xl font-bold text-sky-600">${translation}</p>`, `ØªØ±Ø¬Ù…Ø©: <span class="font-english">${text}</span>`, actions);
            }
            return translation;
        }

        async function getPhonetics(text) {
            const prompt = `Ø§ÙƒØªØ¨ Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø© Ø£Ùˆ Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø­Ø±ÙˆÙ Ø¹Ø±Ø¨ÙŠØ© Ù…Ø¨Ø³Ø·Ø©. ÙÙ‚Ø· Ø£Ø¹Ø· Ø§Ù„Ù†Ø·Ù‚ ÙˆÙ„Ø§ Ø´ÙŠØ¡ Ø¢Ø®Ø±. Ø§Ù„Ù†Øµ Ù‡Ùˆ: "${text}"`;
            return await callGeminiForSimpleText(prompt);
        }
        
        async function callGeminiForSimpleText(prompt) {
            if (!apiKey) { showModal('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø­ÙØ¸ Ù…ÙØªØ§Ø­ Gemini API Ø£ÙˆÙ„Ø§Ù‹.'); return null; }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error('API Error');
                const result = await response.json();
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                console.error('Error with simple text generation:', error);
                showModal('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ.');
                return null;
            }
        }

        async function saveToBasket(englishText, arabicText) {
            let translation = arabicText;
            if (!translation) {
                translation = await getTranslation(englishText, false);
            }
            if (!translation) {
                showModal('Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØ±Ø¬Ù…Ø© Ù„Ù„Ø­ÙØ¸.');
                return;
            }

            const isAlreadySaved = learningBasket.some(item => item.en.toLowerCase() === englishText.toLowerCase());
            if (isAlreadySaved) {
                showModal(`"${englishText}" <br><br> Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø³Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.`);
                return;
            }
            
            learningBasket.unshift({ id: Date.now(), en: englishText, ar: translation });
            saveState();
            showModal(`"${englishText}" <br><br> ØªÙ… Ø­ÙØ¸Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø³Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©!`);
        }

        function renderInProgressWords(){
          const container = allDOMElements.inProgressScreen;

          const g0 = wordsInProgress.filter(w=>(w.reviews||0)<=1).sort((a,b)=>a.word.localeCompare(b.word));
          const g1 = wordsInProgress.filter(w=>(w.reviews||0)===2).sort((a,b)=>a.word.localeCompare(b.word));
          const g2 = wordsInProgress.filter(w=>(w.reviews||0)>=3).sort((a,b)=>a.word.localeCompare(b.word));

          const groupBlock = (title,list)=>`
            <div class="mb-6">
              <h4 class="font-bold mb-2">${title} (${list.length})</h4>
              ${list.length? `<div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                ${list.map(item=>`
                  <div class="p-3 border rounded-md text-center cursor-pointer hover:bg-sky-50 flex flex-col justify-between" onclick="handleInProgressWordClick('${item.word}')">
                    <span class="font-english font-bold">${item.word}</span>
                    <span class="text-xs text-slate-500 mt-1">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${item.level} â€¢ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª ${(item.reviews||0)}</span>
                  </div>`).join('')}
              </div>` : '<p class="text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª.</p>'}
            </div>
          `;

          const optionsHtml = `
            <div class="max-w-md mx-auto space-y-4 mb-6 text-right p-4 border rounded-md bg-slate-50">
              <h3 class="text-lg font-bold text-center">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3>
              <div>
                <label class="block text-sm font-medium text-slate-700">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù‚ØµØ© (50â€“500)</label>
                <input type="number" id="word-count-review" value="100" min="50" max="500" class="mt-1 block w-full p-2 border rounded-md">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ù„Ù‚ØµØ©</label>
                <textarea id="custom-prompt-review" rows="2" class="mt-1 block w-full p-2 border rounded-md" placeholder="Ù…Ø«Ø§Ù„: Ø­ÙˆØ§Ø± Ù‚ØµÙŠØ± ÙÙŠ Ù…Ø·Ø¹Ù…â€¦"></textarea>
              </div>
              <button id="review-lesson-btn" class="w-full bg-sky-600 text-white px-6 py-2 rounded-md hover:bg-sky-700">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù‚ØµØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
            </div>`;

          container.innerHTML = createSection('ÙƒÙ„Ù…Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ¹Ù„Ù…',
            optionsHtml +
            groupBlock('Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (0â€“1 Ù…Ø±Ø§Ø¬Ø¹Ø©)', g0) +
            groupBlock('Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆØ³Ø· (2 Ù…Ø±Ø§Ø¬Ø¹Ø©)', g1) +
            groupBlock('Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…ØªÙ‚Ø¯Ù…Ø© (3+ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª)', g2)
          );

          document.getElementById('review-lesson-btn').addEventListener('click', handleRevisionLesson);
        }
        
        async function handleInProgressWordClick(word) {
            const actions = [
                {
                    text: 'âœ… Ø£ØªÙ‚Ù†ØªÙ‡Ø§',
                    class: 'master-word-btn bg-green-500 text-white hover:bg-green-600',
                    callback: () => masterWord(word)
                },
                 {
                    text: 'ğŸ’¾ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                    class: 'add-to-basket-btn bg-amber-500 text-white hover:bg-amber-600',
                    callback: async () => {
                        const translation = await getTranslation(word, false);
                        if (translation) saveToBasket(word, translation);
                    }
                }
            ];
            showModal(`Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙØ¹Ù„ Ø¨Ø§Ù„ÙƒÙ„Ù…Ø©ØŸ`, `<span class="font-english text-3xl">${word}</span>`, actions);
        }

        function masterWord(wordToMaster) {
            const wordIndex = wordsInProgress.findIndex(item => item.word === wordToMaster);
            if (wordIndex > -1) {
                masteredWords.push(wordsInProgress[wordIndex].word);
                wordsInProgress.splice(wordIndex, 1);
                saveState();
                updateProgress();
                renderInProgressWords();
                showModal(`ØªÙ… Ù†Ù‚Ù„ "${wordToMaster}" Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ØªÙ‚Ù†Ø©.`, 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­');
            }
        }

        function renderBasket(page=1){
          basketPage = page;
          const basketContainer = allDOMElements.basketScreen;
          if(learningBasket.length===0){
            basketContainer.innerHTML = createSection('Ø³Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','<p class="text-center text-slate-500">Ø³Ù„Ù‘ØªÙƒ ÙØ§Ø±ØºØ©.</p>');
            return;
          }
          const start = (basketPage-1)*BASKET_PAGE_SIZE;
          const items = learningBasket.slice(start, start+BASKET_PAGE_SIZE);

          const pager = (()=> {
            const pages = Math.ceil(learningBasket.length/BASKET_PAGE_SIZE);
            if(pages<=1) return '';
            let btns=''; for(let i=1;i<=pages;i++){
              btns += `<button class="px-3 py-1 rounded ${i===basketPage?'bg-sky-600 text-white':'bg-slate-200'}" onclick="renderBasket(${i})">${i}</button>`;
            }
            return `<div class="flex gap-2 justify-center mt-4">${btns}</div>`;
          })();

          const flashcardsHtml = `
            <div class="flashcard-container">
              ${items.map(item=>`
                <div class="flashcard" onclick="this.classList.toggle('is-flipped')">
                  <div class="flashcard-inner">
                    <div class="flashcard-front font-english">${item.en}</div>
                    <div class="flashcard-back">${item.ar}</div>
                  </div>
                </div>`).join('')}
            </div>${pager}
          `;

          const matchingHtml = renderMatchingExercise(items) + pager;

          basketContainer.innerHTML = `
            ${createSection('1. Ø¨Ø·Ø§Ù‚Ø§Øª ØªØ¹Ù„ÙŠÙ…ÙŠØ©', '<p class="mb-2 text-sm text-slate-500">Ø§Ù‚Ù„Ø¨ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØ±Ø¬Ù…Ø©.</p>'+flashcardsHtml)}
            ${createSection('2. ØªÙ…Ø±ÙŠÙ† Ø§Ù„ØªÙˆØµÙŠÙ„', '<p class="mb-2 text-sm text-slate-500">ØµÙ„ÙÙ‘ Ø§Ù„ÙƒÙ„Ù…Ø© Ø¨ØªØ±Ø¬Ù…ØªÙ‡Ø§.</p>'+matchingHtml)}
          `;
          setupMatchingExerciseListeners();
        }
        function renderMatchingExercise(items){
          const shuffledEn = [...items].sort(()=>0.5-Math.random());
          const shuffledAr = [...items].sort(()=>0.5-Math.random());
          const enHtml = shuffledEn.map(i=>`<div class="match-item font-english" data-id="${i.id}">${i.en}</div>`).join('');
          const arHtml = shuffledAr.map(i=>`<div class="match-item" data-id="${i.id}">${i.ar}</div>`).join('');
          return `
            <div class="matching-container select-none">
              <div class="matching-column">${enHtml}</div>
              <div class="matching-column">${arHtml}</div>
            </div>
            <p id="match-result" class="text-center font-bold mt-3"></p>
          `;
        }
        function setupMatchingExerciseListeners(){
          let selectedEn=null, selectedAr=null, correct=0, total=document.querySelectorAll('.matching-column .match-item.font-english').length;
          document.querySelectorAll('.match-item').forEach(item=>{
            item.addEventListener('click',()=>{
              const isEn = item.classList.contains('font-english');
              if(isEn){ if(selectedEn) selectedEn.classList.remove('selected'); selectedEn=item; item.classList.add('selected'); }
              else    { if(selectedAr) selectedAr.classList.remove('selected'); selectedAr=item; item.classList.add('selected'); }
              if(selectedEn && selectedAr){
                if(selectedEn.dataset.id===selectedAr.dataset.id){
                  selectedEn.classList.add('correct'); selectedAr.classList.add('correct'); correct++;
                  document.getElementById('match-result').textContent = `ØµØ­ÙŠØ­ (${correct}/${total})`;
                  selectedEn.style.pointerEvents='none'; selectedAr.style.pointerEvents='none';
                }else{
                  selectedEn.classList.add('incorrect'); selectedAr.classList.add('incorrect');
                  setTimeout(()=>{ selectedEn.classList.remove('incorrect','selected'); selectedAr.classList.remove('incorrect','selected'); }, 800);
                }
                selectedEn=null; selectedAr=null;
              }
            });
          });
        }

        function chooseVoice(customPrompt){
          const female = ['Leda','Aoede','Callirrhoe','Autonoe','Umbriel'];
          const male   = ['Zephyr','Charon','Fenrir','Orus','Iapetus','Algenib'];
          const child  = ['Kore','Despina','Erinome'];
          const p = (customPrompt||'').toLowerCase();
          if(/Ø§Ù…Ø±Ø£Ø©|Ø£Ù†Ø«Ù‰|female/.test(p)) return female[Math.floor(Math.random()*female.length)];
          if(/Ø±Ø¬Ù„|Ø°ÙƒØ±|male/.test(p)) return male[Math.floor(Math.random()*male.length)];
          if(/Ø·ÙÙ„|Ø·ÙÙ„Ø©|child|kid/.test(p)) return child[Math.floor(Math.random()*child.length)];
          return ttsVoices[Math.floor(Math.random()*ttsVoices.length)];
        }
        async function speakText(text, mood='neutral', returnUrlOnly=false, customPrompt=''){
          if(!apiKey || !audioContext){ showModal('Ù…ÙŠØ²Ø© Ø§Ù„ØµÙˆØª ØºÙŠØ± Ù…ØªØ§Ø­Ø©.'); return null; }
          const cleanText = text.replace(/<[^>]*>?/gm,'').trim();
          const voiceName = chooseVoice(customPrompt);

          const looksDialogue = /.+:\s/.test(cleanText);
          const sampleRate = 24000;

          async function synthOnce(t, vName){
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`,{
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({
                model:"gemini-2.5-flash-preview-tts",
                contents:[{ parts:[{ text: t }] }],
                generationConfig:{
                  responseModalities:["AUDIO"],
                  speechConfig:{ voiceConfig:{ prebuiltVoiceConfig:{ voiceName: vName } } }
                }
              })
            });
            if(!response.ok) throw new Error('TTS error '+response.status);
            const result = await response.json();
            const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
            const pcm = new Int16Array(base64ToArrayBuffer(audioData));
            return pcm;
          }

          try{
            let finalPcm;
            if(looksDialogue){
              const lines = cleanText.split(/\n+/).filter(Boolean);
              let buffers=[];
              for(let i=0;i<lines.length;i++){
                const line = lines[i].replace(/^[^:]+:\s*/, '');
                const altVoice = (i%2===0)? voiceName : chooseVoice(customPrompt+' male');
                const pcm = await synthOnce(line, altVoice);
                buffers.push(pcm);
              }
              let total = buffers.reduce((s,b)=>s+b.length,0);
              finalPcm = new Int16Array(total);
              let off=0; for(const b of buffers){ finalPcm.set(b, off); off+=b.length; }
            }else{
              finalPcm = await synthOnce(cleanText, voiceName);
            }
            const wavBlob = pcmToWav(finalPcm, sampleRate);
            const url = URL.createObjectURL(wavBlob);
            if(returnUrlOnly) return url; else { new Audio(url).play(); return null; }
          }catch(e){ console.error(e); showModal('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª.'); return null; }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const view = new DataView(new ArrayBuffer(44 + pcmData.length * 2));
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + pcmData.length * 2, true);
            writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true);
            view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true);
            view.setUint16(34, 16, true); writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length * 2, true);
            for (let i = 0; i < pcmData.length; i++) { view.setInt16(44 + i * 2, pcmData[i], true); }
            return new Blob([view], { type: 'audio/wav' });
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function handleSaveApiKey() {
            const key = allDOMElements.apiKeyInput.value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('geminiApiKey', key);
                allDOMElements.mainContent.classList.remove('hidden');
            } else {
                showModal('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ API ØµØ­ÙŠØ­.');
            }
        }
        
        function handleResetProgress() {
            if (window.confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„ ØªÙ‚Ø¯Ù…ÙƒØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.')) {
                wordsInProgress = [];
                masteredWords = [];
                learningBasket = [];
                lessonHistory = [];
                uiState.isLessonActive = false; saveUiState();
                saveState();
                updateProgress();
                showTab('home');
            }
        }
        
        function renderMastered(){
          const list = masteredWords.slice().sort((a,b)=>a.localeCompare(b));
          allDOMElements.masteredScreen.innerHTML = createSection('Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ØªÙ‚Ù†Ø©',
            list.length? `<div class="grid grid-cols-2 md:grid-cols-4 gap-3">
              ${list.map(w=>`<div class="p-3 border rounded-md text-center font-english">${w}</div>`).join('')}
            </div>` : '<p class="text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ù…ØªÙ‚Ù†Ø© Ø¨Ø¹Ø¯.</p>');
        }
        
        function showOverlay(txt='Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦'){
          const o=document.getElementById('overlay'); document.getElementById('overlay-text').textContent=txt;
          o.classList.remove('hidden'); o.classList.add('flex');
        }
        function hideOverlay(){ const o=document.getElementById('overlay'); o.classList.add('hidden'); o.classList.remove('flex'); }

        initialize();
    </script>
</body>
</html>
