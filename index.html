<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قصتي اللغوية - تعلم الإنجليزية بالذكاء الاصطناعي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Google Identity Services Scripts -->
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()" async defer></script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .font-english {
            font-family: 'Inter', sans-serif;
        }
        .lesson-content b { /* New Words */
            background-color: #fef08a; padding: 2px 4px; border-radius: 4px;
            font-weight: 700; color: #713f12; cursor: pointer;
        }
        .lesson-content i { /* Repetition Words */
            background-color: #dbeafe; padding: 2px 4px; border-radius: 4px;
            font-weight: 700; color: #1e3a8a; cursor: pointer; font-style: normal;
        }
        .lesson-content .word-span { cursor: pointer; }
        .lesson-content .word-span:hover { background-color: #e0f2fe; }
        .dialogue-line { margin-bottom: 0.5rem; }
        .dialogue-speaker-1 { color: #1d4ed8; font-weight: bold; }
        .dialogue-speaker-2 { color: #be185d; font-weight: bold; }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #selection-popup button {
            background: none; border: none; cursor: pointer; font-size: 14px; font-family: 'Cairo', sans-serif;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 8px;
            max-width: 90%; width: 450px; text-align: center;
            max-height: 85vh; overflow: auto;
        }
        .table-style { width: 100%; border-collapse: collapse; }
        .table-style th, .table-style td {
            border: 1px solid #e2e8f0; padding: 12px; text-align: right;
        }
        .table-style th { background-color: #f1f5f9; }
        .table-style td:first-child {
            font-weight: bold; font-family: 'Inter', sans-serif; direction: ltr;
        }
        /* Flashcard styles */
        .flashcard-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .flashcard {
            background-color: white; border: 1px solid #e2e8f0; border-radius: 8px;
            height: 100px; perspective: 1000px; cursor: pointer;
        }
        .flashcard-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s; transform-style: preserve-3d;
        }
        .flashcard.is-flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back {
            position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden;
            backface-visibility: hidden; display: flex; align-items: center; justify-content: center;
            padding: 1rem; font-size: 1.1rem;
        }
        .flashcard-back { transform: rotateY(180deg); background-color: #f0f9ff; }
        /* Matching exercise styles */
        .matching-container { display: flex; justify-content: space-around; gap: 1rem; }
        .matching-column { display: flex; flex-direction: column; gap: 0.5rem; flex: 1; }
        .match-item {
            padding: 0.75rem; border: 2px solid #cbd5e1; border-radius: 6px;
            cursor: pointer; transition: all 0.2s;
        }
        .match-item.selected { border-color: #3b82f6; background-color: #dbeafe; }
        .match-item.correct { border-color: #22c55e; background-color: #dcfce7; pointer-events: none; }
        .match-item.incorrect { border-color: #ef4444; background-color: #fee2e2; }
        .sentence-chunk { display: inline; }
        .sent-trans-btn {
            display: inline-block;
            background: none; border: none; cursor: pointer;
            opacity: 0.2; transition: opacity 0.2s;
            padding: 0 5px;
        }
        .sentence-chunk:hover .sent-trans-btn { opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100">
    <button id="toggle-dark" class="absolute top-4 left-4 px-3 py-1 border rounded dark:border-slate-600">🌙</button>

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-sky-600 mb-2">قصتي اللغوية</h1>
            <p class="text-lg text-slate-600 dark:text-slate-300">تعلم مفردات الإنجليزية من خلال قصص يصنعها الذكاء الاصطناعي</p>
             <div id="auth-container" class="mt-4 flex items-center justify-center">
                <button id="signin-btn" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition">تسجيل الدخول مع Google لحفظ التقدم</button>
                <button id="signout-btn" class="hidden bg-red-500 text-white px-6 py-2 rounded-md hover:bg-red-600 transition">تسجيل الخروج</button>
                <span id="user-chip" class="hidden inline-flex items-center gap-2 bg-white border rounded-full px-3 py-1 ml-2 dark:bg-slate-800 dark:border-slate-700">
                    <img id="user-pic" src="" alt="" class="w-6 h-6 rounded-full">
                    <span id="user-name" class="text-sm"></span>
                </span>
            </div>
        </header>

        <div id="dashboard" class="hidden mb-6 p-4 bg-white rounded-lg shadow-md flex-wrap gap-2 justify-center dark:bg-slate-800 dark:border dark:border-slate-700">
            <button id="btn-reset" class="px-4 py-2 bg-red-500 text-white rounded">إعادة ضبط كامل</button>
            <button id="btn-export" class="px-4 py-2 bg-sky-600 text-white rounded">تصدير البيانات (JSON)</button>
            <label class="px-4 py-2 bg-amber-500 text-white rounded cursor-pointer">
              استيراد بيانات
              <input type="file" id="import-file" accept="application/json" class="hidden">
            </label>
        </div>

        <div id="api-key-section" class="hidden mb-6 p-4 bg-white rounded-lg shadow-md dark:bg-slate-800 dark:border dark:border-slate-700">
            <div class="flex items-center gap-3 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500"><path d="M14 9a2 2 0 0 1-2 2H6l-4 4V4c0-1.1.9-2 2-2h8a2 2 0 0 1 2 2v5Z"/><path d="M18 9h2a2 2 0 0 1 2 2v10l-4-4H8a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h2"/><path d="M22 12h-2"/><path d="M18 12h-2"/></svg>
                <h2 class="text-xl font-bold">مفتاح Gemini API</h2>
            </div>
            <p class="text-slate-600 mb-3 text-sm dark:text-slate-300">لاستخدام التطبيق، يرجى إدخال مفتاح Gemini API الخاص بك. يمكنك الحصول عليه من <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-sky-600 hover:underline">Google AI Studio</a>.</p>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="password" id="api-key-input" class="flex-grow p-2 border rounded-md font-english dark:bg-slate-700 dark:border-slate-600">
                <button id="save-api-key-btn" class="bg-sky-600 text-white px-6 py-2 rounded-md hover:bg-sky-700 transition">حفظ والبدء</button>
            </div>
        </div>

        <main id="main-content" class="hidden">
            
            <div class="mb-6 flex justify-center border-b flex-wrap dark:border-slate-700">
                <button id="nav-home" class="px-4 py-3 text-lg font-bold border-b-4 border-sky-600 text-sky-600">الرئيسية</button>
                <button id="nav-history" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">سجل الدروس</button>
                <button id="nav-in-progress" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">كلمات قيد التعلم</button>
                <button id="nav-basket" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">سلة المراجعة</button>
            </div>
            
            <div id="stats-section" class="mb-6 p-4 bg-white rounded-lg shadow-md flex flex-wrap justify-around text-center dark:bg-slate-800 dark:border dark:border-slate-700">
                <div><p class="text-slate-500 dark:text-slate-400">إجمالي الكلمات</p><p id="total-words" class="text-2xl font-bold text-sky-600 font-english">0</p></div>
                <div><p class="text-slate-500 dark:text-slate-400">كلمات تعلمتها</p><p id="learned-words" class="text-2xl font-bold text-green-600 font-english">0</p></div>
                <div><p class="text-slate-500 dark:text-slate-400">الكلمات المتبقية</p><p id="remaining-words" class="text-2xl font-bold text-amber-600 font-english">0</p></div>
            </div>

            <div id="home-screen" class="text-center p-8 bg-white rounded-lg shadow-md dark:bg-slate-800 dark:border dark:border-slate-700">
                <h2 class="text-2xl font-bold mb-4">هل أنت مستعد لدرس جديد؟</h2>
                <p class="text-slate-600 mb-6 dark:text-slate-300">حدد عدد الكلمات وأضف تعليمات خاصة للقصة إذا أردت.</p>
                
                <div class="max-w-md mx-auto space-y-4 mb-6 text-right">
                    <div>
                        <label for="word-count-home" class="block text-sm font-medium text-slate-700 dark:text-slate-200">إجمالي كلمات القصة (تقريبيًا 50-500)</label>
                        <input type="number" id="word-count-home" value="100" min="50" max="500" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:border-slate-600">
                    </div>
                    <div>
                        <label for="custom-prompt-home" class="block text-sm font-medium text-slate-700 dark:text-slate-200">اكتب تعليمات للقصة (اختياري)</label>
                        <textarea id="custom-prompt-home" rows="2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500 dark:bg-slate-700 dark:border-slate-600" placeholder="مثال: قصة عن حيوانات في حديقة، للأطفال..."></textarea>
                    </div>
                </div>

                <button id="new-lesson-btn" class="bg-green-600 text-white px-8 py-3 rounded-lg text-lg font-bold hover:bg-green-700 transition transform hover:scale-105">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        أنشئ قصة جديدة
                    </span>
                </button>
            </div>

            <div id="history-screen" class="hidden p-4 bg-white rounded-lg shadow-md space-y-3 dark:bg-slate-800 dark:border dark:border-slate-700">
                <h2 class="text-2xl font-bold mb-4 text-center">الدروس السابقة</h2>
                <div id="history-list" class="space-y-2"></div>
            </div>

            <div id="in-progress-screen" class="hidden p-4 bg-white rounded-lg shadow-md dark:bg-slate-800 dark:border dark:border-slate-700"></div>
            
            <div id="basket-screen" class="hidden space-y-6"></div>

            <div id="loading-screen" class="hidden text-center p-8 bg-white rounded-lg shadow-md dark:bg-slate-800 dark:border dark:border-slate-700">
                <div class="flex justify-center mb-4"><div class="loader"></div></div>
                <p class="text-slate-600 text-lg dark:text-slate-300">الذكاء الاصطناعي يكتب قصتك... يرجى الانتظار.</p>
            </div>

            <div id="lesson-screen" class="hidden space-y-6"></div>
        </main>

        <div id="selection-popup" class="hidden absolute bg-white border rounded-lg shadow-xl p-1 flex gap-1 z-50 dark:bg-slate-700 dark:border-slate-600">
            <button id="popup-translate" title="ترجمة" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-md">🌐</button>
            <button id="popup-speak" title="نطق" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-md">🔊</button>
            <button id="popup-phonetics" title="كتابة صوتية" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-md">🗣️</button>
            <button id="popup-save" title="حفظ للسلة" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-600 rounded-md">💾</button>
        </div>
    </div>
    
    <div id="global-loader" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-[2000]">
        <div class="bg-white p-6 rounded-lg shadow text-center dark:bg-slate-800">
            <div class="loader mx-auto mb-3"></div>
            <div id="global-loader-text" class="font-bold">جاري تحميل البيانات…</div>
        </div>
    </div>

    <script>
        // --- Google Drive Integration START ---
        const CLIENT_ID = '484856738377-c2ng08gfa9sstobj8ilji7vduk47qa3p.apps.googleusercontent.com';
        const SCOPES = [
            'https://www.googleapis.com/auth/drive.appdata',
            'openid',
            'email',
            'profile',
        ].join(' ');
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let driveFileId = localStorage.getItem('languageStoryFileId') || null;
        let isGoogleLoggedIn = false;

        async function fetchAndShowUser() {
            try {
                const tok = gapi.client.getToken();
                if (!tok?.access_token) return;
                const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                headers: { Authorization: `Bearer ${tok.access_token}` }
                });
                if (!res.ok) return;
                const u = await res.json();
                document.getElementById('user-name').textContent = u.name || u.email || 'User';
                document.getElementById('user-pic').src = u.picture || '';
                document.getElementById('user-chip').classList.remove('hidden');
            } catch {}
        }

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({});
            gapiInited = true;
            checkAuthInit();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID.trim(),
                scope: SCOPES,
                callback: gapiTokenCallback,
            });
            gisInited = true;
            checkAuthInit();
        }
        
        function checkAuthInit() {
            if (gapiInited && gisInited) {
                document.getElementById('signin-btn').disabled = false;
                attemptSilentLogin();
            }
        }

        async function gapiTokenCallback(resp) {
            if (resp.error) {
                console.error(resp);
                showModal('حدث خطأ أثناء تسجيل الدخول. يرجى المحاولة مرة أخرى.');
                return;
            }
            gapi.client.setToken({ access_token: resp.access_token });
            isGoogleLoggedIn = true;
            localStorage.setItem('googleLogged', '1');
            updateUiForLoginStatus();
            await fetchAndShowUser();
            await loadStateFromDrive();
        }

        function handleAuthClick() {
            if (gapiInited && gisInited) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                showModal('خدمات Google لم يتم تحميلها بعد، يرجى الانتظار قليلاً.');
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken('');
                    isGoogleLoggedIn = false;
                    localStorage.removeItem('googleLogged');
                    document.getElementById('user-chip').classList.add('hidden');
                    driveFileId = null;
                    localStorage.removeItem('languageStoryFileId');
                    updateUiForLoginStatus();
                    loadState({ wordsInProgress: [], masteredWords: [], learningBasket: [], lessonHistory: [] });
                    showModal('تم تسجيل الخروج بنجاح.');
                });
            }
        }
        // --- Google Drive Integration END ---


        const a1Words = ['a', 'an', 'about', 'above', 'across', 'action', 'activity', 'actor', 'actress', 'add', 'address', 'adult', 'advice', 'afraid', 'after', 'afternoon', 'again', 'age', 'ago', 'agree', 'air', 'airport', 'all', 'also', 'always', 'amazing', 'and', 'angry', 'animal', 'another', 'answer', 'any', 'anyone', 'anything', 'apartment', 'apple', 'April', 'area', 'arm', 'around', 'arrive', 'art', 'article', 'artist', 'as', 'ask', 'at', 'August', 'aunt', 'autumn', 'away', 'baby', 'back', 'bad', 'bag', 'ball', 'banana', 'band', 'bank', 'bath', 'bathroom', 'be', 'beach', 'beautiful', 'because', 'become', 'bed', 'bedroom', 'beer', 'before', 'begin', 'beginning', 'behind', 'believe', 'below', 'best', 'better', 'between', 'bicycle', 'big', 'bike', 'bill', 'bird', 'birthday', 'black', 'blog', 'blonde', 'blue', 'boat', 'body', 'book', 'boot', 'bored', 'boring', 'born', 'both', 'bottle', 'box', 'boy', 'boyfriend', 'bread', 'break', 'breakfast', 'bring', 'brother', 'brown', 'build', 'building', 'bus', 'business', 'busy', 'but', 'butter', 'buy', 'by', 'bye', 'cafe', 'cake', 'call', 'camera', 'can', 'cannot', 'capital', 'car', 'card', 'career', 'carrot', 'carry', 'cat', 'CD', 'cent', 'centre', 'century', 'chair', 'change', 'chart', 'cheap', 'check', 'cheese', 'chicken', 'child', 'chocolate', 'choose', 'cinema', 'city', 'class', 'classroom', 'clean', 'climb', 'clock', 'close', 'clothes', 'club', 'coat', 'coffee', 'cold', 'college', 'colour', 'come', 'common', 'company', 'compare', 'complete', 'computer', 'concert', 'conversation', 'cook', 'cooking', 'cool', 'correct', 'cost', 'could', 'country', 'course', 'cousin', 'cow', 'cream', 'create', 'culture', 'cup', 'customer', 'cut', 'dad', 'dance', 'dancer', 'dancing', 'dangerous', 'dark', 'date', 'daughter', 'day', 'dear', 'December', 'decide', 'delicious', 'describe', 'description', 'design', 'desk', 'detail', 'dialogue', 'dictionary', 'die', 'diet', 'difference', 'different', 'difficult', 'dinner', 'dirty', 'discuss', 'dish', 'do', 'doctor', 'dog', 'dollar', 'door', 'down', 'downstairs', 'draw', 'dress', 'drink', 'drive', 'driver', 'during', 'DVD', 'each', 'ear', 'early', 'east', 'easy', 'eat', 'egg', 'eight', 'eighteen', 'eighty', 'elephant', 'eleven', 'else', 'email', 'end', 'enjoy', 'enough', 'euro', 'even', 'evening', 'event', 'ever', 'every', 'everybody', 'everyone', 'everything', 'exam', 'example', 'excited', 'exciting', 'exercise', 'expensive', 'explain', 'extra', 'eye', 'face', 'fact', 'fall', 'false', 'family', 'famous', 'fantastic', 'far', 'farm', 'farmer', 'fast', 'fat', 'father', 'favourite', 'February', 'feel', 'feeling', 'festival', 'few', 'fifteen', 'fifth', 'fifty', 'fill', 'film', 'final', 'find', 'fine', 'finish', 'fire', 'first', 'fish', 'five', 'flat', 'flight', 'floor', 'flower', 'fly', 'follow', 'food', 'foot', 'football', 'for', 'forget', 'form', 'forty', 'four', 'fourteen', 'fourth', 'free', 'Friday', 'friend', 'friendly', 'from', 'front', 'fruit', 'full', 'fun', 'funny', 'future', 'game', 'garden', 'geography', 'get', 'girl', 'girlfriend', 'give', 'glass', 'go', 'good', 'goodbye', 'grandfather', 'grandmother', 'grandparent', 'great', 'green', 'grey', 'group', 'grow', 'guess', 'guitar', 'gym', 'hair', 'half', 'hand', 'happen', 'happy', 'hard', 'hat', 'hate', 'have', 'have to', 'he', 'head', 'health', 'healthy', 'hear', 'hello', 'help', 'her', 'here', 'hey', 'hi', 'high', 'him', 'his', 'history', 'hobby', 'holiday', 'home', 'homework', 'hope', 'horse', 'hospital', 'hot', 'hotel', 'hour', 'house', 'how', 'however', 'hundred', 'hungry', 'husband', 'I', 'ice', 'ice cream', 'idea', 'if', 'imagine', 'important', 'improve', 'in', 'include', 'information', 'interest', 'interested', 'interesting', 'internet', 'interview', 'into', 'introduce', 'island', 'it', 'its', 'January', 'jeans', 'job', 'join', 'journey', 'juice', 'July', 'June', 'just', 'keep', 'key', 'kilometre', 'kind', 'kitchen', 'know', 'land', 'language', 'large', 'last', 'late', 'later', 'laugh', 'learn', 'leave', 'left', 'leg', 'lesson', 'let', 'letter', 'library', 'lie', 'life', 'light', 'like', 'line', 'lion', 'list', 'listen', 'little', 'live', 'local', 'long', 'look', 'lose', 'lot', 'love', 'lunch', 'machine', 'magazine', 'main', 'make', 'man', 'many', 'map', 'March', 'market', 'married', 'match', 'May', 'maybe', 'me', 'meal', 'mean', 'meaning', 'meat', 'meet', 'meeting', 'member', 'menu', 'message', 'metre', 'midnight', 'mile', 'milk', 'million', 'minute', 'miss', 'mistake', 'model', 'modern', 'moment', 'Monday', 'money', 'month', 'more', 'morning', 'most', 'mother', 'mountain', 'mouse', 'mouth', 'move', 'movie', 'much', 'mum', 'museum', 'music', 'must', 'my', 'name', 'natural', 'near', 'need', 'negative', 'neighbour', 'never', 'new', 'news', 'newspaper', 'next', 'next to', 'nice', 'night', 'nine', 'nineteen', 'ninety', 'no', 'no one', 'nobody', 'north', 'nose', 'not', 'note', 'nothing', 'November', 'now', 'number', 'nurse', 'object', "o'clock", 'October', 'of', 'off', 'office', 'often', 'oh', 'OK', 'old', 'on', 'once', 'one', 'onion', 'online', 'only', 'open', 'opinion', 'opposite', 'or', 'orange', 'order', 'other', 'our', 'out', 'outside', 'over', 'own', 'page', 'paint', 'painting', 'pair', 'paper', 'paragraph', 'parent', 'park', 'part', 'partner', 'party', 'passport', 'past', 'pay', 'pen', 'pencil', 'people', 'pepper', 'perfect', 'period', 'person', 'personal', 'phone', 'photo', 'photograph', 'phrase', 'piano', 'picture', 'piece', 'pig', 'pink', 'place', 'plan', 'plane', 'plant', 'play', 'player', 'please', 'point', 'police', 'policeman', 'pool', 'poor', 'popular', 'positive', 'possible', 'post', 'potato', 'pound', 'practice', 'practise', 'prefer', 'prepare', 'present', 'pretty', 'price', 'probably', 'problem', 'product', 'programme', 'project', 'purple', 'put', 'quarter', 'question', 'quick', 'quickly', 'quiet', 'quite', 'radio', 'rain', 'read', 'reader', 'reading', 'ready', 'real', 'really', 'reason', 'red', 'relax', 'remember', 'repeat', 'report', 'restaurant', 'result', 'return', 'rice', 'rich', 'ride', 'right', 'river', 'road', 'room', 'routine', 'rule', 'run', 'sad', 'salad', 'salt', 'same', 'sandwich', 'Saturday', 'say', 'school', 'science', 'scientist', 'sea', 'second', 'section', 'see', 'sell', 'send', 'sentence', 'September', 'seven', 'seventeen', 'seventy', 'share', 'she', 'sheep', 'shirt', 'shoe', 'shop', 'shopping', 'short', 'should', 'show', 'shower', 'sick', 'similar', 'sing', 'singer', 'sister', 'sit', 'situation', 'six', 'sixteen', 'sixty', 'skill', 'skirt', 'sleep', 'slow', 'small', 'snake', 'snow', 'so', 'some', 'somebody', 'someone', 'something', 'sometimes', 'son', 'song', 'soon', 'sorry', 'sound', 'soup', 'south', 'space', 'speak', 'special', 'spell', 'spelling', 'spend', 'sport', 'spring', 'stand', 'star', 'start', 'statement', 'station', 'stay', 'still', 'stop', 'story', 'street', 'strong', 'student', 'study', 'style', 'subject', 'success', 'sugar', 'summer', 'sun', 'Sunday', 'supermarket', 'sure', 'sweater', 'swim', 'swimming', 'table', 'take', 'talk', 'tall', 'taxi', 'tea', 'teach', 'teacher', 'team', 'teenager', 'telephone', 'television', 'tell', 'ten', 'tennis', 'terrible', 'test', 'text', 'than', 'thank', 'thanks', 'that', 'the', 'theatre', 'their', 'them', 'then', 'there', 'they', 'thing', 'think', 'third', 'thirsty', 'thirteen', 'thirty', 'this', 'thousand', 'three', 'through', 'Thursday', 'ticket', 'time', 'tired', 'title', 'to', 'today', 'together', 'toilet', 'tomato', 'tomorrow', 'tonight', 'too', 'tooth', 'topic', 'tourist', 'town', 'traffic', 'train', 'travel', 'tree', 'trip', 'trousers', 'true', 'try', 'T-shirt', 'Tuesday', 'turn', 'TV', 'twelve', 'twenty', 'twice', 'two', 'type', 'umbrella', 'uncle', 'under', 'understand', 'university', 'until', 'up', 'upstairs', 'us', 'use', 'useful', 'usually', 'vacation', 'vegetable', 'very', 'video', 'village', 'visit', 'visitor', 'wait', 'waiter', 'wake', 'walk', 'wall', 'want', 'warm', 'wash', 'watch', 'water', 'way', 'we', 'wear', 'weather', 'website', 'Wednesday', 'week', 'weekend', 'welcome', 'well', 'west', 'what', 'when', 'where', 'which', 'white', 'who', 'why', 'wife', 'will', 'win', 'window', 'wine', 'winter', 'with', 'without', 'woman', 'wonderful', 'word', 'work', 'worker', 'world', 'worry', 'would', 'write', 'writer', 'writing', 'wrong', 'year', 'yellow', 'yes', 'yesterday', 'you', 'young', 'your', 'yourself'];
        const ttsVoices = ['Zephyr', 'Puck', 'Charon', 'Kore', 'Fenrir', 'Leda', 'Orus', 'Aoede', 'Callirrhoe', 'Autonoe', 'Enceladus', 'Iapetus', 'Umbriel', 'Algieba', 'Despina', 'Erinome', 'Algenib', 'Rasalgethi', 'Laomedeia', 'Achernar', 'Alnilam', 'Schedar', 'Gacrux', 'Pulcherrima', 'Achird', 'Zubenelgenubi', 'Vindemiatrix', 'Sadachbia', 'Sadaltager', 'Sulafat'];
        const repetitionIntervals = { 1: 5, 2: 15, 3: 20 };
        const REVIEW_BATCH_SIZE = 8;

        const allDOMElements = {
            authContainer: document.getElementById('auth-container'),
            signinBtn: document.getElementById('signin-btn'),
            signoutBtn: document.getElementById('signout-btn'),
            apiKeySection: document.getElementById('api-key-section'),
            apiKeyInput: document.getElementById('api-key-input'),
            saveApiKeyBtn: document.getElementById('save-api-key-btn'),
            mainContent: document.getElementById('main-content'),
            navHome: document.getElementById('nav-home'),
            navHistory: document.getElementById('nav-history'),
            navLearned: document.getElementById('nav-in-progress'),
            navBasket: document.getElementById('nav-basket'),
            homeScreen: document.getElementById('home-screen'),
            historyScreen: document.getElementById('history-screen'),
            inProgressScreen: document.getElementById('in-progress-screen'),
            basketScreen: document.getElementById('basket-screen'),
            historyList: document.getElementById('history-list'),
            statsSection: document.getElementById('stats-section'),
            totalWordsEl: document.getElementById('total-words'),
            learnedWordsEl: document.getElementById('learned-words'),
            remainingWordsEl: document.getElementById('remaining-words'),
            newLessonBtn: document.getElementById('new-lesson-btn'),
            resetProgressBtn: document.getElementById('reset-progress-btn'),
            loadingScreen: document.getElementById('loading-screen'),
            lessonScreen: document.getElementById('lesson-screen'),
            selectionPopup: document.getElementById('selection-popup'),
        };

        let apiKey = '';
        let wordsInProgress = [];
        let masteredWords = [];
        let learningBasket = [];
        let lessonHistory = [];
        let audioContext;
        let isLessonActive = false;
        let isDragging = false;
        let reviewBatchIndex = 0;
        
        function initialize() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error("Web Audio API is not supported in this browser");
                showModal("متصفحك لا يدعم تشغيل الصوتيات، قد لا تعمل بعض الميزات.");
            }
            
            allDOMElements.signinBtn.disabled = true;
            updateUiForLoginStatus();
            setupEventListeners();
            restoreUiState();
            applyTheme();
        }

        function setupEventListeners() {
            document.getElementById('toggle-dark').onclick = ()=>{
                const v = localStorage.getItem('theme') === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', v); applyTheme();
            };
            document.getElementById('btn-reset').onclick = ()=> handleResetProgress();
            document.getElementById('btn-export').onclick = ()=>{
                const blob = new Blob([JSON.stringify({wordsInProgress, masteredWords, learningBasket, lessonHistory}, null, 2)], {type:'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href=url; a.download='language_story_backup.json'; a.click();
                URL.revokeObjectURL(url);
            };
            document.getElementById('import-file').onchange = async (e)=>{
                const file = e.target.files[0]; if(!file) return;
                try {
                    const data = JSON.parse(await file.text());
                    loadState(data); await saveState(); updateProgress(); showModal('تم الاستيراد بنجاح','نجاح');
                } catch { showModal('ملف غير صالح','خطأ'); }
            };

            allDOMElements.signinBtn.addEventListener('click', handleAuthClick);
            allDOMElements.signoutBtn.addEventListener('click', handleSignoutClick);
            allDOMElements.saveApiKeyBtn.addEventListener('click', handleSaveApiKey);
            allDOMElements.apiKeyInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSaveApiKey(); });
            allDOMElements.newLessonBtn.addEventListener('click', handleNewLesson);
            
            ['navHome','navHistory','navLearned','navBasket'].forEach(id=>{
                allDOMElements[id].addEventListener('click', ()=> setTimeout(saveUiState, 0));
            });

            allDOMElements.navHome.addEventListener('click', () => showTab('home'));
            allDOMElements.navHistory.addEventListener('click', () => showTab('history'));
            allDOMElements.navLearned.addEventListener('click', () => showTab('in-progress'));
            allDOMElements.navBasket.addEventListener('click', () => showTab('basket'));

            const lessonArea = allDOMElements.lessonScreen;
            lessonArea.addEventListener('mousedown', () => { isDragging = false; });
            lessonArea.addEventListener('mousemove', () => { isDragging = true; });
            lessonArea.addEventListener('mouseup', handleInteractionEnd);
            lessonArea.addEventListener('touchstart', () => { isDragging = false; }, { passive: true });
            lessonArea.addEventListener('touchmove', () => { isDragging = true; }, { passive: true });
            lessonArea.addEventListener('touchend', handleInteractionEnd);
        }
        
        function applyTheme(){
            const dark = localStorage.getItem('theme') === 'dark';
            document.documentElement.classList.toggle('dark', dark);
        }

        function attemptSilentLogin() {
            if (localStorage.getItem('googleLogged') === '1' && gisInited) {
                try { tokenClient.requestAccessToken({ prompt: '' }); } catch {}
            }
        }

        function saveUiState() {
            const state = {
                tab: document.querySelector('#nav-home.text-sky-600') ? 'home' :
                    document.querySelector('#nav-history.text-sky-600') ? 'history' :
                    document.querySelector('#nav-in-progress.text-sky-600') ? 'in-progress' :
                    'basket',
                isLessonActive,
                scroll: window.scrollY
            };
            localStorage.setItem('uiState', JSON.stringify(state));
        }

        function restoreUiState() {
            try {
                const s = JSON.parse(localStorage.getItem('uiState') || '{}');
                const lastJson = localStorage.getItem('lastLessonData');
                const lastIsRev = JSON.parse(localStorage.getItem('lastIsRevision') || 'false');
                if (s?.isLessonActive && lastJson) {
                    const data = JSON.parse(lastJson);
                    renderLesson(data, lastIsRev);
                    isLessonActive = true;
                    showScreen(allDOMElements.lessonScreen);
                    requestAnimationFrame(()=> window.scrollTo(0, s.scroll || 0));
                    return;
                }
                showTab(s?.tab || 'home');
                requestAnimationFrame(()=> window.scrollTo(0, s?.scroll || 0));
            } catch {}
        }


        function updateUiForLoginStatus() {
            // لوحة البيانات: تظهر دائمًا (تفيد حتى بدون جوجل)
            const dash = document.getElementById('dashboard');
            dash.classList.remove('hidden'); dash.classList.add('flex');

            // أزرار جوجل
            if (isGoogleLoggedIn) {
                allDOMElements.signinBtn.classList.add('hidden');
                allDOMElements.signoutBtn.classList.remove('hidden');
                document.getElementById('user-chip').classList.remove('hidden');
            } else {
                allDOMElements.signinBtn.classList.remove('hidden');
                allDOMElements.signoutBtn.classList.add('hidden');
                document.getElementById('user-chip').classList.add('hidden');
            }

            // قسم مفتاح الـAPI: يظهر دائمًا
            allDOMElements.apiKeySection.classList.remove('hidden');

            // المحتوى الرئيسي يُظهر عند وجود مفتاح API، بغضّ النظر عن جوجل
            if (apiKey) allDOMElements.mainContent.classList.remove('hidden');
            else allDOMElements.mainContent.classList.add('hidden');
        }
        
        function loadState(data) {
            apiKey = localStorage.getItem('geminiApiKey') || '';
            wordsInProgress = data.wordsInProgress || [];
            masteredWords = data.masteredWords || [];
            learningBasket = data.learningBasket || [];
            lessonHistory = data.lessonHistory || [];
            
            if (apiKey) {
                 allDOMElements.apiKeyInput.value = apiKey;
            }
            
            updateProgress();
            updateUiForLoginStatus();
        }

        function saveState() {
             return saveStateToDrive();
        }
        
        function showGlobalLoader(msg='جاري التحميل…'){ 
            document.getElementById('global-loader-text').textContent = msg;
            document.getElementById('global-loader').classList.add('flex');
            document.getElementById('global-loader').classList.remove('hidden'); 
        }
        function hideGlobalLoader(){ 
            document.getElementById('global-loader').classList.remove('flex');
            document.getElementById('global-loader').classList.add('hidden'); 
        }

        async function loadStateFromDrive() {
            if (!gapiInited) await initializeGapiClient();
            await gapi.client.load('https://www.googleapis.com/discovery/v1/apis/drive/v3/rest');
            showGlobalLoader('جاري تحميل تقدمك من Google Drive…');

            try {
                if (driveFileId) {
                    const file = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });
                    const raw = file.result ?? file.body ?? '{}';
                    const data = typeof raw === 'string' ? JSON.parse(raw) : raw;
                    loadState(data);
                    
                    hideGlobalLoader();
                    return;
                }

                const list = await gapi.client.drive.files.list({
                    spaces: 'appDataFolder',
                    q: "name='language_story_data.json' and trashed=false",
                    fields: 'files(id,name)'
                });

                if (list.result.files?.length) {
                    driveFileId = list.result.files[0].id;
                    localStorage.setItem('languageStoryFileId', driveFileId);
                    const file = await gapi.client.drive.files.get({ fileId: driveFileId, alt: 'media' });
                    const raw = file.result ?? file.body ?? '{}';
                    const data = typeof raw === 'string' ? JSON.parse(raw) : raw;
                    loadState(data);
                } else {
                    loadState({ wordsInProgress: [], masteredWords: [], learningBasket: [], lessonHistory: [] });
                }
            } catch (e) {
                console.error('Drive load error', e);
                if (e.status === 401) tokenClient.requestAccessToken({ prompt: '' });
                showModal('تعذر التحميل من Drive الآن.');
            }
            hideGlobalLoader();
        }

        async function saveStateToDrive() {
            const tokenObj = gapi.client.getToken();
            if (!isGoogleLoggedIn || !tokenObj?.access_token) {
                // Do not show modal, just fail silently or save locally if that's the desired fallback.
                return;
            }
            showGlobalLoader('جاري حفظ تقدمك في Google Drive…');

            const appState = { wordsInProgress, masteredWords, learningBasket, lessonHistory };

            const boundary = '-------314159265358979323846';
            const delimiter = `\r\n--${boundary}\r\n`;
            const closeDelim = `\r\n--${boundary}--`;

            const headers = {
                'Authorization': `Bearer ${tokenObj.access_token}`,
                'Content-Type': `multipart/related; boundary=${boundary}`
            };

            const metadataCreate = {
                name: 'language_story_data.json',
                mimeType: 'application/json',
                parents: ['appDataFolder']
            };

            const metaForCreate = JSON.stringify(metadataCreate);
            const metaForUpdate = JSON.stringify({});
            const dataPart = JSON.stringify(appState);

            const bodyCreate =
                delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                metaForCreate +
                delimiter + 'Content-Type: application/json\r\n\r\n' +
                dataPart + closeDelim;

            const bodyUpdate =
                delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                metaForUpdate +
                delimiter + 'Content-Type: application/json\r\n\r\n' +
                dataPart + closeDelim;

            try {
                let res;
                if (driveFileId) {
                    res = await fetch(
                        `https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`,
                        { method: 'PATCH', headers, body: bodyUpdate }
                    );
                    if (!res.ok) throw new Error(await res.text());
                } else {
                    res = await fetch(
                        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
                        { method: 'POST', headers, body: bodyCreate }
                    );
                    if (!res.ok) throw new Error(await res.text());
                    const created = await res.json();
                    driveFileId = created.id;
                    localStorage.setItem('languageStoryFileId', driveFileId);
                }
                console.log('Saved to Drive.');
            } catch (e) {
                console.error('Drive save error', e);
                showModal('تعذّر الحفظ في Drive الآن.');
            }
            hideGlobalLoader();
        }


        function updateProgress() {
            const learnedAndMastered = [...wordsInProgress.map(w => w.word), ...masteredWords];
            const remainingWords = a1Words.filter(word => !learnedAndMastered.includes(word));
            
            allDOMElements.totalWordsEl.textContent = a1Words.length;
            allDOMElements.learnedWordsEl.textContent = learnedAndMastered.length;
            allDOMElements.remainingWordsEl.textContent = remainingWords.length;
        }

        function showScreen(screen) {
            allDOMElements.homeScreen.classList.add('hidden');
            allDOMElements.historyScreen.classList.add('hidden');
            allDOMElements.inProgressScreen.classList.add('hidden');
            allDOMElements.basketScreen.classList.add('hidden');
            allDOMElements.loadingScreen.classList.add('hidden');
            allDOMElements.lessonScreen.classList.add('hidden');
            if (screen) screen.classList.remove('hidden');
        }

        function showTab(tabName) {
            showScreen(null);
            const navs = [allDOMElements.navHome, allDOMElements.navHistory, allDOMElements.navLearned, allDOMElements.navBasket];
            navs.forEach(nav => nav.classList.remove('border-sky-600', 'text-sky-600'));

            if (tabName === 'home') {
                if (isLessonActive) {
                    allDOMElements.lessonScreen.classList.remove('hidden');
                } else {
                    allDOMElements.homeScreen.classList.remove('hidden');
                }
                allDOMElements.navHome.classList.add('border-sky-600', 'text-sky-600');
            } else if (tabName === 'history') {
                renderHistory();
                allDOMElements.historyScreen.classList.remove('hidden');
                allDOMElements.navHistory.classList.add('border-sky-600', 'text-sky-600');
            } else if (tabName === 'in-progress') {
                renderInProgressWords();
                allDOMElements.inProgressScreen.classList.remove('hidden');
                allDOMElements.navLearned.classList.add('border-sky-600', 'text-sky-600');
            } else if (tabName === 'basket') {
                renderBasket();
                allDOMElements.basketScreen.classList.remove('hidden');
                allDOMElements.navBasket.classList.add('border-sky-600', 'text-sky-600');
            }
        }

        function showModal(content, title = 'تنبيه', actions = []) {
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) existingModal.remove();
            
            const actionsHtml = actions.map(action => 
                `<button class="${action.class} px-4 py-2 rounded-md transition">${action.text}</button>`
            ).join('');

            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    <div>${content}</div>
                    <div class="mt-6 flex gap-3 justify-center flex-wrap">
                        ${actionsHtml}
                        <button class="modal-close bg-slate-500 text-white px-6 py-2 rounded-md hover:bg-slate-600">إغلاق</button>
                    </div>
                </div>`;
            document.body.appendChild(modalOverlay);
            
            modalOverlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-close') || e.target === modalOverlay) {
                    modalOverlay.remove();
                }
                actions.forEach((action) => {
                    if (e.target.classList.contains(action.class.split(' ')[0])) {
                        action.callback();
                        if (!action.keepOpen) {
                           modalOverlay.remove();
                        }
                    }
                });
            });
        }
        
        function selectWordsForLesson() {
            const targetWordCount = 20; 
            
            wordsInProgress.forEach(word => word.lessonCounter++);

            const dueForRepetition = wordsInProgress.filter(item => item.level < 4 && item.lessonCounter >= repetitionIntervals[item.level]);
            
            const repetitionWords = dueForRepetition.slice(0, Math.floor(targetWordCount / 2));
            const newWordsCount = targetWordCount - repetitionWords.length;
            
            const learnedAndMastered = [...wordsInProgress.map(w => w.word), ...masteredWords];
            const remainingWords = a1Words.filter(word => !learnedAndMastered.includes(word));
            const newWords = remainingWords.sort(() => 0.5 - Math.random()).slice(0, newWordsCount);

            return { newWords, repetitionWords };
        }

        async function generateLesson(newWords, repetitionWords, rewrite = false, isRevision = false, storyWordCount = 100, customInstructions = '') {
            if (!apiKey) {
                showModal('الرجاء حفظ مفتاح Gemini API أولاً.');
                return;
            }
            isLessonActive = false;
            showScreen(allDOMElements.loadingScreen);

            const lessonWords = [...newWords, ...repetitionWords.map(w => w.word)];
            const repetitionWordsList = repetitionWords.map(w => w.word);
            
            const prompt = `
            SYSTEM: You are an expert ESL teacher for absolute beginners (A1). You must strictly keep vocabulary and grammar at A1. 
            If user requirements ask for complex ideas, KEEP the topic/setting but DOWNGRADE language to A1. Mention how you adapted them in "instructions_applied".

            VOCAB TO USE (must all appear exactly once or more): ${lessonWords.join(', ')}.
            NEW WORDS: ${newWords.join(', ')}  → wrap with <b>…</b>
            REPETITION: ${repetitionWordsList.join(', ')} → wrap with <i>…</i>

            USER_REQUIREMENTS: """${customInstructions || 'none'}"""

            OUTPUT: one valid JSON object, no code fences:
            {
            "story_type": "story|dialogue|narrative",
            "story_mood": "happy|calm|exciting|neutral",
            "story": "… with <b> and <i> tags … (~${storyWordCount} words, strictly A1)",
            "new_words": [{"word":"…","translation":"…"}],
            "grammar_focus": {
                "title":"Present Simple at A1",
                "explanation":"Use subject + base verb. Add -s with he/she/it.",
                "examples":[{"example":"I go to school.","translation":"أنا أذهب إلى المدرسة."},{"example":"He goes home.","translation":"هو يذهب إلى البيت."}]
            },
            "useful_structures": [{"structure":"I like …","explanation":"للتعبير عن الإعجاب"}, {"structure":"There is/are","explanation":"للوصف البسيط"}],
            "pronunciation_tips": {"title":"A1 Sounds","tips":[{"context":"th","tip":"ينطق مثل ذ/ث"},{"context":"-ed","tip":"قد تُنطق t أو d"}]},
            "exercises":[
            {"type":"fill_in_the_blank","question":"I ___ to school.","answer":"go"},
            {"type":"multiple_choice","question":"What does he have?","options":["a car","a cat","a cup"],"answer":"a cat"},
            {"type":"true_false","question":"They is happy.","answer":"false"}
            ],
            "instructions_applied":"How the user instructions were followed while staying A1."
            }

            CONSTRAINTS:
            - Only A1 vocabulary and A1 grammar (present simple; 'can' for ability).
            - No markdown outside JSON strings. No code fences.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                const jsonString = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const lessonData = JSON.parse(jsonString);
                localStorage.setItem('lastLessonData', JSON.stringify(lessonData));
                localStorage.setItem('lastIsRevision', JSON.stringify(isRevision));
                
                lessonData.learnedWords = lessonWords;
                lessonData.date = new Date().toLocaleString('ar-EG');
                
                if (isRevision) {
                    const revised = repetitionWordsList.length ? repetitionWordsList : (lessonWords || []);
                    revised.forEach(w=>{
                        const i = wordsInProgress.findIndex(x=> x.word === w);
                        if (i>-1) {
                            const item = wordsInProgress[i];
                            item.level = Math.min(4, (item.level||1)+1);
                            item.lessonCounter = 0;
                            item.reviewCount = (item.reviewCount || 0) + 1;
                            item.lastReviewedAt = Date.now();
                            if (item.level > 3) {
                                masteredWords.push(item.word);
                                wordsInProgress.splice(i,1);
                            }
                        }
                    });
                } else {
                    newWords.forEach(word => {
                        if (!wordsInProgress.some(w=>w.word===word) && !masteredWords.includes(word)) {
                            wordsInProgress.push({ word, level: 1, lessonCounter: 0, reviewCount: 0, lastReviewedAt: null });
                        }
                    });
                    repetitionWords.forEach(repWord => {
                        const idx = wordsInProgress.findIndex(item => item.word === repWord.word);
                        if (idx > -1) {
                            const it = wordsInProgress[idx];
                            it.level = Math.min(4, (it.level||1)+1);
                            it.lessonCounter = 0;
                            it.reviewCount = (it.reviewCount || 0) + 1;
                            if (it.level > 3) {
                                masteredWords.push(it.word);
                                wordsInProgress.splice(idx, 1);
                            }
                        }
                    });
                }

                lessonHistory.unshift(lessonData);
                if (lessonHistory.length > 50) lessonHistory.pop();
                
                saveState();
                updateProgress();
                renderLesson(lessonData, isRevision);
                isLessonActive = true;
                showScreen(allDOMElements.lessonScreen);
                setTimeout(saveUiState, 0);

            } catch (error) {
                console.error('Error generating lesson:', error);
                showModal('حدث خطأ أثناء إنشاء الدرس. تأكد من صحة مفتاح API أو جرب مرة أخرى.');
                showScreen(allDOMElements.homeScreen);
            }
        }
        
        function createSection(title, content) {
            return `
                <div class="p-5 bg-white rounded-lg shadow-md dark:bg-slate-800 dark:border dark:border-slate-700">
                    <h3 class="text-xl font-bold mb-4 text-sky-700">${title}</h3>
                    ${content}
                </div>
            `;
        }

        function addSentenceTranslateButtons(container) {
            const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);
            const textNodes = [];
            let n; while ((n = walker.nextNode())) textNodes.push(n);

            textNodes.forEach(node => {
                const text = node.nodeValue;
                const parts = text.split(/([.!?])(\s+)/);
                if (parts.length < 2) return;

                const frag = document.createDocumentFragment();
                for (let i=0; i<parts.length; i+=3) {
                const s = (parts[i] || '').trim();
                const punc = parts[i+1] || '';
                const space = parts[i+2] || '';
                if (!s) { frag.appendChild(document.createTextNode(punc+space)); continue; }

                const span = document.createElement('span');
                span.className = 'sentence-chunk';
                span.appendChild(document.createTextNode(s + punc + ' '));

                const btn = document.createElement('button');
                btn.className = 'sent-trans-btn text-sky-600';
                btn.title = 'ترجمة الجملة';
                btn.textContent = '🌐';
                btn.addEventListener('click', async (e)=>{
                    e.stopPropagation();
                    const tr = await getTranslation(s, false);
                    if (tr) showModal(`<div class="font-english">${s}</div><hr class="my-2"><div class="text-xl">${tr}</div>`, 'ترجمة الجملة');
                });

                span.appendChild(btn);
                frag.appendChild(span);
                if (space) frag.appendChild(document.createTextNode(space));
                }
                node.parentNode.replaceChild(frag, node);
            });
        }

        function renderLesson(data, isRevision = false) {
            const lessonTitle = isRevision ? 'مراجعة النص' : '1. النص';
            const wordsTitle = isRevision ? 'كلمات للمراجعة' : '2. الكلمات الجديدة';
            
            const optionsHtml = `
                <div class="max-w-md mx-auto space-y-4 my-6 text-right p-4 border rounded-md bg-slate-50 dark:bg-slate-800 dark:border-slate-700">
                    <h3 class="text-lg font-bold text-center">خيارات الدرس القادم</h3>
                    <div>
                        <label for="word-count-lesson" class="block text-sm font-medium text-slate-700 dark:text-slate-200">إجمالي كلمات القصة (تقريبيًا 50-500)</label>
                        <input type="number" id="word-count-lesson" value="100" min="50" max="500" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm dark:bg-slate-700 dark:border-slate-600">
                    </div>
                    <div>
                        <label for="custom-prompt-lesson" class="block text-sm font-medium text-slate-700 dark:text-slate-200">اكتب تعليمات للقصة (اختياري)</label>
                        <textarea id="custom-prompt-lesson" rows="2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm dark:bg-slate-700 dark:border-slate-600" placeholder="مثال: قصة عن حيوانات في حديقة..."></textarea>
                    </div>
                </div>
            `;

            allDOMElements.lessonScreen.innerHTML = `
                ${createSection(lessonTitle, 
                    `<div id="story-container" class="text-lg/relaxed font-english lesson-content" dir="ltr" data-story-type="${data.story_type}" data-mood="${data.story_mood || 'neutral'}">${formatStory(data.story, data.story_type)}</div>
                     <div id="story-audio-player" class="mt-4 border-t pt-4 dark:border-slate-700"></div>`
                )}
                ${createSection(wordsTitle, createTable(data.new_words, ['الكلمة', 'المعنى'], 'word', 'translation'))}
                ${createSection('3. قواعد نستفيدها', renderGrammarSection(data.grammar_focus))}
                ${createSection('4. تراكيب مفيدة', createTable(data.useful_structures, ['التركيب', 'الاستخدام'], 'structure', 'explanation'))}
                ${createSection(data.pronunciation_tips.title || '5. نصائح للنطق', renderPronunciationTips(data.pronunciation_tips))}
                ${createSection('6. تمارين', renderExercises(data.exercises))}
                <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
                    <button id="rewrite-btn" class="bg-amber-500 text-white px-6 py-2 rounded-md hover:bg-amber-600 transition">أعد كتابة القصة بنفس الكلمات</button>
                    <button id="next-lesson-btn" class="bg-sky-600 text-white px-6 py-2 rounded-md hover:bg-sky-700 transition">درس جديد بكلمات جديدة</button>
                </div>
                ${optionsHtml}
            `;
            
            const storyContainer = document.getElementById('story-container');
            const paraBtn = document.createElement('button');
            paraBtn.className = 'ml-2 px-2 py-1 text-sm bg-amber-100 rounded border dark:bg-amber-900 dark:border-amber-700 dark:text-amber-200';
            paraBtn.textContent = 'ترجمة الفقرة';
            paraBtn.onclick = async () => {
                const s = storyContainer.textContent.trim();
                const tr = await getTranslation(s, false);
                if (tr) showModal(`<div class="font-english">${s}</div><hr class="my-2"><div class="text-xl">${tr}</div>`,'ترجمة الفقرة');
            };
            storyContainer.parentElement.insertBefore(paraBtn, storyContainer);

            addSentenceTranslateButtons(storyContainer);
            renderStoryAudioPlayer(storyContainer.textContent.trim(), data.story_mood || 'neutral', data.story_type); 

            document.getElementById('rewrite-btn').addEventListener('click', () => {
                const wordCount = document.getElementById('word-count-lesson').value;
                const customInstructions = document.getElementById('custom-prompt-lesson').value;
                const newW = []; 
                const repW = (data.learnedWords || []).map(w => ({ word: w }));
                generateLesson(newW, repW, true, isRevision, wordCount, customInstructions);
            });
            document.getElementById('next-lesson-btn').addEventListener('click', () => {
                const wordCount = document.getElementById('word-count-lesson').value;
                const customInstructions = document.getElementById('custom-prompt-lesson').value;
                const { newWords, repetitionWords } = selectWordsForLesson();
                if (newWords.length > 0 || repetitionWords.length > 0) {
                    generateLesson(newWords, repetitionWords, false, false, wordCount, customInstructions);
                }
            });
            if(document.getElementById('check-answers-btn')) {
                document.getElementById('check-answers-btn').addEventListener('click', checkAnswers);
            }
            setTimeout(saveUiState, 0);
        }

        function renderStoryAudioPlayer(storyText, mood, storyType) { 
            const playerContainer = document.getElementById('story-audio-player');
            if (!playerContainer) return;

            playerContainer.innerHTML = `
                <div class="flex items-center gap-3">
                    <button id="play-story-btn" class="flex-shrink-0 p-3 bg-sky-600 text-white rounded-full hover:bg-sky-700 transition disabled:bg-slate-400">
                        <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        <div id="play-loader" class="hidden w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    </button>
                    <button id="refresh-story-audio-btn" class="flex-shrink-0 p-3 bg-slate-500 text-white rounded-full hover:bg-slate-600 transition disabled:bg-slate-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                    </button>
                    <audio id="full-story-audio" class="w-full" controls></audio>
                </div>
                 <div class="mt-2">
                    <input type="text" id="audio-custom-prompt" class="w-full p-2 border rounded-md text-sm dark:bg-slate-700 dark:border-slate-600" placeholder="اكتب تعليمات للقارئ (مثال: اقرأ بصوت هادئ)...">
                </div>
            `;
            
            const audioEl = document.getElementById('full-story-audio');
            const playBtn = document.getElementById('play-story-btn');
            const refreshBtn = document.getElementById('refresh-story-audio-btn');
            const playIcon = document.getElementById('play-icon');
            const playLoader = document.getElementById('play-loader');
            
            audioEl.style.display = 'none';

            const generateAndPlayAudio = async () => {
                playIcon.classList.add('hidden');
                playLoader.classList.remove('hidden');
                playBtn.disabled = true;
                refreshBtn.disabled = true;

                const customPrompt = document.getElementById('audio-custom-prompt').value;
                let audioUrl;
                if (storyType === 'dialogue') {
                    const fullHtml = document.getElementById('story-container').innerHTML;
                    await speakDialogue(fullHtml);
                    audioUrl = null; // Dialogue handles its own playback
                } else {
                    audioUrl = await speakText(storyText, mood, true, customPrompt);
                }
                
                playIcon.classList.remove('hidden');
                playLoader.classList.add('hidden');
                playBtn.disabled = false;
                refreshBtn.disabled = false;
                
                if (audioUrl) {
                    audioEl.src = audioUrl;
                    audioEl.style.display = 'block';
                    audioEl.play();
                    playBtn.style.display = 'none';
                    refreshBtn.style.display = 'flex';
                }
            };

            playBtn.addEventListener('click', async () => {
                if (audioEl.src) {
                    audioEl.play();
                } else {
                    await generateAndPlayAudio();
                }
            });

            refreshBtn.addEventListener('click', async () => {
                await generateAndPlayAudio();
            });

            audioEl.addEventListener('play', () => {
                playBtn.style.display = 'none';
                refreshBtn.style.display = 'flex';
            });
             audioEl.addEventListener('pause', () => {
                playBtn.style.display = 'flex';
                refreshBtn.style.display = 'flex';
            });
        }
        
        function renderGrammarSection(grammar) {
            if (!grammar) return '<p>لا توجد ملاحظات نحوية لهذا الدرس.</p>';
            let html = `
                <h4 class="font-bold text-lg mb-2">${grammar.title}</h4>
                <p class="text-slate-600/90 mb-4 dark:text-slate-300">${grammar.explanation}</p>
            `;
            if (grammar.examples && grammar.examples.length > 0) {
                html += createTable(grammar.examples, ['المثال', 'الترجمة'], 'example', 'translation');
            }
            return html;
        }

        function renderPronunciationTips(pronunciation) {
            if (!pronunciation || !pronunciation.tips || pronunciation.tips.length === 0) return '<p>لا توجد نصائح نطق لهذا الدرس.</p>';
            return createTable(pronunciation.tips, ['الكلمة/الحرف', 'النصيحة'], 'context', 'tip');
        }

        function formatStory(story, type) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = story;
            if (type !== 'dialogue') return tempDiv.innerHTML;
            
            const speakers = [];
            const lines = tempDiv.innerHTML.split(/\n|<br>|<br\/>/g);
            return lines.map(line => {
                if (!line.trim()) return '';
                const match = line.match(/^(.*?):/);
                if (match) {
                    let speaker = match[1].replace(/<[^>]*>?/gm, '').trim();
                    let speakerClass = 'dialogue-speaker-1';
                    if (!speakers.includes(speaker)) speakers.push(speaker);
                    if (speakers.indexOf(speaker) % 2 !== 0) speakerClass = 'dialogue-speaker-2';
                    
                    const restOfLine = line.substring(match[0].length);
                    return `<div class="dialogue-line"><span class="${speakerClass}">${speaker}:</span>${restOfLine}</div>`;
                }
                return `<div class="dialogue-line">${line}</div>`;
            }).join('');
        }

        function createTable(data, headers, key1, key2) {
            let tableHTML = '<div class="overflow-x-auto"><table class="table-style dark:text-slate-200">';
            tableHTML += `<thead><tr><th class="dark:bg-slate-700 dark:border-slate-600">${headers[0]}</th><th class="dark:bg-slate-700 dark:border-slate-600">${headers[1]}</th></tr></thead>`;
            tableHTML += '<tbody>';
            data.forEach(item => {
                tableHTML += `<tr class="dark:border-slate-600"><td class="dark:border-slate-600">${item[key1]}</td><td class="dark:border-slate-600">${item[key2]}</td></tr>`;
            });
            tableHTML += '</tbody></table></div>';
            return tableHTML;
        }

        function renderExercises(exercises) {
            if (!exercises || !Array.isArray(exercises)) {
                return '<p>لا توجد تمارين لهذا الدرس.</p>';
            }
            let html = '<div class="space-y-4">';
            exercises.forEach((ex, index) => {
                const cleanQuestion = ex.question ? ex.question.replace(/\*\*/g, '') : 'سؤال غير متوفر';
                html += `<div class="exercise p-3 border-r-4 border-slate-200 dark:border-slate-600" data-answer="${ex.answer}">`;
                if (ex.type === 'fill_in_the_blank') {
                    html += `<p class="font-english" dir="ltr">${index + 1}. ${cleanQuestion.replace('___', '<input type="text" class="exercise-input border-b-2 bg-transparent text-center w-24 mx-1 dark:border-slate-500">')}</p>`;
                } else if (ex.type === 'multiple_choice') {
                    html += `<p class="font-english" dir="ltr">${index + 1}. ${cleanQuestion}</p>
                             <div class="flex flex-wrap gap-2 mt-2" dir="ltr">
                                ${(ex.options && Array.isArray(ex.options)) ? ex.options.map(opt => `<label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer dark:border-slate-600"><input type="radio" name="ex${index}" value="${opt}" class="exercise-input"> ${opt}</label>`).join('') : '<p class="text-red-500">خطأ: لم يتم توفير الخيارات لهذا السؤال.</p>'}
                             </div>`;
                } else if (ex.type === 'true_false') {
                     html += `<p class="font-english" dir="ltr">${index + 1}. ${cleanQuestion}</p>
                              <div class="flex gap-4 mt-2" dir="ltr">
                                 <label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer dark:border-slate-600"><input type="radio" name="ex${index}" value="true" class="exercise-input">True</label>
                                 <label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer dark:border-slate-600"><input type="radio" name="ex${index}" value="false" class="exercise-input">False</label>
                              </div>`;
                }
                html += '</div>';
            });
            html += '</div><button id="check-answers-btn" class="mt-6 bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">تحقق من الإجابات</button>';
            html += '<div id="results-container" class="mt-4"></div>';
            return html;
        }

        function checkAnswers() {
            const exercises = document.querySelectorAll('.exercise');
            let correctCount = 0;
            exercises.forEach(ex => {
                const correctAnswer = ex.dataset.answer ? ex.dataset.answer.toLowerCase() : '';
                const inputs = ex.querySelectorAll('.exercise-input');
                let userAnswer = '';
                ex.classList.remove('border-green-400', 'border-red-400', 'dark:border-green-400', 'dark:border-red-400');

                if (inputs.length > 0 && inputs[0].type === 'text') {
                    userAnswer = inputs[0].value.trim().toLowerCase();
                    if (userAnswer === correctAnswer) {
                        ex.classList.add('border-green-400', 'dark:border-green-400'); correctCount++;
                    } else { ex.classList.add('border-red-400', 'dark:border-red-400'); }
                } else {
                    let answered = false;
                    inputs.forEach(input => {
                        if (input.checked) {
                            answered = true;
                            userAnswer = input.value.toLowerCase();
                            if (userAnswer === correctAnswer) {
                                ex.classList.add('border-green-400', 'dark:border-green-400'); correctCount++;
                            } else { ex.classList.add('border-red-400', 'dark:border-red-400'); }
                        }
                    });
                    if (!answered) ex.classList.add('border-red-400', 'dark:border-red-400');
                }
            });
            document.getElementById('results-container').innerHTML = `<p class="font-bold">نتيجتك: ${correctCount} من ${exercises.length} إجابات صحيحة.</p>`;
        }

        function handleNewLesson() {
            const wordCount = document.getElementById('word-count-home').value;
            const customInstructions = document.getElementById('custom-prompt-home').value;
            const { newWords, repetitionWords } = selectWordsForLesson();

            if (newWords.length > 0 || repetitionWords.length > 0) {
                generateLesson(newWords, repetitionWords, false, false, wordCount, customInstructions);
            } else {
                isLessonActive = false;
                showScreen(allDOMElements.homeScreen);
            }
            setTimeout(saveUiState, 0);
        }

        function selectRevisionSet(target=20) {
            const { b2, b1, b0 } = getReviewBuckets();
            const pick = (arr, n) => arr.sort(()=>0.5-Math.random()).slice(0,n);
            const out = [];
            out.push(...pick(b1, Math.min(8, target - out.length)));
            out.push(...pick(b2, Math.min(6, target - out.length)));
            out.push(...pick(b0, Math.max(0, target - out.length)));
            return out.map(x => x.word);
        }

        function handleRevisionLesson() {
            const wordCount = document.getElementById('word-count-review').value;
            const customInstructions = document.getElementById('custom-prompt-review').value;
            const wordsForRevision = selectRevisionSet(20);
            if (wordsForRevision.length) {
                const repObjs = wordsForRevision.map(w => ({ word: w }));
                generateLesson([], repObjs, false, true, wordCount, customInstructions);
                showScreen(allDOMElements.lessonScreen);
            }
            setTimeout(saveUiState, 0);
        }

        function renderHistory() {
            if (lessonHistory.length === 0) {
                allDOMElements.historyList.innerHTML = '<p class="text-center text-slate-500">لا توجد دروس محفوظة بعد.</p>';
                return;
            }
            allDOMElements.historyList.innerHTML = lessonHistory.map((lesson, index) => `
                <div class="p-3 border rounded-md hover:bg-slate-100 dark:border-slate-700 dark:hover:bg-slate-700 cursor-pointer" onclick="viewHistoryItem(${index})">
                    <p class="font-bold">درس بتاريخ: ${lesson.date}</p>
                    <p class="text-sm text-slate-600 font-english dark:text-slate-400" dir="ltr">${(lesson.learnedWords || []).slice(0, 5).join(', ')}...</p>
                </div>
            `).join('');
        }

        function viewHistoryItem(index) {
            const lessonData = lessonHistory[index];
            renderLesson(lessonData, false);
            isLessonActive = true;
            showScreen(allDOMElements.lessonScreen);
        }

        function handleInteractionEnd(event) {
            setTimeout(() => {
                const selection = window.getSelection();
                const selectedText = selection.toString().trim();

                if (isDragging && selectedText.length > 0) {
                    if (event.type === 'touchend') event.preventDefault();
                    showSelectionPopup(selection);
                }
                else if (!isDragging && event.target.closest('.word-span, b, i')) {
                    const target = event.target.closest('.word-span, b, i');
                    const text = target.textContent.trim().replace(/[.,!?;:]/g, '');
                    if (text) {
                        showWordTranslationModal(text);
                    }
                }
                isDragging = false;
            }, 10);
        }

        function showSelectionPopup(selection) {
            const selectedText = selection.toString().trim();
            if (!selectedText) return;

            const rect = selection.getRangeAt(0).getBoundingClientRect();
            const popup = allDOMElements.selectionPopup;
            popup.classList.remove('hidden');

            const vw = window.innerWidth;
            const pad = 8, w = popup.offsetWidth || 140, h = popup.offsetHeight || 40;
            let left = rect.left + rect.width/2 - w/2;
            let top  = rect.top - h - 10;
            if (left < pad) left = pad;
            if (left + w > vw - pad) left = vw - w - pad;
            if (top < pad) top = rect.bottom + 10;
            popup.style.position = 'fixed';
            popup.style.left = `${left}px`;
            popup.style.top  = `${top}px`;

            const mood = document.getElementById('story-container')?.dataset.mood || 'neutral';

            popup.querySelector('#popup-translate').onclick = () => { getTranslation(selectedText); popup.classList.add('hidden'); };
            popup.querySelector('#popup-speak').onclick = () => { speakText(selectedText, mood); };
            popup.querySelector('#popup-phonetics').onclick = async () => {
                const ph = await getPhonetics(selectedText);
                if (ph) showModal(`<p class="text-xl font-bold text-sky-600">${ph}</p>`, `النطق التقريبي`);
                popup.classList.add('hidden');
            };
            popup.querySelector('#popup-save').onclick = () => { saveToBasket(selectedText); popup.classList.add('hidden'); };
        }

        async function showWordTranslationModal(text) {
            const mood = document.getElementById('story-container')?.dataset.mood || 'neutral';
            const modalTitle = `<span class="font-english text-3xl">${text}</span>`;
            
            showModal('<div class="flex justify-center"><div class="loader"></div></div>', modalTitle, []);

            const translation = await getTranslation(text, false);

            if (!translation) {
                showModal('<p>لم نتمكن من العثور على ترجمة.</p>', modalTitle);
                return;
            }

            const modalContent = `<p class="text-2xl font-bold text-sky-600">${translation}</p>`;
            
            const actions = [
                {
                    text: '🔊 نطق',
                    class: 'action-speak-btn bg-green-500 text-white',
                    callback: () => speakText(text, mood),
                    keepOpen: true
                },
                {
                    text: '🗣️ كتابة صوتية',
                    class: 'action-phonetics-btn bg-purple-500 text-white',
                    callback: async () => {
                        const phonetics = await getPhonetics(text);
                        if (phonetics) {
                            showModal(`<p class="text-xl font-bold text-sky-600">${phonetics}</p>`, `النطق التقريبي لـ: <span class="font-english text-xl">${text}</span>`);
                        }
                    }
                },
                {
                    text: '💾 حفظ للمراجعة',
                    class: 'action-save-btn bg-amber-500 text-white',
                    callback: () => saveToBasket(text, translation)
                }
            ];
            showModal(modalContent, modalTitle, actions);
        }
        
        async function getTranslation(text, showModalWithSaveButton = true) {
            const prompt = `Translate the English text "${text}" into a simple, direct Arabic equivalent. Provide only the translation, nothing else.`;
            const translation = await callGeminiForSimpleText(prompt);
            if (translation && showModalWithSaveButton) {
                const actions = [{
                    text: '💾 حفظ للمراجعة',
                    class: 'save-to-basket-btn bg-green-500 text-white hover:bg-green-600',
                    callback: () => saveToBasket(text, translation)
                }];
                showModal(`<p class="text-xl font-bold text-sky-600">${translation}</p>`, `ترجمة: <span class="font-english">${text}</span>`, actions);
            }
            return translation;
        }

        async function getPhonetics(text) {
            const prompt = `اكتب النطق التقريبي لهذه الكلمة أو الجملة الإنجليزية باستخدام حروف عربية مبسطة. فقط أعط النطق ولا شيء آخر. النص هو: "${text}"`;
            return await callGeminiForSimpleText(prompt);
        }
        
        async function callGeminiForSimpleText(prompt) {
            if (!apiKey) { showModal('الرجاء حفظ مفتاح Gemini API أولاً.'); return null; }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error('API Error');
                const result = await response.json();
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                console.error('Error with simple text generation:', error);
                showModal('حدث خطأ أثناء التواصل مع الذكاء الاصطناعي.');
                return null;
            }
        }

        async function saveToBasket(englishText, arabicText) {
            let translation = arabicText;
            if (!translation) {
                translation = await getTranslation(englishText, false);
            }
            if (!translation) {
                showModal('لم نتمكن من العثور على ترجمة للحفظ.');
                return;
            }

            const isAlreadySaved = learningBasket.some(item => item.en.toLowerCase() === englishText.toLowerCase());
            if (isAlreadySaved) {
                showModal(`"${englishText}" <br><br> موجودة بالفعل في سلة المراجعة.`);
                return;
            }
            
            learningBasket.unshift({ id: Date.now(), en: englishText, ar: translation });
            saveState();
            showModal(`"${englishText}" <br><br> تم حفظها بنجاح في سلة المراجعة!`);
        }
        
        function getReviewBuckets() {
            const b0=[], b1=[], b2=[];
            for (const it of wordsInProgress) {
                const c = it.reviewCount || 0;
                if (c === 0) b0.push(it);
                else if (c < 3) b1.push(it);
                else b2.push(it);
            }
            return { b0, b1, b2 };
        }

        function renderInProgressWords() {
            const container = allDOMElements.inProgressScreen;
            
            const { b0, b1, b2 } = getReviewBuckets();
            const bucketsHtml = `
            <div class="grid md:grid-cols-3 gap-3 text-center mb-6">
                <div class="p-3 border rounded-md dark:border-slate-700"><div class="text-slate-500 text-sm dark:text-slate-400">لم تُراجع</div><div class="text-2xl font-bold">${b0.length}</div></div>
                <div class="p-3 border rounded-md dark:border-slate-700"><div class="text-slate-500 text-sm dark:text-slate-400">راجعتها 1-2 مرة</div><div class="text-2xl font-bold">${b1.length}</div></div>
                <div class="p-3 border rounded-md dark:border-slate-700"><div class="text-slate-500 text-sm dark:text-slate-400">راجعتها 3+ مرات</div><div class="text-2xl font-bold">${b2.length}</div></div>
            </div>
            `;
            
            const optionsHtml = `
                <div class="max-w-md mx-auto space-y-4 mb-6 text-right p-4 border rounded-md bg-slate-50 dark:bg-slate-800 dark:border-slate-700">
                    <h3 class="text-lg font-bold text-center">خيارات المراجعة</h3>
                    <div>
                        <label for="word-count-review" class="block text-sm font-medium text-slate-700 dark:text-slate-200">إجمالي كلمات القصة (تقريبيًا 50-500)</label>
                        <input type="number" id="word-count-review" value="100" min="50" max="500" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm dark:bg-slate-700 dark:border-slate-600">
                    </div>
                    <div>
                        <label for="custom-prompt-review" class="block text-sm font-medium text-slate-700 dark:text-slate-200">اكتب تعليمات للقصة (اختياري)</label>
                        <textarea id="custom-prompt-review" rows="2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm dark:bg-slate-700 dark:border-slate-600" placeholder="مثال: حوار قصير بين شخصين في مطعم..."></textarea>
                    </div>
                </div>
            `;

            const buttonHtml = wordsInProgress.length > 0
                ? `<div class="text-center mb-6"><button id="review-lesson-btn" class="bg-sky-600 text-white px-6 py-2 rounded-md hover:bg-sky-700 transition">مراجعة بقصة جديدة</button></div>`
                : `<p class="text-center text-slate-500 mb-6">لا توجد كلمات للمراجعة بعد.</p>`;

            const wordsHtml = wordsInProgress.length === 0 
                ? '<p class="text-center text-slate-500">لا توجد كلمات قيد التعلم حالياً.</p>'
                : `<div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    ${[...wordsInProgress].sort((a,b) => a.word.localeCompare(b.word)).map(item => `
                        <div class="p-3 border rounded-md text-center cursor-pointer hover:bg-sky-100 dark:border-slate-700 dark:hover:bg-slate-700 flex flex-col justify-between" onclick="handleInProgressWordClick('${item.word}')">
                            <span class="font-english font-bold">${item.word}</span>
                            <span class="text-xs text-slate-500 mt-1">المستوى ${item.level} • المراجعات ${item.reviewCount||0}</span>
                        </div>
                    `).join('')}
                   </div>`;
            
            const masteredHtml = masteredWords.length
                ? `<div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-6">${masteredWords.sort().map(w=>`
                    <div class="p-3 border rounded-md text-center bg-green-50 dark:bg-green-900/50 dark:border-green-800"><span class="font-english font-bold">${w}</span></div>`).join('')}
                    </div>`
                : '<p class="text-center text-slate-500 mt-4">لا توجد كلمات متقنة بعد.</p>';

            container.innerHTML = createSection('إحصاءات المراجعة', bucketsHtml) + 
                                createSection('كلمات قيد التعلم', optionsHtml + buttonHtml + wordsHtml) +
                                createSection('الكلمات المتقنة', masteredHtml);

            if (wordsInProgress.length > 0) {
                document.getElementById('review-lesson-btn').addEventListener('click', handleRevisionLesson);
            }
        }
        
        async function handleInProgressWordClick(word) {
            const actions = [
                {
                    text: '✅ أتقنتها',
                    class: 'master-word-btn bg-green-500 text-white hover:bg-green-600',
                    callback: () => masterWord(word)
                },
                 {
                    text: '💾 إضافة للمراجعة',
                    class: 'add-to-basket-btn bg-amber-500 text-white hover:bg-amber-600',
                    callback: async () => {
                        const translation = await getTranslation(word, false);
                        if (translation) saveToBasket(word, translation);
                    }
                }
            ];
            showModal(`ماذا تريد أن تفعل بالكلمة؟`, `<span class="font-english text-3xl">${word}</span>`, actions);
        }

        function masterWord(wordToMaster) {
            const wordIndex = wordsInProgress.findIndex(item => item.word === wordToMaster);
            if (wordIndex > -1) {
                masteredWords.push(wordsInProgress[wordIndex].word);
                wordsInProgress.splice(wordIndex, 1);
                saveState();
                updateProgress();
                renderInProgressWords(); // Re-render the list
                showModal(`تم نقل "${wordToMaster}" إلى قائمة الكلمات المتقنة.`, 'تم بنجاح');
            }
        }
        
        function getCurrentBasketBatch() {
            const start = reviewBatchIndex * REVIEW_BATCH_SIZE;
            return learningBasket.slice(start, start + REVIEW_BATCH_SIZE);
        }

        function renderBasket() {
            const basketContainer = allDOMElements.basketScreen;
            if (learningBasket.length === 0) {
                basketContainer.innerHTML = createSection('سلة المراجعة', '<p class="text-center text-slate-500">سلّتك فارغة. ابدأ بحفظ الكلمات والجمل لمراجعتها هنا.</p>');
                return;
            }

            const batch = getCurrentBasketBatch();

            const flashcardsHtml = `
                <div class="flashcard-container">
                    ${batch.map(item => `
                        <div class="flashcard" onclick="this.classList.toggle('is-flipped')">
                            <div class="flashcard-inner">
                                <div class="flashcard-front font-english">${item.en}</div>
                                <div class="flashcard-back">${item.ar}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            const pager = `
            <div class="flex justify-center items-center gap-3 mt-4">
                <button id="b-prev" class="px-3 py-1 border rounded ${reviewBatchIndex===0?'opacity-50 pointer-events-none':''}">السابق</button>
                <div>المجموعة ${reviewBatchIndex+1} / ${Math.max(1, Math.ceil(learningBasket.length / REVIEW_BATCH_SIZE))}</div>
                <button id="b-next" class="px-3 py-1 border rounded ${((reviewBatchIndex+1)*REVIEW_BATCH_SIZE>=learningBasket.length)?'opacity-50 pointer-events-none':''}">التالي</button>
            </div>
            `;

            basketContainer.innerHTML = `
                ${createSection('1. بطاقات تعليمية (Flashcards)', '<p class="mb-4 text-sm text-slate-500">اضغط على البطاقة لقلبها.</p>' + flashcardsHtml + pager)}
                ${createSection('2. تمرين التوصيل', '<p class="mb-4 text-sm text-slate-500">صلِّ الكلمة بترجمتها.</p>' + renderMatchingExercise(batch))}
                ${createSection('3. اختبار اختياري سريع', renderMCQFromBasket(batch))}
                ${createSection('4. لعبة الذاكرة', renderMemoryPairs(batch))}
            `;
            
            document.getElementById('b-prev')?.addEventListener('click', ()=>{ reviewBatchIndex=Math.max(0, reviewBatchIndex-1); renderBasket(); });
            document.getElementById('b-next')?.addEventListener('click', ()=>{ const max = Math.ceil(learningBasket.length/REVIEW_BATCH_SIZE)-1; reviewBatchIndex=Math.min(max, reviewBatchIndex+1); renderBasket(); });

            setupMatchingExerciseListeners();
        }

        function renderMCQFromBasket(source, qCount=8) {
            const pool = [...source];
            if (pool.length < 3) return '<p class="text-slate-500">أضف كلمات أكثر لتوليد اختبار.</p>';
            const qs = [];
            for (let i=0; i<Math.min(qCount, pool.length); i++) {
                const correct = pool[i];
                const others = learningBasket.filter(x=>x.id!==correct.id).sort(()=>0.5-Math.random()).slice(0,2);
                const opts = [correct, ...others].sort(()=>0.5-Math.random());
                qs.push({q: correct.en, a: correct.ar, opts: opts.map(o=>o.ar)});
            }
            let html = qs.map((q,idx)=>`
                <div class="p-3 border rounded-md mb-2 dark:border-slate-700" data-a="${q.a}">
                <p class="font-english mb-2">${idx+1}. ${q.q}</p>
                ${q.opts.map(o=>`<label class="block"><input class="exercise-input mr-2" type="radio" name="mcq${idx}" value="${o}">${o}</label>`).join('')}
                </div>
            `).join('');
            html += `<button id="check-mcq" class="mt-2 bg-sky-600 text-white px-4 py-2 rounded">تحقق</button>
                    <div id="mcq-res" class="mt-2 font-bold"></div>`;
            setTimeout(()=>{
                document.getElementById('check-mcq').onclick=()=>{
                let ok=0, n=qs.length;
                document.querySelectorAll('#basket-screen [data-a]').forEach(box=>{
                    const a = box.dataset.a;
                    const v = box.querySelector('input:checked')?.value;
                    box.classList.remove('border-green-400','border-red-400','dark:border-green-400','dark:border-red-400');
                    if (v===a){ ok++; box.classList.add('border-green-400','dark:border-green-400'); }
                    else { box.classList.add('border-red-400','dark:border-red-400'); }
                });
                document.getElementById('mcq-res').textContent = `نتيجتك: ${ok} / ${n}`;
                };
            },0);
            return html;
        }

        function renderMemoryPairs(source) {
            const pool = [...source].slice(0,8);
            if (pool.length<4) return '<p class="text-slate-500">تحتاج 4 عناصر على الأقل.</p>';
            const cards = [];
            pool.forEach(it=>{
                cards.push({id: it.id, t: it.en, isEn:true});
                cards.push({id: it.id, t: it.ar, isEn:false});
            });
            cards.sort(()=>0.5-Math.random());
            let html = `<div id="mem-grid" class="grid grid-cols-4 gap-2">` +
                cards.map((c,i)=>`<button class="p-3 border rounded bg-white dark:bg-slate-700 dark:border-slate-600" data-id="${c.id}" data-i="${i}">${c.t}</button>`).join('') +
                `</div><div id="mem-msg" class="mt-2 font-bold"></div>`;
            setTimeout(()=>{
                let first=null, done=0;
                document.querySelectorAll('#mem-grid button').forEach(btn=>{
                btn.onclick=()=>{
                    if (btn.classList.contains('opacity-40')) return;
                    if (!first) { first = btn; btn.classList.add('ring-2','ring-sky-500'); return; }
                    const match = first.dataset.id === btn.dataset.id && first!==btn;
                    if (match) {
                    first.classList.add('opacity-40'); btn.classList.add('opacity-40');
                    done += 2; document.getElementById('mem-msg').textContent = 'رائع!';
                    } else {
                    first.classList.remove('ring-2','ring-sky-500');
                    document.getElementById('mem-msg').textContent = 'جرب مرة أخرى';
                    }
                    first = null;
                    if (done === cards.length) document.getElementById('mem-msg').textContent = 'اكتملت اللعبة!';
                };
                });
            },0);
            return html;
        }
        
        function renderMatchingExercise(source) {
            const shuffledEn = [...source].sort(() => 0.5 - Math.random());
            const shuffledAr = [...source].sort(() => 0.5 - Math.random());

            const enHtml = shuffledEn.map(item => 
                `<div class="match-item font-english dark:border-slate-600" data-id="${item.id}">${item.en}</div>`
            ).join('');
            const arHtml = shuffledAr.map(item => 
                `<div class="match-item dark:border-slate-600" data-id="${item.id}">${item.ar}</div>`
            ).join('');

            return `
                <div class="matching-container">
                    <div class="matching-column">${enHtml}</div>
                    <div class="matching-column">${arHtml}</div>
                </div>
                <p id="match-result" class="text-center font-bold mt-4"></p>
            `;
        }

        function setupMatchingExerciseListeners() {
            let selectedEn = null;
            let selectedAr = null;
            const items = document.querySelectorAll('.match-item');

            items.forEach(item => {
                item.addEventListener('click', () => {
                    const isEnglish = item.classList.contains('font-english');
                    
                    if (isEnglish) {
                        if (selectedEn) selectedEn.classList.remove('selected');
                        selectedEn = item;
                        item.classList.add('selected');
                    } else {
                        if (selectedAr) selectedAr.classList.remove('selected');
                        selectedAr = item;
                        item.classList.add('selected');
                    }

                    if (selectedEn && selectedAr) {
                        if (selectedEn.dataset.id === selectedAr.dataset.id) {
                            selectedEn.classList.add('correct');
                            selectedAr.classList.add('correct');
                            document.getElementById('match-result').textContent = 'صحيح!';
                            document.getElementById('match-result').style.color = 'green';
                        } else {
                            selectedEn.classList.add('incorrect');
                            selectedAr.classList.add('incorrect');
                            document.getElementById('match-result').textContent = 'حاول مرة أخرى!';
                             document.getElementById('match-result').style.color = 'red';
                            setTimeout(() => {
                                selectedEn.classList.remove('incorrect');
                                selectedAr.classList.remove('incorrect');
                            }, 1000);
                        }
                        if (selectedEn) selectedEn.classList.remove('selected');
                        if (selectedAr) selectedAr.classList.remove('selected');
                        selectedEn = null;
                        selectedAr = null;
                    }
                });
            });
        }
        
        async function synthOne(text, voiceName) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`,{
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    model:"gemini-2.5-flash-preview-tts",
                    contents:[{parts:[{text: `Speak ONLY the content between [[TEXT]] and [[/TEXT]].\n[[TEXT]]\n${text}\n[[/TEXT]]`}]}],
                    generationConfig:{responseModalities:["AUDIO"],speechConfig:{voiceConfig:{prebuiltVoiceConfig:{voiceName}}}}
                })
                });
                const result = await response.json();
                const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (!audioData) return null;
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, 24000);
                return URL.createObjectURL(wavBlob);
            } catch { return null; }
        }

        async function speakDialogue(fullHtml) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = fullHtml;
            const lines = Array.from(tempDiv.querySelectorAll('.dialogue-line')).map(el => el.textContent.trim());
            const voices = ['Zephyr','Kore','Puck','Umbriel','Leda','Gacrux'];
            let vIdx = 0;

            for (const line of lines) {
                const m = line.match(/^\s*([^:]+):\s*(.*)$/);
                const seg = m ? m[2] : line;
                if (!seg) continue;
                const url = await synthOne(seg, voices[vIdx++ % voices.length]);
                if (url) { await new Promise(r => { const a = new Audio(url); a.onended = r; a.play(); }); }
            }
            return null;
        }

        async function speakText(text, mood = 'neutral', returnUrlOnly = false, customPrompt = '') {
            if (!apiKey || !audioContext) {
                showModal('ميزة الصوت غير متاحة. يرجى التحقق من مفتاح API أو دعم المتصفح.');
                return null;
            }
            const cleanText = text.replace(/<[^>]*>?/gm, '');
            
            const guide = customPrompt ? `STYLE: ${customPrompt}` : (mood && mood !=='neutral' ? `STYLE: ${mood}` : '');
            const ttsPrompt =
            `${guide ? guide+'\n' : ''}Speak ONLY the content between [[TEXT]] and [[/TEXT]]. Do NOT speak the word TEXT or the instructions.\n[[TEXT]]\n${cleanText}\n[[/TEXT]]`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "gemini-2.5-flash-preview-tts",
                        contents: [{ parts: [{ text: ttsPrompt }] }],
                        generationConfig: { 
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: ttsVoices[Math.floor(Math.random() * ttsVoices.length)] }
                                }
                            }
                        },
                    })
                });
                if (!response.ok) throw new Error(`TTS API Error: ${response.status}`);
                const result = await response.json();
                const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (audioData) {
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, 24000);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    if (returnUrlOnly) {
                        return audioUrl;
                    } else {
                        new Audio(audioUrl).play();
                    }
                }
            } catch (error) {
                console.error('Error with TTS:', error);
                showModal('حدث خطأ أثناء تشغيل الصوت.');
            }
            return null;
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const view = new DataView(new ArrayBuffer(44 + pcmData.length * 2));
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + pcmData.length * 2, true);
            writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true);
            view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true);
            view.setUint16(34, 16, true); writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length * 2, true);
            for (let i = 0; i < pcmData.length; i++) { view.setInt16(44 + i * 2, pcmData[i], true); }
            return new Blob([view], { type: 'audio/wav' });
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function handleSaveApiKey() {
            const key = allDOMElements.apiKeyInput.value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('geminiApiKey', key);
                allDOMElements.mainContent.classList.remove('hidden');
            } else {
                showModal('الرجاء إدخال مفتاح API صحيح.');
            }
        }
        
        function handleResetProgress() {
            if (window.confirm('هل أنت متأكد أنك تريد إعادة تعيين كل تقدمك؟ سيتم حذف جميع الكلمات والدروس المحفوظة.')) {
                wordsInProgress = [];
                masteredWords = [];
                learningBasket = [];
                lessonHistory = [];
                isLessonActive = false;
                saveState();
                updateProgress();
                showTab('home');
            }
        }

        initialize();
    </script>
</body>
</html>
